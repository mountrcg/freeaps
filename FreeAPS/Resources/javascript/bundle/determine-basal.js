var freeaps_determineBasal;(()=>{var e={5546:(e,r,a)=>{var t=a(6880);function o(e,r){r||(r=0);var a=Math.pow(10,r);return Math.round(e*a)/a}function n(e,r){return"mmol/L"===r.out_units?o(.0555*e,1):Math.round(e)}var i="",s="",l="",d="",u="",m="",c="",p="",g="",b="",f=1,h=1,v=1,B=1,_=1;function M(e,r,a){"bg"==a?(polyX=[50,60,80,90,100,110,150,180,200],polyY=[-.5,-.5,-.3,-.2,0,0,.5,.7,.7]):"delta"==a&&(polyX=[2,7,12,16,20],polyY=[0,0,.4,.7,.7]);var t=polyX.length-1,o=polyX[0],n=polyY[0],i=polyX[t],s=polyY[t],l=1,d=1,u=1,m=o;if(o>e)i=polyX[1],l=(d=n)+((s=polyY[1])-d)/(i-(u=o))*(e-u);else if(i<e)o=polyX[t-1],l=(d=n=polyY[t-1])+(s-d)/(i-(u=o))*(e-u);else for(var c=0;c<=t;c++){if(o=polyX[c],n=polyY[c],o==e){l=n;break}if(o>e){l=d+(n-d)/(o-(u=m))*(e-u);break}d=n,m=o}return l*="delta"==a?r.delta_ISFrange_weight:e>100?r.higher_ISFrange_weight:r.lower_ISFrange_weight}function S(e,r,a,t,n,i,s,l,d){console.error("check ratio "+o(e,2)+" against autoISF min: "+r+" and autoISF max: "+a),e<r?(b=" (lmtd.)",p="weakest autoISF factor "+o(e,2)+" limited by autoISF_min "+r,console.error(p),e=r):e>a&&(b=" (lmtd.)",p="strongest autoISF factor "+o(e,2)+" limited by autoISF_max "+a,console.error(p),e=a);var u=1;return s&&i.temptargetSet&&l>d?(u=e*t,n="includes exercise mode impact",console.error("autoISF adjusts sens "+t+", instead of profile.sens "+i.sens)):e>=1?(u=Math.max(e,t),e>=t&&(n="")):(u=Math.min(e,t),e<=t&&(n="")),p="final ISF factor "+o(u,2)+n,console.error(p),u}e.exports=function(e,r,a,y,x,F,I,w,T,C,G,D,O,R){var U=0,A="",P="",k="",j="",E="",W=0,q=0,z=0,L=0,N=0,X=0;const Y=R.tddYtd,H=R.tdd7d;function Z(e,r){var a=e.getTime();return new Date(a+36e5*r)}function $(e){var r=y.bolus_increment;.025!=r&&(r=.05);var a=e/r;return a>=1?o(Math.floor(a)*r,5):0}function J(e){function r(e){return e<10&&(e="0"+e),e}return r(e.getHours())+":"+r(e.getMinutes())+":00"}function K(e,r){var a=new Date("1/1/1999 "+e),t=new Date("1/1/1999 "+r);return(a.getTime()-t.getTime())/36e5}function Q(e,r){var a=0,t=r,o=(e-r)/36e5,n=0,i=o,s=0;do{if(o>0){var l=J(t);O[0].rate;for(let e=0;e<O.length;e++){var d=O[e].start;if(l==d){if(e+1<O.length){o>=(s=K(O[e+1].start,O[e].start))?n=s:o<s&&(n=o)}else if(e+1==O.length){let r=O[0].start;o>=(s=24-K(O[e].start,r))?n=s:o<s&&(n=o)}a+=$(O[e].rate*n),o-=n,t=Z(t,n)}else if(l>d)if(e+1<O.length){var u=O[e+1].start;l<u&&(o>=(s=K(u,l))?n=s:o<s&&(n=o),a+=$(O[e].rate*n),o-=n,t=Z(t,n))}else if(e==O.length-1){o>=(s=K("23:59:59",l))?n=s:o<s&&(n=o),a+=$(O[e].rate*n),o-=n,t=Z(t,n)}}}}while(o>0&&o<i);return a}if(G.length){let e=G.length-1;var V=new Date(G[e].timestamp),ee=new Date(G[0].timestamp);if("TempBasalDuration"==G[0]._type&&(ee=new Date),(U=(ee-V)/36e5)<23.9&&U>21)N=Q(V,(re=24-U,ae=V.getTime(),new Date(ae-36e5*re))),j="24 hours of data is required for an accurate tdd calculation. Currently only "+U.toPrecision(3)+" hours of pump history data are available. Using your pump scheduled basals to fill in the missing hours. Scheduled basals added: "+N.toPrecision(5)+" U. ";else U<21?(dynISFenabled=!1,enableDynamicCR=!1):j=""}else console.log("Pumphistory is empty!"),dynISFenabled=!1,enableDynamicCR=!1;var re,ae;for(let e=0;e<G.length;e++)"Bolus"==G[e]._type&&(L+=G[e].amount);for(let e=1;e<G.length;e++)if("TempBasal"==G[e]._type&&G[e].rate>0){W=e,X=G[e].rate;var te=G[e-1]["duration (min)"]/60,oe=te,ne=new Date(G[e-1].timestamp),ie=ne;do{if(e--,0==e){ie=new Date;break}if("TempBasal"==G[e]._type||"PumpSuspend"==G[e]._type){ie=new Date(G[e].timestamp);break}}while(e>0);var se=(ie-ne)/36e5;se<oe&&(te=se),z+=$(X*te),e=W}for(let e=0;e<G.length;e++)if(0,0==G[e]["duration (min)"]||"PumpResume"==G[e]._type){let r=new Date(G[e].timestamp),a=r,t=e;do{if(t>0&&(--t,"TempBasal"==G[t]._type)){a=new Date(G[t].timestamp);break}}while(t>0);(a-r)/36e5>0&&(N+=Q(a,r))}for(let e=G.length-1;e>0;e--)if("TempBasalDuration"==G[e]._type){let r=G[e]["duration (min)"]/60,a=new Date(G[e].timestamp);var le=a;let t=e;do{if(--t,t>=0&&("TempBasal"==G[t]._type||"PumpSuspend"==G[t]._type)){le=new Date(G[t].timestamp);break}}while(t>0);if(0==e&&"TempBasalDuration"==G[0]._type&&(le=new Date,r=G[e]["duration (min)"]/60),(le-a)/36e5-r>0){N+=Q(le,Z(a,r))}}var de={TDD:o(q=L+z+N,5),bolus:o(L,5),temp_basal:o(z,5),scheduled_basal:o(N,5)},ue=q;U>21?(P=". Bolus insulin: "+L.toPrecision(5)+" U",k=". Temporary basal insulin: "+z.toPrecision(5)+" U",A=". Insulin with scheduled basal rate: "+N.toPrecision(5)+" U",E=j+(" TDD past 24h is: "+q.toPrecision(5)+" U")+P+k+A,tddReason=", TDD, 24h: "+o(q,1)+", ytd: "+o(Y,1)+", 7dØ: "+o(H,1),console.error(E)):tddReason=", TDD: Not enough pumpData (< 21h)";var me={},ce=new Date;if(C&&(ce=C),void 0===y||void 0===y.current_basal)return me.error="Error: could not get current basal rate",me;var pe=t(y.current_basal,y),ge=pe,be=new Date;C&&(be=C);var fe,he=new Date(e.date),ve=o((be-he)/60/1e3,1),Be=e.glucose,_e=e.noise;fe=n(e.delta,y);var Me=Math.min(e.delta,e.short_avgdelta),Se=Math.min(e.short_avgdelta,e.long_avgdelta),ye=Math.max(e.delta,e.short_avgdelta,e.long_avgdelta);(Be<=10||38===Be||_e>=3)&&(me.reason="CGM is calibrating, in ??? state, or noise is high");if(ve>12||ve<-5?me.reason="If current system time "+be+" is correct, then BG data is too old. The last BG data was read "+ve+"m ago at "+he:0===e.short_avgdelta&&0===e.long_avgdelta&&(e.last_cal&&e.last_cal<3?me.reason="CGM was just calibrated":me.reason="CGM data is unchanged ("+n(Be,y)+"+"+n(e.delta,y)+") for 5m w/ "+n(e.short_avgdelta,y)+" mg/dL ~15m change & "+n(e.long_avgdelta,y)+" mg/dL ~45m change"),Be<=10||38===Be||_e>=3||ve>12||ve<-5||0===e.short_avgdelta&&0===e.long_avgdelta)return r.rate>=ge?(me.reason+=". Canceling high temp basal of "+r.rate,me.deliverAt=ce,me.temp="absolute",me.duration=0,me.rate=0,me):0===r.rate&&r.duration>30?(me.reason+=". Shortening "+r.duration+"m long zero temp to 30m. ",me.deliverAt=ce,me.temp="absolute",me.duration=30,me.rate=0,me):(me.reason+=". Temp "+r.rate+" <= current basal "+ge+"U/hr; doing nothing. ",me);var xe,Fe,Ie,we,Te=y.max_iob;if(void 0!==y.min_bg&&(Fe=y.min_bg),void 0!==y.max_bg&&(Ie=y.max_bg),void 0!==y.enableSMB_high_bg_target&&(we=y.enableSMB_high_bg_target),void 0===y.min_bg||void 0===y.max_bg)return me.error="Error: could not determine target_bg. ",me;xe=(y.min_bg+y.max_bg)/2;var Ce="",Ge=y.exercise_mode||y.high_temptarget_raises_sensitivity,De=100,Oe=160;if(y.half_basal_exercise_target&&(Oe=y.half_basal_exercise_target),Ge&&y.temptargetSet&&xe>De||y.low_temptarget_lowers_sensitivity&&y.temptargetSet&&xe<De){var Re=Oe-De;sensitivityRatio=Re*(Re+xe-De)<=0?y.autosens_max:Re/(Re+xe-De),sensitivityRatio=Math.min(sensitivityRatio,y.autosens_max),sensitivityRatio=o(sensitivityRatio,2),Ce="from TT modifier",process.stderr.write("Sensitivity ratio set to "+sensitivityRatio+" based on temp target of "+xe+"; ")}else void 0!==x&&x&&(sensitivityRatio=x.ratio,Ce="from Autosens",process.stderr.write("Autosens ratio: "+sensitivityRatio+"; "));if(sensitivityRatio&&(ge=y.current_basal*sensitivityRatio,(ge=t(ge,y))!==pe?process.stderr.write("Adjusting basal from "+pe+" to "+ge+"; "):process.stderr.write("Basal unchanged: "+ge+"; ")),y.temptargetSet);else if(void 0!==x&&x&&(y.sensitivity_raises_target&&x.ratio<1||y.resistance_lowers_target&&x.ratio>1)){Fe=o((Fe-60)/x.ratio)+60,Ie=o((Ie-60)/x.ratio)+60;var Ue=o((xe-60)/x.ratio)+60;xe===(Ue=Math.max(80,Ue))?process.stderr.write("target_bg unchanged: "+Ue+"; "):process.stderr.write("target_bg from "+xe+" to "+Ue+"; "),xe=Ue}var Ae=200,Pe=200,ke=200;if(e.noise>=2){var je=Math.max(1.1,y.noisyCGMTargetMultiplier);Math.min(250,y.maxRaw);Ae=o(Math.min(200,Fe*je)),Pe=o(Math.min(200,xe*je)),ke=o(Math.min(200,Ie*je)),process.stderr.write("Raising target_bg for noisy / raw CGM data, from "+xe+" to "+Pe+"; "),Fe=Ae,xe=Pe,Ie=ke}var Ee=Fe-.5*(Fe-40),We=o(y.sens,1),qe=y.sens;void 0!==x&&x&&((qe=o(qe=y.sens/sensitivityRatio,1))!==We?process.stderr.write("ISF from "+n(We,y)+" to "+n(qe,y)):process.stderr.write("ISF unchanged: "+n(qe,y))),console.error("CR:"+y.carb_ratio),console.error("----------------------------------"),console.error(" start autoISF"),console.error("----------------------------------");var ze=function(e,r){if(e.use_autoisf&&e.iob_threshold>0&&e.iob_threshold<r[0].iob)return s=", autoISF-SMB disabled:, IOB: "+o(r[0].iob,2)+", > threshold: "+e.iob_threshold+", maxIOB: "+e.max_iob,console.error(s),"iobTH";var a=n(e.min_bg,e);return e.use_autoisf&&e.temptargetSet&&e.enableSMB_EvenOn_OddOff||e.use_autoisf&&e.min_bg==e.max_bg&&e.enableSMB_EvenOn_OddOff_always?(e.temptargetSet?msgType="TempTarget ":msgType="profile target ","mmol/L"==e.out_units?(evenTarget=o(10*a,0)%2==0,msgUnits=" has ",msgTail=" decimal"):(evenTarget=a%2==0,msgUnits=" is ",msgTail=" number"),evenTarget?msgEven="even":msgEven="odd",evenTarget?(console.error("SMB enabled - "+msgType+a+msgUnits+msgEven+msgTail),e.temptargetSet&&a<100?(console.error("Full Loop enabled, SMB enforced"),s=", autoISF-SMB enabled:, even TT","enforced"):(s=", autoISF-SMB enabled:, even Target","enabled")):(console.error("SMB disabled - "+msgType+a+msgUnits+msgEven+msgTail),s=", autoISF-SMB disabled:, odd Target","blocked")):"oref"}(y,a),Le=!0;if(w&&"oref"!=ze?("blocked"==ze&&(Le=!1),console.error("loopSMB function overriden with autoISF target toggle, enableSMB = "+Le)):(Le=function(e,r,a,t,o,i){return r?!e.allowSMB_with_high_temptarget&&e.temptargetSet&&o>100?(console.error("SMB disabled due to high temptarget of "+o),!1):!0===a.bwFound&&!1===e.A52_risk_enable?(console.error("SMB disabled due to Bolus Wizard activity in the last 6 hours."),!1):!0===e.enableSMB_always?(a.bwFound?console.error("Warning: SMB enabled within 6h of using Bolus Wizard: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled due to enableSMB_always"),!0):!0===e.enableSMB_with_COB&&a.mealCOB?(a.bwCarbs?console.error("Warning: SMB enabled with Bolus Wizard carbs: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled for COB of",a.mealCOB),!0):!0===e.enableSMB_after_carbs&&a.carbs?(a.bwCarbs?console.error("Warning: SMB enabled with Bolus Wizard carbs: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled for 6h after carb entry"),!0):!0===e.enableSMB_with_temptarget&&e.temptargetSet&&o<100?(a.bwFound?console.error("Warning: SMB enabled within 6h of using Bolus Wizard: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled for temptarget of",n(o,e)),console.error("SMB enabled for temptargets with "+n(o,e)),!0):!0===e.enableSMB_high_bg&&null!==i&&t>=i?(console.error("Checking BG to see if High for SMB enablement."),console.error("Current BG",t," | High BG ",i),a.bwFound?console.error("Warning: High BG SMB enabled within 6h of using Bolus Wizard: be sure to easy bolus 30s before using Bolus Wizard"):console.error("High BG detected. Enabling SMB."),!0):(console.error("SMB disabled (no enableSMB preferences active or no condition satisfied)"),!1):(console.error("SMB disabled (!microBolusAllowed)"),!1)}(y,w,F,Be,xe,we),console.error("loopSMB function returns enableSMB = "+Le)),qe=function(e,r,a,t,y,x,F,I,w,T,C,G){if(!t.use_autoisf)return console.error("autoISF disabled in Preferences"),i+=", autoISF, disabled",e;if(t.autoISF_off_Sport&&(t.high_temptarget_raises_sensitivity||t.exercise_mode)&&t.temptargetSet&&a>G)return console.error("autoISF disabled due to exercise"),i+=", autoISF, disabled (exercise)",e;const D=y.dura_p,O=y.delta_pl,R=y.delta_pn,U=y.r_squ,A=y.bg_acceleration,P=y.a_0,k=y.a_1,j=y.a_2,E=y.dura_ISF_minutes,W=y.dura_ISF_average;var q=t.autoISF_min,z=t.autoISF_max,L=!1,N=e,X=a+10-W;if(x.mealCOB>0&&!t.enableautoisf_with_COB)return console.error("BG dependant autoISF by-passed; preferences disabled mealCOB of "+o(x.mealCOB,1)),i+=", autoISF, disabled with COB",e;var Y=y.pp_debug;if(m+="BG-accel: "+o(A,3)+", PF-minutes: "+D+", PF-corr: "+o(U,4)+", PF-nextDelta: "+n(R,t)+", PF-lastDelta: "+n(O,t)+", regular Delta: "+n(y.delta,t),console.error(Y+m+" , Weights Accel/Brake: "+t.bgAccel_ISF_weight+" / "+t.bgBrake_ISF_weight),t.enable_BG_acceleration){var H=U,Z=A;if(0!=y.parabola_fit_a2&&H>=.9){var $=-k/2/j*5,J=o(P-$*$/25*j,1);($=o($,1))>0&&Z<0?(g="predicts a Max of "+n(J,t)+", in about "+Math.abs($)+"min",console.error("Parabolic fit "+g)):$>0&&Z>0?(g="predicts a Min of "+n(J,t)+", in about "+Math.abs($)+"min",console.error("Parabolic fit "+g)):$<0&&Z<0?(g="saw Max of "+n(J,t)+", about "+Math.abs($)+"min ago",console.error("Parabolic fit "+g)):$<0&&Z>0&&(g="saw Min of "+n(J,t)+", about "+Math.abs($)+"min ago",console.error("Parabolic fit "+g))}if(H<.9)g="acce_ISF by-passed, as correlation, "+o(H,2)+", is too low",console.error("Parabolic fit "+g),c+=", Parabolic Fit, "+g;else{var K=10*(H-.9),Q=1,V=1;y.glucose<t.target_bg?Z>0?(Z>1&&(Q=.5),V=t.bgBrake_ISF_weight):Z<0&&(V=t.bgAccel_ISF_weight):Z<0?V=t.bgBrake_ISF_weight:Z>0&&(V=t.bgAccel_ISF_weight),(f=1+Z*Q*V*K)<0&&(f=.1),console.error(c+"acce_ISF adaptation is "+o(f,2)),1!=f&&(L=!0,c+=", Parabolic Fit, "+g+", acce-ISF Ratio: "+o(f,2))}}else console.error("autoISF BG accelertion adaption disabled in Preferences");i+=s+c+", autoISF",h=1+M(100-X,t,"bg"),console.error("bg_ISF adaptation is "+o(h,2));var ee=1,re=1;if(h<1)return ee=Math.min(h,f),f>1&&(p="bg-ISF adaptation lifted to "+o(ee=h*f,2)+", as BG accelerates already",console.error(p),i+=", bg-ISF Ratio: "+o(ee,2)+"(accel.)"),re=S(ee,q,z,w,r,t,C,a,G),N=Math.min(720,o(t.sens/re,1)),i+=", bg-ISF Ratio: "+o(re,2),N;h>1&&(L=!0,i+=", bg-ISF Ratio: "+o(h,2));var ae=y.delta;t.enablepp_ISF_always||t.pp_ISF_hours>=(F-x.lastCarbTime)/1e3/3600?deltaType="pp":deltaType="delta",X>0?console.error(deltaType+"_ISF adaptation by-passed as average glucose < "+a+"+10"):y.short_avgdelta<0?console.error(deltaType+"_ISF adaptation by-passed as no rise or too short lived"):"pp"==deltaType?(B=1+Math.max(0,ae*t.pp_ISF_weight),console.error("pp_ISF adaptation is "+o(B,2)),d=", pp-ISF Ratio: "+o(B,2),1!=B&&(L=!0)):(v=M(ae,t,"delta"),X>-20&&(v*=.5),v=1+v,console.error("delta_ISF adaptation is "+o(v,2)),u=", Δ-ISF Ratio: "+o(v,2),1!=v&&(L=!0));var te=t.dura_ISF_weight;x.mealCOB>0&&!t.enableautoisf_with_COB?console.error("dura_ISF by-passed; preferences disabled mealCOB of "+o(x.mealCOB,1)):E<10?console.error("dura_ISF by-passed; BG is only "+E+"m at level "+W):W<=a?console.error("dura_ISF by-passed; avg. glucose "+W+" below target "+n(a,t)):(_+=E/60*(te/a)*(W-a),L=!0,l=", Duration: "+E+", Avg: "+n(W,t)+", dura-ISF Ratio: "+o(_,2),console.error("dura_ISF adaptation is "+o(_,2)+" because ISF "+e+" did not do it for "+o(E,1)+"m"));return L?(ee=Math.max(_,h,v,f,B),console.error("autoISF adaption ratios:"),console.error("  dura "+o(_,2)),console.error("  bg "+o(h,2)),console.error("  delta "+o(v,2)),console.error("  pp "+o(B,2)),console.error("  accel "+o(f,2)),f<1&&(p="strongest ISF factor "+o(ee,2)+" weakened to "+o(ee*f,2)+" as bg decelerates already",console.error(p),ee*=f),re=S(ee,q,z,w,r,t,C,a,G),N=o(t.sens/re,1),i+=d+u+l+", final Ratio: "+o(re,2)+b+", final ISF: "+n(t.sens,t)+"→"+n(N,t),N):(i+=", not modified",console.error("autoISF does not modify"),N)}(qe,Ce,xe,y,e,F,C,0,sensitivityRatio,0,Ge,De),console.error("----------------------------------"),console.error(" end autoISF"),console.error("----------------------------------"),void 0===a)return me.error="Error: iob_data undefined. ",me;var Ne,Xe=a;if(a.length,a.length>1&&(a=Xe[0]),void 0===a.activity||void 0===a.iob)return me.error="Error: iob_data missing some property. ",me;var Ye=((Ne=void 0!==a.lastTemp?o((new Date(be).getTime()-a.lastTemp.date)/6e4):0)+r.duration)%30;if(console.error("currenttemp:"+r.rate+" lastTempAge:"+Ne+"m, tempModulus:"+Ye+"m"),me.temp="absolute",me.deliverAt=ce,w&&r&&a.lastTemp&&r.rate!==a.lastTemp.rate&&Ne>10&&r.duration)return me.reason="Warning: currenttemp rate "+r.rate+" != lastTemp rate "+a.lastTemp.rate+" from pumphistory; canceling temp",I.setTempBasal(0,0,y,me,r);if(r&&a.lastTemp&&r.duration>0){var He=Ne-a.lastTemp.duration;if(He>5&&Ne>10)return me.reason="Warning: currenttemp running but lastTemp from pumphistory ended "+He+"m ago; canceling temp",I.setTempBasal(0,0,y,me,r)}var Ze=o(-a.activity*qe*5,2),$e=o(6*(Me-Ze));$e<0&&($e=o(6*(Se-Ze)))<0&&($e=o(6*(e.long_avgdelta-Ze)));var Je=Be,Ke=(Je=a.iob>0?o(Be-a.iob*qe):o(Be-a.iob*Math.min(qe,y.sens)))+$e;if(void 0===Ke||isNaN(Ke))return me.error="Error: could not calculate eventualBG. Sensitivity: "+qe+" Deviation: "+$e,me;var Qe=function(e,r,a){return o(a+(e-r)/24,1)}(xe,Ke,Ze);me={temp:"absolute",bg:n(Be,y),tick:fe,eventualBG:Ke,insulinReq:0,reservoir:T,deliverAt:ce,sensitivityRatio,TDD:ue,insulin:de};var Ve=[],er=[],rr=[],ar=[];Ve.push(Be),er.push(Be),ar.push(Be),rr.push(Be);var tr=y.enableUAM,or=0,nr=0;or=o(Me-Ze,1);var ir=o(Me-Ze,1);csf=qe/y.carb_ratio,console.error("profile.sens:"+n(y.sens,y)+", sens:"+n(qe,y)+", CSF:"+o(csf,1));var sr=o(30*csf*5/60,1);or>sr&&(console.error("Limiting carb impact from "+or+" to "+sr+"mg/dL/5m (30g/h)"),or=sr);var lr=3;sensitivityRatio&&(lr/=sensitivityRatio);var dr=lr;if(F.carbs){lr=Math.max(lr,F.mealCOB/20);var ur=o((new Date(be).getTime()-F.lastCarbTime)/6e4),mr=(F.carbs-F.mealCOB)/F.carbs;dr=o(dr=lr+1.5*ur/60,1),console.error("Last carbs "+ur+" minutes ago; remainingCATime:"+dr+"hours; "+o(100*mr)+"% carbs absorbed")}var cr=Math.max(0,or/5*60*dr/2)/csf,pr=90,gr=1;y.remainingCarbsCap&&(pr=Math.min(90,y.remainingCarbsCap)),y.remainingCarbsFraction&&(gr=Math.min(1,y.remainingCarbsFraction));var br=1-gr,fr=Math.max(0,F.mealCOB-cr-F.carbs*br),hr=(fr=Math.min(pr,fr))*csf*5/60/(dr/2),vr=o(F.slopeFromMaxDeviation,2),Br=o(F.slopeFromMinDeviation,2),_r=Math.min(vr,-Br/3),Mr=0;0===or?nr=0:!0===y.floating_carbs?(nr=Math.min(60*dr/5/2,Math.max(0,F.carbs*csf/or)),Mr=Math.min(60*dr/5/2,Math.max(0,F.mealCOB*csf/or)),F.carbs>0&&(i+=", Floating Carbs:, CID: "+o(nr,1)+", MealCarbs: "+o(F.carbs,1)+", Not Floating:, CID: "+o(Mr,1)+", MealCOB: "+o(F.mealCOB,1),console.error("Floating Carbs CID: "+o(nr,1)+" / MealCarbs: "+o(F.carbs,1)+" vs. Not Floating:"+o(Mr,1)+" / MealCOB:"+o(F.mealCOB,1)))):nr=Math.min(60*dr/5/2,Math.max(0,F.mealCOB*csf/or)),console.error("Carb Impact:"+or+"mg/dL per 5m; CI Duration:"+o(5*nr/60*2,1)+"hours; remaining CI ("+o(dr/2,2)+"h peak):",o(hr,1)+"mg/dL per 5m");var Sr,yr,xr,Fr,Ir,wr=999,Tr=999,Cr=999,Gr=Be,Dr=999,Or=999,Rr=999,Ur=999,Ar=Ke,Pr=Be,kr=Be,jr=0,Er=[],Wr=[];try{Xe.forEach((function(e){var r=o(-e.activity*qe*5,2),a=o(-e.iobWithZeroTemp.activity*qe*5,2),t=or*(1-Math.min(1,er.length/12));Ar=er[er.length-1]+r+t;var n=ar[ar.length-1]+a,i=Math.max(0,Math.max(0,or)*(1-Ve.length/Math.max(2*nr,1))),s=Math.min(Ve.length,12*dr-Ve.length),l=Math.max(0,s/(dr/2*12)*hr);i+l,Er.push(o(l,0)),Wr.push(o(i,0)),COBpredBG=Ve[Ve.length-1]+r+Math.min(0,t)+i+l;var d=Math.max(0,ir+rr.length*_r),u=Math.max(0,ir*(1-rr.length/Math.max(36,1))),m=Math.min(d,u);m>0&&(jr=o(5*(rr.length+1)/60,1)),UAMpredBG=rr[rr.length-1]+r+Math.min(0,t)+m,er.length<48&&er.push(Ar),Ve.length<48&&Ve.push(COBpredBG),rr.length<48&&rr.push(UAMpredBG),ar.length<48&&ar.push(n),COBpredBG<Dr&&(Dr=o(COBpredBG)),UAMpredBG<Or&&(Or=o(UAMpredBG)),Ar<Rr&&(Rr=o(Ar)),n<Ur&&(Ur=o(n));er.length>18&&Ar<wr&&(wr=o(Ar)),Ar>Pr&&(Pr=Ar),(nr||hr>0)&&Ve.length>18&&COBpredBG<Tr&&(Tr=o(COBpredBG)),(nr||hr>0)&&COBpredBG>Pr&&(kr=COBpredBG),tr&&rr.length>12&&UAMpredBG<Cr&&(Cr=o(UAMpredBG)),tr&&UAMpredBG>Pr&&UAMpredBG}))}catch(e){console.error("Problem with iobArray.  Optional feature Advanced Meal Assist disabled")}me.predBGs={},er.forEach((function(e,r,a){a[r]=o(Math.min(401,Math.max(39,e)))}));for(var qr=er.length-1;qr>12&&er[qr-1]===er[qr];qr--)er.pop();for(me.predBGs.IOB=er,xr=o(er[er.length-1]),ar.forEach((function(e,r,a){a[r]=o(Math.min(401,Math.max(39,e)))})),qr=ar.length-1;qr>6&&!(ar[qr-1]>=ar[qr]||ar[qr]<=xe);qr--)ar.pop();if(me.predBGs.ZT=ar,o(ar[ar.length-1]),F.mealCOB>0&&(or>0||hr>0)){for(Ve.forEach((function(e,r,a){a[r]=o(Math.min(401,Math.max(39,e)))})),qr=Ve.length-1;qr>12&&Ve[qr-1]===Ve[qr];qr--)Ve.pop();me.predBGs.COB=Ve,Fr=o(Ve[Ve.length-1]),Ke=Math.max(Ke,o(Ve[Ve.length-1]))}if(or>0||hr>0){if(tr){for(rr.forEach((function(e,r,a){a[r]=o(Math.min(401,Math.max(39,e)))})),qr=rr.length-1;qr>12&&rr[qr-1]===rr[qr];qr--)rr.pop();me.predBGs.UAM=rr,Ir=o(rr[rr.length-1]),rr[rr.length-1]&&(Ke=Math.max(Ke,o(rr[rr.length-1])))}me.eventualBG=Ke}console.error("UAM Impact:"+ir+"mg/dL per 5m; UAM Duration:"+jr+"hours"),wr=Math.max(39,wr),Tr=Math.max(39,Tr),Cr=Math.max(39,Cr),Sr=o(wr);var zr=F.mealCOB/F.carbs;yr=o(Cr<999&&Tr<999?(1-zr)*UAMpredBG+zr*COBpredBG:Tr<999?(Ar+COBpredBG)/2:Cr<999?(Ar+UAMpredBG)/2:Ar),Ur>yr&&(yr=Ur),Gr=o(Gr=nr||hr>0?tr?zr*Dr+(1-zr)*Or:Dr:tr?Or:Rr);var Lr=Cr;if(Ur<Ee)Lr=(Cr+Ur)/2;else if(Ur<xe){var Nr=(Ur-Ee)/(xe-Ee);Lr=(Cr+(Cr*Nr+Ur*(1-Nr)))/2}else Ur>Cr&&(Lr=(Cr+Ur)/2);if(Lr=o(Lr),F.carbs)if(!tr&&Tr<999)Sr=o(Math.max(wr,Tr));else if(Tr<999){var Xr=zr*Tr+(1-zr)*Lr;Sr=o(Math.max(wr,Tr,Xr))}else Sr=tr?Lr:Gr;else tr&&(Sr=o(Math.max(wr,Lr)));Sr=Math.min(Sr,yr),process.stderr.write("minPredBG: "+n(Sr,y)+" minIOBPredBG: "+n(wr,y)+" minZTGuardBG: "+n(Ur,y)),Tr<999&&process.stderr.write(" minCOBPredBG: "+n(Tr,y)),Cr<999&&process.stderr.write(" minUAMPredBG: "+n(Cr,y)),console.error(" avgPredBG:"+n(yr,y)+" COB/Carbs:"+F.mealCOB+"/"+F.carbs),kr>Be&&(Sr=Math.min(Sr,kr)),me.COB=F.mealCOB,me.IOB=a.iob,me.BGI=n(Ze,y),me.deviation=n($e,y),me.dura_ISFratio=o(_,2),me.bg_ISFratio=o(h,2),me.delta_ISFratio=o(v,2),me.pp_ISFratio=o(B,2),me.acce_ISFratio=o(f,2),me.auto_ISFratio=o(y.sens/qe,2),me.ISF=n(qe,y),me.CR=o(y.carb_ratio,2),me.TDD=o(ue,1),me.TDDytd=o(Y,1),me.TDD7d=o(H,1),me.target_bg=n(xe,y);var Yr=function(e,r,a,t){if(!e.use_autoisf)return console.error("autoISF disabled, don't adjust SMB Delivery Ratio"),.5;var n=e.smb_delivery_ratio_bg_range,i=e.smb_delivery_ratio,s=Math.min(e.smb_delivery_ratio_min,e.smb_delivery_ratio_max),l=Math.max(e.smb_delivery_ratio_min,e.smb_delivery_ratio_max),d=a+e.smb_delivery_ratio_bg_range,u=i;return n>0&&(u=s+(l-s)*(r-a)/n,u=Math.max(s,Math.min(l,u))),"enforced"==t?(console.error("SMB delivery ratio set to "+o(Math.max(i,u),2)+" as max of fixed and interpolated values"),Math.max(i,u)):0==n?(console.error("SMB delivery ratio set to fixed value "+o(i,2)),i):r<=a?(console.error("SMB delivery ratio limited by minimum value "+o(s,2)),s):r>=d?(console.error("SMB delivery ratio limited by maximum value "+o(l,2)),l):(console.error("SMB delivery ratio set to interpolated value "+o(u,2)),u)}(y,Be,xe,ze);me.SMBratio=o(Yr,2);var Hr="SMB Ratio:, "+o(Yr,2);me.reason=Hr+i+", Standard, COB: "+me.COB+", Dev: "+me.deviation+", BGI: "+me.BGI+", ISF: "+me.ISF+", CR: "+me.CR+", Target: "+me.target_bg+", minPredBG "+n(Sr,y)+", minGuardBG "+n(Gr,y)+", IOBpredBG "+n(xr,y),Fr>0&&(me.reason+=", COBpredBG "+n(Fr,y)),Ir>0&&(me.reason+=", UAMpredBG "+n(Ir,y)),me.reason+=tddReason,me.reason+="; ";var Zr=Je;Zr<40&&(Zr=Math.min(Gr,Zr));var $r=Ee-Zr,Jr=240,Kr=240;if(F.mealCOB>0&&(or>0||hr>0)){for(qr=0;qr<Ve.length;qr++)if(Ve[qr]<Fe){Jr=5*qr;break}for(qr=0;qr<Ve.length;qr++)if(Ve[qr]<Ee){Kr=5*qr;break}}else{for(qr=0;qr<er.length;qr++)if(er[qr]<Fe){Jr=5*qr;break}for(qr=0;qr<er.length;qr++)if(er[qr]<Ee){Kr=5*qr;break}}Le&&Gr<Ee&&(console.error("minGuardBG "+n(Gr,y)+" projected below "+n(Ee,y)+" - disabling SMB"),Le=!1);var Qr=.2;void 0!==y.maxDelta_bg_threshold&&(Qr=Math.min(y.maxDelta_bg_threshold,.4),console.error("maxDelta threshold for BG-Jump to allow SMB's set to: "+100*Qr+"%")),ye>Qr*Be&&(console.error("maxDelta "+n(ye,y)+" > "+100*Qr+"% of BG "+n(Be,y)+" - disabling SMB"),me.reason+="maxDelta "+n(ye,y)+" > "+100*Qr+"% of BG "+n(Be,y)+" - SMB disabled!, ",Le=!1),console.error("BG projected to remain above "+n(Fe,y)+" for "+Jr+"minutes"),(Kr<240||Jr<60)&&console.error("BG projected to remain above "+n(Ee,y)+" for "+Kr+"minutes");var Vr=Kr,ea=y.current_basal*qe*Vr/60,ra=Math.max(0,F.mealCOB-.25*F.carbs),aa=($r-ea)/csf-ra;ea=o(ea),aa=o(aa),console.error("naive_eventualBG: "+n(Je,y)+", bgUndershoot: "+n($r,y)+", zeroTempDuration: "+Vr+", zeroTempEffect: "+ea+", carbsReq: "+aa),"Could not parse clock data"==F.reason?console.error("carbsReq unknown: Could not parse clock data"):aa>=y.carbsReqThreshold&&Kr<=45&&(me.carbsReq=aa,me.reason+=aa+" add'l carbs req w/in "+Kr+"m; ");var ta=0;if(Be<Ee&&a.iob<20*-y.current_basal/60&&Me>0&&Me>Qe)me.reason+="IOB "+a.iob+" < "+o(20*-y.current_basal/60,2),me.reason+=" and minDelta "+n(Me,y)+" > expectedDelta "+n(Qe,y)+"; ";else if(Be<Ee||Gr<Ee)return me.reason+="minGuardBG "+n(Gr,y)+"<"+n(Ee,y),ta=o(60*(($r=xe-Gr)/qe)/y.current_basal),ta=30*o(ta/30),ta=Math.min(120,Math.max(30,ta)),I.setTempBasal(0,ta,y,me,r);if(y.skip_neutral_temps&&me.deliverAt.getMinutes()>=55)return me.reason+="; Canceling temp at "+me.deliverAt.getMinutes()+"m past the hour. ",I.setTempBasal(0,0,y,me,r);var oa=0,na=ge;if(Ke<Fe){if(me.reason+="Eventual BG "+n(Ke,y)+" < "+n(Fe,y),Me>Qe&&Me>0&&!aa)return Je<40?(me.reason+=", naive_eventualBG < 40. ",I.setTempBasal(0,30,y,me,r)):(e.delta>Me?me.reason+=", but Delta "+n(fe,y)+" > expectedDelta "+n(Qe,y):me.reason+=", but Min. Delta "+Me.toFixed(2)+" > Exp. Delta "+n(Qe,y),r.duration>15&&t(ge,y)===t(r.rate,y)?(me.reason+=", temp "+r.rate+" ~ req "+ge+"U/hr. ",me):(me.reason+="; setting current basal of "+ge+" as temp. ",I.setTempBasal(ge,30,y,me,r)));oa=o(oa=2*Math.min(0,(Ke-xe)/qe),2);var ia=Math.min(0,(Je-xe)/qe);if(ia=o(ia,2),Me<0&&Me>Qe)oa=o(oa*(Me/Qe),2);if(na=t(na=ge+2*oa,y),r.duration*(r.rate-ge)/60<Math.min(oa,ia)-.3*ge)return me.reason+=", "+r.duration+"m@"+r.rate.toFixed(2)+" is a lot less than needed. ",I.setTempBasal(na,30,y,me,r);if(void 0!==r.rate&&r.duration>5&&na>=.8*r.rate)return me.reason+=", temp "+r.rate+" ~< req "+na+"U/hr. ",me;if(na<=0){if((ta=o(60*(($r=xe-Je)/qe)/y.current_basal))<0?ta=0:(ta=30*o(ta/30),ta=Math.min(120,Math.max(0,ta))),ta>0)return me.reason+=", setting "+ta+"m zero temp. ",I.setTempBasal(na,ta,y,me,r)}else me.reason+=", setting "+na+"U/hr. ";return I.setTempBasal(na,30,y,me,r)}if(Me<Qe&&(!w||!Le))return e.delta<Me?me.reason+="Eventual BG "+n(Ke,y)+" > "+n(Fe,y)+" but Delta "+n(fe,y)+" < Exp. Delta "+n(Qe,y):me.reason+="Eventual BG "+n(Ke,y)+" > "+n(Fe,y)+" but Min. Delta "+Me.toFixed(2)+" < Exp. Delta "+n(Qe,y),r.duration>15&&t(ge,y)===t(r.rate,y)?(me.reason+=", temp "+r.rate+" ~ req "+ge+"U/hr. ",me):(me.reason+="; setting current basal of "+ge+" as temp. ",I.setTempBasal(ge,30,y,me,r));if(Math.min(Ke,Sr)<Ie&&(!w||!Le))return me.reason+=n(Ke,y)+"-"+n(Sr,y)+" in range: no temp required",r.duration>15&&t(ge,y)===t(r.rate,y)?(me.reason+=", temp "+r.rate+" ~ req "+ge+"U/hr. ",me):(me.reason+="; setting current basal of "+ge+" as temp. ",I.setTempBasal(ge,30,y,me,r));if(Ke>=Ie&&(me.reason+="Eventual BG "+n(Ke,y)+" >= "+n(Ie,y)+", "),a.iob>Te)return me.reason+="IOB "+o(a.iob,2)+" > max_iob "+Te,r.duration>15&&t(ge,y)===t(r.rate,y)?(me.reason+=", temp "+r.rate+" ~ req "+ge+"U/hr. ",me):(me.reason+="; setting current basal of "+ge+" as temp. ",I.setTempBasal(ge,30,y,me,r));(oa=o((Math.min(Sr,Ke)-xe)/qe,2))>Te-a.iob&&(me.reason+="max_iob "+Te+", ",oa=Te-a.iob),na=t(na=ge+2*oa,y),oa=o(oa,3),me.insulinReq=oa;var sa=o((new Date(be).getTime()-a.lastBolusTime)/6e4,1);if(w&&Le&&Be>Ee){var la=o(F.mealCOB/y.carb_ratio,3);if(y.use_autoisf)da=y.smb_max_range_extension;else{console.error("autoISF disabled, SMB range extension disabled");var da=1}da>1&&console.error("SMB max range extended from default by factor "+da);var ua=0;void 0===y.maxSMBBasalMinutes?(ua=o(da*y.current_basal*30/60,1),console.error("profile.maxSMBBasalMinutes undefined: defaulting to 30m")):a.iob>la&&a.iob>0?(console.error("IOB",a.iob,"> COB",F.mealCOB+"; mealInsulinReq =",la),y.maxUAMSMBBasalMinutes?(console.error("profile.maxUAMSMBBasalMinutes:",y.maxUAMSMBBasalMinutes,"profile.current_basal:",y.current_basal),ua=o(da*y.current_basal*y.maxUAMSMBBasalMinutes/60,1)):(console.error("profile.maxUAMSMBBasalMinutes undefined: defaulting to 30m"),ua=o(30*y.current_basal/60,1))):(console.error("profile.maxSMBBasalMinutes:",y.maxSMBBasalMinutes,"profile.current_basal:",y.current_basal),ua=o(da*y.current_basal*y.maxSMBBasalMinutes/60,1));var ma=y.bolus_increment,ca=1/ma;y.use_autoisf||(console.error("autoISF disabled, don't adjust SMB Delivery Ratio"),Yr=.5),Yr>.5&&console.error("SMB Delivery Ratio increased from default 0.5 to "+o(Yr,2));var pa=Math.min(oa*Yr,ua);pa=Math.floor(pa*ca)/ca,ta=o(60*((xe-(Je+wr)/2)/qe)/y.current_basal),oa>0&&pa<ma&&(ta=0);var ga=0;ta<=0?ta=0:ta>=30?(ta=30*o(ta/30),ta=Math.min(60,Math.max(0,ta))):(ga=o(ge*ta/30,2),ta=30),me.reason+=" insulinReq "+oa,pa>=ua&&(me.reason+="; maxBolus "+ua),ta>0&&(me.reason+="; setting "+ta+"m low temp of "+ga+"U/h"),me.reason+=". ";var ba=3;y.SMBInterval&&(ba=Math.min(10,Math.max(1,y.SMBInterval)));var fa=o(ba-sa,0),ha=o(60*(ba-sa),0)%60;if(console.error("naive_eventualBG "+n(Je,y)+", "+ta+"m "+ga+"U/h temp needed; last bolus "+sa+"m ago; maxBolus: "+ua),sa>ba?pa>0&&(me.units=pa,me.reason+="Microbolusing "+pa+"U. "):me.reason+="Waiting "+fa+"m "+ha+"s to microbolus again. ",ta>0)return me.rate=ga,me.duration=ta,me}var va=I.getMaxSafeBasal(y);return na>va&&(me.reason+="adj. req. rate: "+o(na,2)+" to maxSafeBasal: "+o(va,2)+", ",na=t(va,y)),r.duration*(r.rate-ge)/60>=2*oa?(me.reason+=r.duration+"m@"+r.rate.toFixed(2)+" > 2 * insulinReq. Setting temp basal of "+na+"U/hr. ",I.setTempBasal(na,30,y,me,r)):void 0===r.duration||0===r.duration?(me.reason+="no temp, setting "+na+"U/hr. ",I.setTempBasal(na,30,y,me,r)):r.duration>5&&t(na,y)<=t(r.rate,y)?(me.reason+="temp "+r.rate+" >~ req "+na+"U/hr. ",me):(me.reason+="temp "+r.rate+"<"+na+"U/hr. ",I.setTempBasal(na,30,y,me,r))}},6880:(e,r,a)=>{var t=a(6654);e.exports=function(e,r){var a=20;void 0!==r&&"string"==typeof r.model&&(t(r.model,"54")||t(r.model,"23"))&&(a=40);return e<1?Math.round(e*a)/a:e<10?Math.round(20*e)/20:Math.round(10*e)/10}},2705:(e,r,a)=>{var t=a(5639).Symbol;e.exports=t},9932:e=>{e.exports=function(e,r){for(var a=-1,t=null==e?0:e.length,o=Array(t);++a<t;)o[a]=r(e[a],a,e);return o}},9750:e=>{e.exports=function(e,r,a){return e==e&&(void 0!==a&&(e=e<=a?e:a),void 0!==r&&(e=e>=r?e:r)),e}},4239:(e,r,a)=>{var t=a(2705),o=a(9607),n=a(2333),i=t?t.toStringTag:void 0;e.exports=function(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":i&&i in Object(e)?o(e):n(e)}},531:(e,r,a)=>{var t=a(2705),o=a(9932),n=a(1469),i=a(3448),s=t?t.prototype:void 0,l=s?s.toString:void 0;e.exports=function e(r){if("string"==typeof r)return r;if(n(r))return o(r,e)+"";if(i(r))return l?l.call(r):"";var a=r+"";return"0"==a&&1/r==-Infinity?"-0":a}},7561:(e,r,a)=>{var t=a(7990),o=/^\s+/;e.exports=function(e){return e?e.slice(0,t(e)+1).replace(o,""):e}},1957:(e,r,a)=>{var t="object"==typeof a.g&&a.g&&a.g.Object===Object&&a.g;e.exports=t},9607:(e,r,a)=>{var t=a(2705),o=Object.prototype,n=o.hasOwnProperty,i=o.toString,s=t?t.toStringTag:void 0;e.exports=function(e){var r=n.call(e,s),a=e[s];try{e[s]=void 0;var t=!0}catch(e){}var o=i.call(e);return t&&(r?e[s]=a:delete e[s]),o}},2333:e=>{var r=Object.prototype.toString;e.exports=function(e){return r.call(e)}},5639:(e,r,a)=>{var t=a(1957),o="object"==typeof self&&self&&self.Object===Object&&self,n=t||o||Function("return this")();e.exports=n},7990:e=>{var r=/\s/;e.exports=function(e){for(var a=e.length;a--&&r.test(e.charAt(a)););return a}},6654:(e,r,a)=>{var t=a(9750),o=a(531),n=a(554),i=a(9833);e.exports=function(e,r,a){e=i(e),r=o(r);var s=e.length,l=a=void 0===a?s:t(n(a),0,s);return(a-=r.length)>=0&&e.slice(a,l)==r}},1469:e=>{var r=Array.isArray;e.exports=r},3218:e=>{e.exports=function(e){var r=typeof e;return null!=e&&("object"==r||"function"==r)}},7005:e=>{e.exports=function(e){return null!=e&&"object"==typeof e}},3448:(e,r,a)=>{var t=a(4239),o=a(7005);e.exports=function(e){return"symbol"==typeof e||o(e)&&"[object Symbol]"==t(e)}},8601:(e,r,a)=>{var t=a(4841),o=1/0;e.exports=function(e){return e?(e=t(e))===o||e===-1/0?17976931348623157e292*(e<0?-1:1):e==e?e:0:0===e?e:0}},554:(e,r,a)=>{var t=a(8601);e.exports=function(e){var r=t(e),a=r%1;return r==r?a?r-a:r:0}},4841:(e,r,a)=>{var t=a(7561),o=a(3218),n=a(3448),i=/^[-+]0x[0-9a-f]+$/i,s=/^0b[01]+$/i,l=/^0o[0-7]+$/i,d=parseInt;e.exports=function(e){if("number"==typeof e)return e;if(n(e))return NaN;if(o(e)){var r="function"==typeof e.valueOf?e.valueOf():e;e=o(r)?r+"":r}if("string"!=typeof e)return 0===e?e:+e;e=t(e);var a=s.test(e);return a||l.test(e)?d(e.slice(2),a?2:8):i.test(e)?NaN:+e}},9833:(e,r,a)=>{var t=a(531);e.exports=function(e){return null==e?"":t(e)}}},r={};function a(t){var o=r[t];if(void 0!==o)return o.exports;var n=r[t]={exports:{}};return e[t](n,n.exports,a),n.exports}a.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}();var t=a(5546);freeaps_determineBasal=t})();