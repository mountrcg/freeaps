var freeaps_determineBasal;(()=>{var e={5546:(e,r,a)=>{var t=a(6880);function o(e,r){r||(r=0);var a=Math.pow(10,r);return Math.round(e*a)/a}function n(e,r){return"mmol/L"===r.out_units?o(e/18,1):Math.round(e)}var i="",s="",l="",u="",d="",m="",c="",p="",g="",b="";function f(e,r,a){polyX_bg=[50,60,80,90,100,110,150,180,200],polyY_bg=[-.5,-.5,-.3,-.2,0,0,.5,.7,.7],polyX_delta=[2,7,12,16,20],polyY_delta=[0,0,.4,.7,.7],"bg"==a?(polyX=polyX_bg,polyY=polyY_bg):"delta"==a&&(polyX=polyX_delta,polyY=polyY_delta);var t=polyX.length-1,o=polyX[0],n=polyY[0],i=polyX[t],s=polyY[t],l=1,u=1,d=1,m=o;if(o>e)i=polyX[1],l=(u=n)+((s=polyY[1])-u)/(i-(d=o))*(e-d);else if(i<e)o=polyX[t-1],l=(u=n=polyY[t-1])+(s-u)/(i-(d=o))*(e-d);else for(var c=0;c<=t;c++){if(o=polyX[c],n=polyY[c],o==e){l=n;break}if(o>e){l=u+(n-u)/(o-(d=m))*(e-d);break}u=n,m=o}return l*="delta"==a?r.delta_ISFrange_weight:e>100?r.higher_ISFrange_weight:r.lower_ISFrange_weight}function h(e,r,a,t){console.error("check ratio "+o(e,2)+" against autoISF min: "+r+" and autoISF max: "+a),e<r?(b=" (lmtd.)",p="weakest ISF factor "+o(e,2)+" limited by autoisf_min "+r,console.error(p),e=r):e>a&&(b=" (lmtd.)",p="strongest ISF factor "+o(e,2)+" limited by autoisf_max "+a,console.error(p),e=a);var n=1;return e>=1&&(n=Math.max(e,t)),e<1&&(n=Math.min(e,t)),p="final ISF factor "+o(n,2),console.error(p),n}e.exports=function(e,r,a,v,_,B,M,S,y,x,F,I,w,T,C,G){var D=0,O="",R="",U="",A="",P=0,k=(T=0,0),j=0,E=0,W=0,q=0;C.length>0&&(q=C[0].TDD);let z=G.avgTDD7d;function L(e,r){var a=e.getTime();return new Date(a+36e5*r)}function X(e){var r=v.bolus_increment;.05!=r&&(r=.1);var a=e/r;return a>=1?o(Math.floor(a)*r,5):0}function Y(e){function r(e){return e<10&&(e="0"+e),e}return r(e.getHours())+":"+r(e.getMinutes())+":00"}function N(e,r){var a=new Date("1/1/1999 "+e),t=new Date("1/1/1999 "+r);return(a.getTime()-t.getTime())/36e5}function H(e,r){var a=0,t=r,o=(e-r)/36e5,n=0,i=o,s=0;do{if(o>0){var l=Y(t);w[0].rate;for(let e=0;e<w.length;e++){var u=w[e].start;if(l==u){if(e+1<w.length){o>=(s=N(w[e+1].start,w[e].start))?n=s:o<s&&(n=o)}else if(e+1==w.length){let r=w[0].start;o>=(s=24-N(w[e].start,r))?n=s:o<s&&(n=o)}a+=X(w[e].rate*n),o-=n,t=L(t,n)}else if(l>u)if(e+1<w.length){var d=w[e+1].start;l<d&&(o>=(s=N(d,l))?n=s:o<s&&(n=o),a+=X(w[e].rate*n),o-=n,t=L(t,n))}else if(e==w.length-1){o>=(s=N("23:59:59",l))?n=s:o<s&&(n=o),a+=X(w[e].rate*n),o-=n,t=L(t,n)}}}}while(o>0&&o<i);return a}if(F.length){let e=F.length-1;var Z=new Date(F[e].timestamp),$=new Date(F[0].timestamp);if("TempBasalDuration"==F[0]._type&&($=new Date),(D=($-Z)/36e5)<23.9&&D>21)E=H(Z,(J=24-D,K=Z.getTime(),new Date(K-36e5*J))),A="24 hours of data is required for an accurate tdd calculation. Currently only "+D.toPrecision(3)+" hours of pump history data are available. Using your pump scheduled basals to fill in the missing hours. Scheduled basals added: "+E.toPrecision(5)+" U. ";else A=""}else console.log("Pumphistory is empty!");var J,K;for(let e=0;e<F.length;e++)"Bolus"==F[e]._type&&(j+=F[e].amount);for(let e=1;e<F.length;e++)if("TempBasal"==F[e]._type&&F[e].rate>0){P=e,W=F[e].rate;var Q=F[e-1]["duration (min)"]/60,V=Q,ee=new Date(F[e-1].timestamp),re=ee;do{if(e--,0==e){re=new Date;break}if("TempBasal"==F[e]._type||"PumpSuspend"==F[e]._type){re=new Date(F[e].timestamp);break}}while(e>0);var ae=(re-ee)/36e5;ae<V&&(Q=ae),k+=X(W*Q),e=P}for(let e=0;e<F.length;e++)if(0,0==F[e]["duration (min)"]||"PumpResume"==F[e]._type){let r=new Date(F[e].timestamp),a=r,t=e;do{if(t>0&&(--t,"TempBasal"==F[t]._type)){a=new Date(F[t].timestamp);break}}while(t>0);(a-r)/36e5>0&&(E+=H(a,r))}for(let e=F.length-1;e>0;e--)if("TempBasalDuration"==F[e]._type){let r=F[e]["duration (min)"]/60,a=new Date(F[e].timestamp);var te=a;let t=e;do{if(--t,t>=0&&("TempBasal"==F[t]._type||"PumpSuspend"==F[t]._type)){te=new Date(F[t].timestamp);break}}while(t>0);if(0==e&&"TempBasalDuration"==F[0]._type&&(te=new Date,r=F[e]["duration (min)"]/60),(te-a)/36e5-r>0){E+=H(te,L(a,r))}}var oe=T=j+k+E;D>21?(R=". Bolus insulin: "+j.toPrecision(5)+" U",U=". Temporary basal insulin: "+k.toPrecision(5)+" U",O=". Insulin with scheduled basal rate: "+E.toPrecision(5)+" U",A+("TDD past 24h is: "+T.toPrecision(5)+" U")+R+U+O,tddReason=", TDD, 24h: "+o(T,1)+", ytd: "+o(q,1)+", 7dØ: "+o(z,1)):tddReason=", TDD: Not enough pumpData (< 21h)";var ne={},ie=new Date;if(x&&(ie=x),void 0===v||void 0===v.current_basal)return ne.error="Error: could not get current basal rate",ne;var se=t(v.current_basal,v),le=se,ue=new Date;x&&(ue=x);var de,me=new Date(e.date),ce=o((ue-me)/60/1e3,1),pe=e.glucose,ge=e.noise;de=e.delta>-.5?"+"+o(e.delta,0):o(e.delta,0);var be=Math.min(e.delta,e.short_avgdelta),fe=Math.min(e.short_avgdelta,e.long_avgdelta),he=Math.max(e.delta,e.short_avgdelta,e.long_avgdelta);(pe<=10||38===pe||ge>=3)&&(ne.reason="CGM is calibrating, in ??? state, or noise is high");if(ce>12||ce<-5?ne.reason="If current system time "+ue+" is correct, then BG data is too old. The last BG data was read "+ce+"m ago at "+me:0===e.short_avgdelta&&0===e.long_avgdelta&&(e.last_cal&&e.last_cal<3?ne.reason="CGM was just calibrated":ne.reason="CGM data is unchanged ("+n(pe,v)+"+"+n(e.delta,v)+") for 5m w/ "+n(e.short_avgdelta,v)+" mg/dL ~15m change & "+n(e.long_avgdelta,v)+" mg/dL ~45m change"),pe<=10||38===pe||ge>=3||ce>12||ce<-5||0===e.short_avgdelta&&0===e.long_avgdelta)return r.rate>=le?(ne.reason+=". Canceling high temp basal of "+r.rate,ne.deliverAt=ie,ne.temp="absolute",ne.duration=0,ne.rate=0,ne):0===r.rate&&r.duration>30?(ne.reason+=". Shortening "+r.duration+"m long zero temp to 30m. ",ne.deliverAt=ie,ne.temp="absolute",ne.duration=30,ne.rate=0,ne):(ne.reason+=". Temp "+r.rate+" <= current basal "+le+"U/hr; doing nothing. ",ne);var ve,_e,Be,Me,Se=v.max_iob;if(void 0!==v.min_bg&&(_e=v.min_bg),void 0!==v.max_bg&&(Be=v.max_bg),void 0!==v.enableSMB_high_bg_target&&(Me=v.enableSMB_high_bg_target),void 0===v.min_bg||void 0===v.max_bg)return ne.error="Error: could not determine target_bg. ",ne;ve=(v.min_bg+v.max_bg)/2;var ye=v.exercise_mode||v.high_temptarget_raises_sensitivity,xe=100,Fe=160;if(v.half_basal_exercise_target&&(Fe=v.half_basal_exercise_target),ye&&v.temptargetSet&&ve>xe||v.low_temptarget_lowers_sensitivity&&v.temptargetSet&&ve<xe){var Ie=Fe-xe;sensitivityRatio=Ie*(Ie+ve-xe)<=0?v.autosens_max:Ie/(Ie+ve-xe),sensitivityRatio=Math.min(sensitivityRatio,v.autosens_max),sensitivityRatio=o(sensitivityRatio,2),process.stderr.write("Sensitivity ratio set to "+sensitivityRatio+" based on temp target of "+ve+"; ")}else void 0!==_&&_&&(sensitivityRatio=_.ratio,process.stderr.write("Autosens ratio: "+sensitivityRatio+"; "));if(sensitivityRatio&&(le=v.current_basal*sensitivityRatio,(le=t(le,v))!==se?process.stderr.write("Adjusting basal from "+se+" to "+le+"; "):process.stderr.write("Basal unchanged: "+le+"; ")),v.temptargetSet);else if(void 0!==_&&_&&(v.sensitivity_raises_target&&_.ratio<1||v.resistance_lowers_target&&_.ratio>1)){_e=o((_e-60)/_.ratio)+60,Be=o((Be-60)/_.ratio)+60;var we=o((ve-60)/_.ratio)+60;ve===(we=Math.max(80,we))?process.stderr.write("target_bg unchanged: "+we+"; "):process.stderr.write("target_bg from "+ve+" to "+we+"; "),ve=we}var Te=200,Ce=200,Ge=200;if(e.noise>=2){var De=Math.max(1.1,v.noisyCGMTargetMultiplier);Math.min(250,v.maxRaw);Te=o(Math.min(200,_e*De)),Ce=o(Math.min(200,ve*De)),Ge=o(Math.min(200,Be*De)),process.stderr.write("Raising target_bg for noisy / raw CGM data, from "+ve+" to "+Ce+"; "),_e=Te,ve=Ce,Be=Ge}var Oe=_e-.5*(_e-40),Re=o(v.sens,1),Ue=v.sens;void 0!==_&&_&&((Ue=o(Ue=v.sens/sensitivityRatio,1))!==Re?process.stderr.write("ISF from "+n(Re,v)+" to "+n(Ue,v)):process.stderr.write("ISF unchanged: "+n(Ue,v)),i+="Autosens, Ratio: "+sensitivityRatio+", ISF: "+n(Re,v)+"→"+n(Ue,v)),console.error("CR:"+v.carb_ratio),console.error("----------------------------------"),console.error(" start autoISF"),console.error("----------------------------------"),console.error("autoISFtimer start");var Ae=function(e,r,a){if(e.use_autoisf&&e.iob_threshold>0&&e.iob_threshold<r[0].iob)return s=", autoISF-SMB disabled:, IOB: "+o(r[0].iob,2)+", > threshold: "+e.iob_threshold+", maxIOB: "+e.max_iob,console.error(s),"iobTH";if(e.use_autoisf&&e.temptargetSet&&e.enableSMB_EvenOn_OddOff){var t=n(a,e);return e.temptargetSet?msgType="TempTarget ":msgType="profile target ","mmol/L"==e.out_units?(evenTarget=o(10*t,0)%2==0,msgUnits=" has ",msgTail=" decimal"):(evenTarget=t%2==0,msgUnits=" is ",msgTail=" number"),evenTarget?msgEven="even":msgEven="odd",evenTarget?(console.error("SMB enabled - "+msgType+t+msgUnits+msgEven+msgTail),e.temptargetSet&&a<100?(console.error("Full Loop enabled"),s=", autoISF-SMB enabled:, even TT","fullLoop"):(s=", autoISF-SMB enforced:, even TT","enforced")):(console.error("SMB disabled - "+msgType+t+msgUnits+msgEven+msgTail),s=", autoISF-SMB disabled:, odd TT","blocked")}return"oref"}(v,a,ve),Pe=!1;if(S&&"oref"!=Ae?("enforced"!=Ae&&"fullLoop"!=Ae||(Pe=!0),console.error("loopSMB function overriden with autoISF temptarget toggle, enableSMB = "+Pe)):(Pe=function(e,r,a,t,o,i){return r?!e.allowSMB_with_high_temptarget&&e.temptargetSet&&o>100?(console.error("SMB disabled due to high temptarget of "+o),!1):!0===a.bwFound&&!1===e.A52_risk_enable?(console.error("SMB disabled due to Bolus Wizard activity in the last 6 hours."),!1):!0===e.enableSMB_always?(a.bwFound?console.error("Warning: SMB enabled within 6h of using Bolus Wizard: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled due to enableSMB_always"),!0):!0===e.enableSMB_with_COB&&a.mealCOB?(a.bwCarbs?console.error("Warning: SMB enabled with Bolus Wizard carbs: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled for COB of",a.mealCOB),!0):!0===e.enableSMB_after_carbs&&a.carbs?(a.bwCarbs?console.error("Warning: SMB enabled with Bolus Wizard carbs: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled for 6h after carb entry"),!0):!0===e.enableSMB_with_temptarget&&e.temptargetSet&&o<100?(a.bwFound?console.error("Warning: SMB enabled within 6h of using Bolus Wizard: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled for temptarget of",n(o,e)),console.error("SMB enabled for temptargets with "+n(o,e)),!0):!0===e.enableSMB_high_bg&&null!==i&&t>=i?(console.error("Checking BG to see if High for SMB enablement."),console.error("Current BG",t," | High BG ",i),a.bwFound?console.error("Warning: High BG SMB enabled within 6h of using Bolus Wizard: be sure to easy bolus 30s before using Bolus Wizard"):console.error("High BG detected. Enabling SMB."),!0):(console.error("SMB disabled (no enableSMB preferences active or no condition satisfied)"),!1):(console.error("SMB disabled (!microBolusAllowed)"),!1)}(v,S,B,pe,ve,Me),console.error("loopSMB function returns enableSMB = "+Pe)),Ue=function(e,r,a,t,v,_,B,M){if(!a.use_autoisf)return console.error("autoISF disabled in Preferences"),i+=", autoISF, disabled",e;if(a.autoISF_off_Sport&&(a.high_temptarget_raises_sensitivity||a.exercise_mode)&&a.temptargetSet&&r>M)return console.error("autoISF disabled due to exercise"),i+=", autoISF, disabled (exercise)",e;const S=t.dura_p,y=t.delta_pl,x=t.delta_pn,F=t.r_squ,I=t.bg_acceleration,w=t.a_0,T=t.a_1,C=t.a_2,G=t.dura_ISF_minutes,D=t.dura_ISF_average;var O=!1,R=e,U=1,A=1,P=1,k=r+10-D;if(v.mealCOB>0&&!a.enableautoisf_with_COB)return console.error("BG dependant autoISF by-passed; preferences disabled mealCOB of "+o(v.mealCOB,1)),i+=", autoISF, disabled with COB",e;var j=t.pp_debug;if(m+="BG-accel: "+o(I,3)+", PF-minutes: "+S+", PF-corr: "+o(F,4)+", PF-nextDelta: "+n(x,a)+", PF-lastDelta: "+n(y,a)+", regular Delta: "+n(t.delta,a),console.error(j+m+" , Weights Accel/Brake: "+a.bgAccel_ISF_weight+" / "+a.bgBrake_ISF_weight),a.enable_BG_acceleration){var E=F,W=I;if(0!=t.parabola_fit_a2&&E>=.9){var q=-T/2/C*5,z=o(w-q*q/25*C,1);(q=o(q,1))>0&&W<0?(g="predicts a Max of "+n(z,a)+", in about "+Math.abs(q)+"min",console.error("Parabolic fit "+g)):q>0&&W>0?(g="predicts a Min of "+n(z,a)+", in about "+Math.abs(q)+"min",console.error("Parabolic fit "+g)):q<0&&W<0?(g="saw Max of "+n(z,a)+", about "+Math.abs(q)+"min ago",console.error("Parabolic fit "+g)):q<0&&W>0&&(g="saw Min of "+n(z,a)+", about "+Math.abs(q)+"min ago",console.error("Parabolic fit "+g))}if(E<.9)g="acce_ISF by-passed, as correlation, "+o(E,2)+", is too low",console.error("Parabolic fit "+g),c+=", Parabolic Fit, "+g;else{var L=10*(E-.9),X=1,Y=1;t.glucose<a.target_bg?W>0?(W>1&&(X=.5),Y=a.bgBrake_ISF_weight):W<0&&(Y=a.bgAccel_ISF_weight):W<0?Y=a.bgBrake_ISF_weight:W>0&&(Y=a.bgAccel_ISF_weight),(P=1+W*X*Y*L)<0&&(P=.1),console.error(c+" acce_ISF adaptation is "+o(P,2)),1!=P&&(O=!0,c+=", Parabolic Fit, "+g+", acce-ISF Ratio: "+o(P,2))}}else console.error("autoISF BG accelertion adaption disabled in Preferences");i+=s+c+", autoISF";var N=1+f(100-k,a,"bg");console.error("bg_ISF adaptation is "+o(N,2));var H=1,Z=1;if(N<1)return H=Math.min(N,P),P>1?(p="bg-ISF adaptation lifted to "+o(H=N*P,2)+", as BG accelerates already",console.error(p),i+=", bg-ISF Ratio: "+o(H,2)+"(accel.)"):i+=", bg-ISF Ratio: "+o(H,2),Z=h(H,a.autoISF_min,a.autoISF_max,B),R=(a.high_temptarget_raises_sensitivity||a.exercise_mode)&&a.temptargetSet&&r>M?Math.min(720,o(e/Z,1)):Math.min(720,o(a.sens/Z,1)),i+=u+d+l+", final Ratio: "+o(Z,2)+b+", final ISF: "+n(R,a),R;N>1&&(O=!0,i+=", bg-ISF Ratio: "+o(N,2));var $=t.delta;a.enablepp_ISF_always||a.pp_ISF_hours>=(_-v.lastCarbTime)/1e3/3600?deltaType="pp":deltaType="delta",k>0?console.error(deltaType+"_ISF adaptation by-passed as average glucose < "+r+"+10"):t.short_avgdelta<0?console.error(deltaType+"_ISF adaptation by-passed as no rise or too short lived"):"pp"==deltaType?(U=1+Math.max(0,$*a.pp_ISF_weight),console.error("pp_ISF adaptation is "+o(U,2)),u=", pp-ISF Ratio: "+o(U,2),1!=U&&(O=!0)):(A=f($,a,"delta"),k>-20&&(A*=.5),A=1+A,console.error("delta_ISF adaptation is "+o(A,2)),d=", Δ-ISF Ratio: "+o(A,2),1!=A&&(O=!0));var J=1,K=a.dura_ISF_weight;v.mealCOB>0&&!a.enableautoisf_with_COB?console.error("dura_ISF by-passed; preferences disabled mealCOB of "+o(v.mealCOB,1)):G<10?console.error("dura_ISF by-passed; BG is only "+G+"m at level "+D):D<=r?console.error("dura_ISF by-passed; avg. glucose "+D+" below target "+n(r,a)):(J+=G/60*(K/r)*(D-r),O=!0,l=", Duration: "+G+", Avg: "+n(D,a)+", dura-ISF Ratio: "+o(J,2),console.error("dura_ISF adaptation is "+o(J,2)+" because ISF "+e+" did not do it for "+o(G,1)+"m"));return O?(H=Math.max(J,N,A,P,U),console.error("autoISF adaption ratios:"),console.error("  dura "+o(J,2)),console.error("  bg "+o(N,2)),console.error("  delta "+o(A,2)),console.error("  pp "+o(U,2)),console.error("  accel "+o(P,2)),P<1&&(p="strongest ISF factor "+o(H,2)+" weakened to "+o(H*P,2)+" as bg decelerates already",console.error(p),H*=P),Z=h(H,a.autoISF_min,a.autoISF_max,B),(a.high_temptarget_raises_sensitivity||a.exercise_mode)&&a.temptargetSet&&r>M?(R=o(e/Z,1),console.error("autoISF adjusts sens "+R+", instead of profile.sens "+a.sens)):R=o(a.sens/Z,1),i+=u+d+l+", final Ratio: "+o(Z,2)+b+", final ISF: "+n(R,a),R):(i+=", not modified",console.error("autoISF does not modify"),R)}(Ue,ve,v,e,B,x,sensitivityRatio,xe),console.error("autoISFtimer end"),console.error("----------------------------------"),console.error(" end autoISF"),console.error("----------------------------------"),void 0===a)return ne.error="Error: iob_data undefined. ",ne;var ke,je=a;if(a.length,a.length>1&&(a=je[0]),void 0===a.activity||void 0===a.iob)return ne.error="Error: iob_data missing some property. ",ne;var Ee=((ke=void 0!==a.lastTemp?o((new Date(ue).getTime()-a.lastTemp.date)/6e4):0)+r.duration)%30;if(console.error("currenttemp:"+r.rate+" lastTempAge:"+ke+"m, tempModulus:"+Ee+"m"),ne.temp="absolute",ne.deliverAt=ie,S&&r&&a.lastTemp&&r.rate!==a.lastTemp.rate&&ke>10&&r.duration)return ne.reason="Warning: currenttemp rate "+r.rate+" != lastTemp rate "+a.lastTemp.rate+" from pumphistory; canceling temp",M.setTempBasal(0,0,v,ne,r);if(r&&a.lastTemp&&r.duration>0){var We=ke-a.lastTemp.duration;if(We>5&&ke>10)return ne.reason="Warning: currenttemp running but lastTemp from pumphistory ended "+We+"m ago; canceling temp",M.setTempBasal(0,0,v,ne,r)}var qe=o(-a.activity*Ue*5,2),ze=o(6*(be-qe));ze<0&&(ze=o(6*(fe-qe)))<0&&(ze=o(6*(e.long_avgdelta-qe)));var Le=pe,Xe=(Le=a.iob>0?o(pe-a.iob*Ue):o(pe-a.iob*Math.min(Ue,v.sens)))+ze;if(void 0===Xe||isNaN(Xe))return ne.error="Error: could not calculate eventualBG. Sensitivity: "+Ue+" Deviation: "+ze,ne;var Ye=function(e,r,a){return o(a+(e-r)/24,1)}(ve,Xe,qe);ne={temp:"absolute",bg:n(pe,v),tick:de,eventualBG:n(Xe,v),insulinReq:0,reservoir:y,deliverAt:ie,sensitivityRatio};var Ne=[],He=[],Ze=[],$e=[];Ne.push(pe),He.push(pe),$e.push(pe),Ze.push(pe);var Je=v.enableUAM,Ke=0,Qe=0;Ke=o(be-qe,1);var Ve=o(be-qe,1);csf=Ue/v.carb_ratio,console.error("profile.sens:"+n(v.sens,v)+", sens:"+n(Ue,v)+", CSF:"+o(csf,1));var er=o(30*csf*5/60,1);Ke>er&&(console.error("Limiting carb impact from "+Ke+" to "+er+"mg/dL/5m (30g/h)"),Ke=er);var rr=3;sensitivityRatio&&(rr/=sensitivityRatio);var ar=rr;if(B.carbs){rr=Math.max(rr,B.mealCOB/20);var tr=o((new Date(ue).getTime()-B.lastCarbTime)/6e4),or=(B.carbs-B.mealCOB)/B.carbs;ar=o(ar=rr+1.5*tr/60,1),console.error("Last carbs "+tr+" minutes ago; remainingCATime:"+ar+"hours; "+o(100*or)+"% carbs absorbed")}var nr=Math.max(0,Ke/5*60*ar/2)/csf,ir=90,sr=1;v.remainingCarbsCap&&(ir=Math.min(90,v.remainingCarbsCap)),v.remainingCarbsFraction&&(sr=Math.min(1,v.remainingCarbsFraction));var lr=1-sr,ur=Math.max(0,B.mealCOB-nr-B.carbs*lr),dr=(ur=Math.min(ir,ur))*csf*5/60/(ar/2),mr=o(B.slopeFromMaxDeviation,2),cr=o(B.slopeFromMinDeviation,2),pr=Math.min(mr,-cr/3),gr=0;0===Ke?Qe=0:!0===v.floating_carbs?(Qe=Math.min(60*ar/5/2,Math.max(0,B.carbs*csf/Ke)),gr=Math.min(60*ar/5/2,Math.max(0,B.mealCOB*csf/Ke)),B.carbs>0&&(i+=", Floating Carbs:, CID: "+o(Qe,1)+", MealCarbs: "+o(B.carbs,1)+", Not Floating:, CID: "+o(gr,1)+", MealCOB: "+o(B.mealCOB,1),console.error("Floating Carbs CID: "+o(Qe,1)+" / MealCarbs: "+o(B.carbs,1)+" vs. Not Floating:"+o(gr,1)+" / MealCOB:"+o(B.mealCOB,1)))):Qe=Math.min(60*ar/5/2,Math.max(0,B.mealCOB*csf/Ke)),console.error("Carb Impact:"+Ke+"mg/dL per 5m; CI Duration:"+o(5*Qe/60*2,1)+"hours; remaining CI ("+ar/2+"h peak):",o(dr,1)+"mg/dL per 5m");var br,fr,hr,vr,_r,Br=999,Mr=999,Sr=999,yr=pe,xr=999,Fr=999,Ir=999,wr=999,Tr=Xe,Cr=pe,Gr=pe,Dr=0,Or=[],Rr=[];try{je.forEach((function(e){var r=o(-e.activity*Ue*5,2),a=o(-e.iobWithZeroTemp.activity*Ue*5,2),t=Ke*(1-Math.min(1,He.length/12));Tr=He[He.length-1]+r+t;var n=$e[$e.length-1]+a,i=Math.max(0,Math.max(0,Ke)*(1-Ne.length/Math.max(2*Qe,1))),s=Math.min(Ne.length,12*ar-Ne.length),l=Math.max(0,s/(ar/2*12)*dr);i+l,Or.push(o(l,0)),Rr.push(o(i,0)),COBpredBG=Ne[Ne.length-1]+r+Math.min(0,t)+i+l;var u=Math.max(0,Ve+Ze.length*pr),d=Math.max(0,Ve*(1-Ze.length/Math.max(36,1))),m=Math.min(u,d);m>0&&(Dr=o(5*(Ze.length+1)/60,1)),UAMpredBG=Ze[Ze.length-1]+r+Math.min(0,t)+m,He.length<48&&He.push(Tr),Ne.length<48&&Ne.push(COBpredBG),Ze.length<48&&Ze.push(UAMpredBG),$e.length<48&&$e.push(n),COBpredBG<xr&&(xr=o(COBpredBG)),UAMpredBG<Fr&&(Fr=o(UAMpredBG)),Tr<Ir&&(Ir=o(Tr)),n<wr&&(wr=o(n));He.length>18&&Tr<Br&&(Br=o(Tr)),Tr>Cr&&(Cr=Tr),(Qe||dr>0)&&Ne.length>18&&COBpredBG<Mr&&(Mr=o(COBpredBG)),(Qe||dr>0)&&COBpredBG>Cr&&(Gr=COBpredBG),Je&&Ze.length>12&&UAMpredBG<Sr&&(Sr=o(UAMpredBG)),Je&&UAMpredBG>Cr&&UAMpredBG}))}catch(e){console.error("Problem with iobArray.  Optional feature Advanced Meal Assist disabled")}ne.predBGs={},He.forEach((function(e,r,a){a[r]=o(Math.min(401,Math.max(39,e)))}));for(var Ur=He.length-1;Ur>12&&He[Ur-1]===He[Ur];Ur--)He.pop();for(ne.predBGs.IOB=He,hr=o(He[He.length-1]),$e.forEach((function(e,r,a){a[r]=o(Math.min(401,Math.max(39,e)))})),Ur=$e.length-1;Ur>6&&!($e[Ur-1]>=$e[Ur]||$e[Ur]<=ve);Ur--)$e.pop();if(ne.predBGs.ZT=$e,o($e[$e.length-1]),B.mealCOB>0&&(Ke>0||dr>0)){for(Ne.forEach((function(e,r,a){a[r]=o(Math.min(401,Math.max(39,e)))})),Ur=Ne.length-1;Ur>12&&Ne[Ur-1]===Ne[Ur];Ur--)Ne.pop();ne.predBGs.COB=n(Ne,v),vr=o(Ne[Ne.length-1]),Xe=Math.max(Xe,o(Ne[Ne.length-1]))}if(Ke>0||dr>0){if(Je){for(Ze.forEach((function(e,r,a){a[r]=o(Math.min(401,Math.max(39,e)))})),Ur=Ze.length-1;Ur>12&&Ze[Ur-1]===Ze[Ur];Ur--)Ze.pop();ne.predBGs.UAM=n(Ze,v),_r=o(Ze[Ze.length-1]),Ze[Ze.length-1]&&(Xe=Math.max(Xe,o(Ze[Ze.length-1])))}ne.eventualBG=n(Xe,v)}console.error("UAM Impact:"+Ve+"mg/dL per 5m; UAM Duration:"+Dr+"hours"),Br=Math.max(39,Br),Mr=Math.max(39,Mr),Sr=Math.max(39,Sr),br=o(Br);var Ar=B.mealCOB/B.carbs;fr=o(Sr<999&&Mr<999?(1-Ar)*UAMpredBG+Ar*COBpredBG:Mr<999?(Tr+COBpredBG)/2:Sr<999?(Tr+UAMpredBG)/2:Tr),wr>fr&&(fr=wr),yr=o(yr=Qe||dr>0?Je?Ar*xr+(1-Ar)*Fr:xr:Je?Fr:Ir);var Pr=Sr;if(wr<Oe)Pr=(Sr+wr)/2;else if(wr<ve){var kr=(wr-Oe)/(ve-Oe);Pr=(Sr+(Sr*kr+wr*(1-kr)))/2}else wr>Sr&&(Pr=(Sr+wr)/2);if(Pr=o(Pr),B.carbs)if(!Je&&Mr<999)br=o(Math.max(Br,Mr));else if(Mr<999){var jr=Ar*Mr+(1-Ar)*Pr;br=o(Math.max(Br,Mr,jr))}else br=Je?Pr:yr;else Je&&(br=o(Math.max(Br,Pr)));br=Math.min(br,fr),process.stderr.write("minPredBG: "+n(br,v)+" minIOBPredBG: "+n(Br,v)+" minZTGuardBG: "+n(wr,v)),Mr<999&&process.stderr.write(" minCOBPredBG: "+n(Mr,v)),Sr<999&&process.stderr.write(" minUAMPredBG: "+n(Sr,v)),console.error(" avgPredBG:"+n(fr,v)+" COB/Carbs:"+B.mealCOB+"/"+B.carbs),Gr>pe&&(br=Math.min(br,Gr)),ne.COB=B.mealCOB,ne.IOB=a.iob,ne.BGI=n(qe,v),ne.deviation=n(ze,v),ne.ISF=n(Ue,v),ne.CR=o(v.carb_ratio,2),ne.TDD=o(oe,1),ne.TDDytd=o(q,1),ne.TDD7d=o(z,1),ne.target_bg=n(ve,v);var Er=function(e,r,a,t){if(!e.use_autoisf)return console.error("autoISF disabled, don't adjust SMB Delivery Ratio"),.5;if(0===e.smb_delivery_ratio_bg_range||"fullLoop"===t)return console.error("SMB delivery ratio set to fixed value "+e.smb_delivery_ratio),e.smb_delivery_ratio;var n=Math.min(e.smb_delivery_ratio_min,e.smb_delivery_ratio_max);if(r<=a)return console.error("SMB delivery ratio limited by minimum value "+n),n;var i=Math.max(e.smb_delivery_ratio_min,e.smb_delivery_ratio_max);if(r>=a+e.smb_delivery_ratio_bg_range)return console.error("SMB delivery ratio limited by maximum value "+i),i;var s=n+(i-n)*(r-a)/e.smb_delivery_ratio_bg_range;return console.error("SMB delivery ratio set to interpolated value "+o(s,2)),s}(v,pe,ve,Ae),Wr="SMB Ratio:, "+o(Er,2)+", ";ne.reason=Wr+i+", Standard, COB: "+ne.COB+", Dev: "+ne.deviation+", BGI: "+ne.BGI+", ISF: "+ne.ISF+", CR: "+ne.CR+", Target: "+ne.target_bg+", minPredBG "+n(br,v)+", minGuardBG "+n(yr,v)+", IOBpredBG "+n(hr,v),vr>0&&(ne.reason+=", COBpredBG "+n(vr,v)),_r>0&&(ne.reason+=", UAMpredBG "+n(_r,v)),ne.reason+=tddReason,ne.reason+="; ";var qr=Le;qr<40&&(qr=Math.min(yr,qr));var zr=Oe-qr,Lr=240,Xr=240;if(B.mealCOB>0&&(Ke>0||dr>0)){for(Ur=0;Ur<Ne.length;Ur++)if(Ne[Ur]<_e){Lr=5*Ur;break}for(Ur=0;Ur<Ne.length;Ur++)if(Ne[Ur]<Oe){Xr=5*Ur;break}}else{for(Ur=0;Ur<He.length;Ur++)if(He[Ur]<_e){Lr=5*Ur;break}for(Ur=0;Ur<He.length;Ur++)if(He[Ur]<Oe){Xr=5*Ur;break}}Pe&&yr<Oe&&(console.error("minGuardBG "+n(yr,v)+" projected below "+n(Oe,v)+" - disabling SMB"),Pe=!1);var Yr=.2;void 0!==v.maxDelta_bg_threshold&&"fullLoop"==Ae&&(Yr=Math.min(v.maxDelta_bg_threshold,.4)),he>Yr*pe&&(console.error("maxDelta "+n(he,v)+" > "+100*Yr+"% of BG "+n(pe,v)+" - disabling SMB"),ne.reason+="maxDelta "+n(he,v)+" > "+100*Yr+"% of BG "+n(pe,v)+" - SMB disabled!, ",Pe=!1),console.error("BG projected to remain above "+n(_e,v)+" for "+Lr+"minutes"),(Xr<240||Lr<60)&&console.error("BG projected to remain above "+n(Oe,v)+" for "+Xr+"minutes");var Nr=Xr,Hr=v.current_basal*Ue*Nr/60,Zr=Math.max(0,B.mealCOB-.25*B.carbs),$r=(zr-Hr)/csf-Zr;Hr=o(Hr),$r=o($r),console.error("naive_eventualBG:",Le,"bgUndershoot:",zr,"zeroTempDuration:",Nr,"zeroTempEffect:",Hr,"carbsReq:",$r),"Could not parse clock data"==B.reason?console.error("carbsReq unknown: Could not parse clock data"):$r>=v.carbsReqThreshold&&Xr<=45&&(ne.carbsReq=$r,ne.reason+=$r+" add'l carbs req w/in "+Xr+"m; ");var Jr=0;if(pe<Oe&&a.iob<20*-v.current_basal/60&&be>0&&be>Ye)ne.reason+="IOB "+a.iob+" < "+o(20*-v.current_basal/60,2),ne.reason+=" and minDelta "+n(be,v)+" > expectedDelta "+n(Ye,v)+"; ";else if(pe<Oe||yr<Oe)return ne.reason+="minGuardBG "+n(yr,v)+"<"+n(Oe,v),Jr=o(60*((zr=ve-yr)/Ue)/v.current_basal),Jr=30*o(Jr/30),Jr=Math.min(120,Math.max(30,Jr)),M.setTempBasal(0,Jr,v,ne,r);if(v.skip_neutral_temps&&ne.deliverAt.getMinutes()>=55)return ne.reason+="; Canceling temp at "+ne.deliverAt.getMinutes()+"m past the hour. ",M.setTempBasal(0,0,v,ne,r);var Kr=0,Qr=le;if(Xe<_e){if(ne.reason+="Eventual BG "+n(Xe,v)+" < "+n(_e,v),be>Ye&&be>0&&!$r)return Le<40?(ne.reason+=", naive_eventualBG < 40. ",M.setTempBasal(0,30,v,ne,r)):(e.delta>be?ne.reason+=", but Delta "+n(de,v)+" > expectedDelta "+n(Ye,v):ne.reason+=", but Min. Delta "+be.toFixed(2)+" > Exp. Delta "+n(Ye,v),r.duration>15&&t(le,v)===t(r.rate,v)?(ne.reason+=", temp "+r.rate+" ~ req "+le+"U/hr. ",ne):(ne.reason+="; setting current basal of "+le+" as temp. ",M.setTempBasal(le,30,v,ne,r)));Kr=o(Kr=2*Math.min(0,(Xe-ve)/Ue),2);var Vr=Math.min(0,(Le-ve)/Ue);if(Vr=o(Vr,2),be<0&&be>Ye)Kr=o(Kr*(be/Ye),2);if(Qr=t(Qr=le+2*Kr,v),r.duration*(r.rate-le)/60<Math.min(Kr,Vr)-.3*le)return ne.reason+=", "+r.duration+"m@"+r.rate.toFixed(2)+" is a lot less than needed. ",M.setTempBasal(Qr,30,v,ne,r);if(void 0!==r.rate&&r.duration>5&&Qr>=.8*r.rate)return ne.reason+=", temp "+r.rate+" ~< req "+Qr+"U/hr. ",ne;if(Qr<=0){if((Jr=o(60*((zr=ve-Le)/Ue)/v.current_basal))<0?Jr=0:(Jr=30*o(Jr/30),Jr=Math.min(120,Math.max(0,Jr))),Jr>0)return ne.reason+=", setting "+Jr+"m zero temp. ",M.setTempBasal(Qr,Jr,v,ne,r)}else ne.reason+=", setting "+Qr+"U/hr. ";return M.setTempBasal(Qr,30,v,ne,r)}if(be<Ye&&(!S||!Pe))return e.delta<be?ne.reason+="Eventual BG "+n(Xe,v)+" > "+n(_e,v)+" but Delta "+n(de,v)+" < Exp. Delta "+n(Ye,v):ne.reason+="Eventual BG "+n(Xe,v)+" > "+n(_e,v)+" but Min. Delta "+be.toFixed(2)+" < Exp. Delta "+n(Ye,v),r.duration>15&&t(le,v)===t(r.rate,v)?(ne.reason+=", temp "+r.rate+" ~ req "+le+"U/hr. ",ne):(ne.reason+="; setting current basal of "+le+" as temp. ",M.setTempBasal(le,30,v,ne,r));if(Math.min(Xe,br)<Be&&(!S||!Pe))return ne.reason+=n(Xe,v)+"-"+n(br,v)+" in range: no temp required",r.duration>15&&t(le,v)===t(r.rate,v)?(ne.reason+=", temp "+r.rate+" ~ req "+le+"U/hr. ",ne):(ne.reason+="; setting current basal of "+le+" as temp. ",M.setTempBasal(le,30,v,ne,r));if(Xe>=Be&&(ne.reason+="Eventual BG "+n(Xe,v)+" >= "+n(Be,v)+", "),a.iob>Se)return ne.reason+="IOB "+o(a.iob,2)+" > max_iob "+Se,r.duration>15&&t(le,v)===t(r.rate,v)?(ne.reason+=", temp "+r.rate+" ~ req "+le+"U/hr. ",ne):(ne.reason+="; setting current basal of "+le+" as temp. ",M.setTempBasal(le,30,v,ne,r));(Kr=o((Math.min(br,Xe)-ve)/Ue,2))>Se-a.iob&&(ne.reason+="max_iob "+Se+", ",Kr=Se-a.iob),Qr=t(Qr=le+2*Kr,v),Kr=o(Kr,3),ne.insulinReq=Kr;var ea=o((new Date(ue).getTime()-a.lastBolusTime)/6e4,1);if(S&&Pe&&pe>Oe){var ra=o(B.mealCOB/v.carb_ratio,3);if(v.use_autoisf)aa=v.smb_max_range_extension;else{console.error("autoISF disabled, SMB range extension disabled");var aa=1}aa>1&&console.error("SMB max range extended from default by factor "+aa);var ta=0;void 0===v.maxSMBBasalMinutes?(ta=o(aa*v.current_basal*30/60,1),console.error("profile.maxSMBBasalMinutes undefined: defaulting to 30m")):a.iob>ra&&a.iob>0?(console.error("IOB",a.iob,"> COB",B.mealCOB+"; mealInsulinReq =",ra),v.maxUAMSMBBasalMinutes?(console.error("profile.maxUAMSMBBasalMinutes:",v.maxUAMSMBBasalMinutes,"profile.current_basal:",v.current_basal),ta=o(aa*v.current_basal*v.maxUAMSMBBasalMinutes/60,1)):(console.error("profile.maxUAMSMBBasalMinutes undefined: defaulting to 30m"),ta=o(30*v.current_basal/60,1))):(console.error("profile.maxSMBBasalMinutes:",v.maxSMBBasalMinutes,"profile.current_basal:",v.current_basal),ta=o(aa*v.current_basal*v.maxSMBBasalMinutes/60,1));var oa=v.bolus_increment,na=1/oa;v.use_autoisf||(console.error("autoISF disabled, don't adjust SMB Delivery Ratio"),Er=.5),Er>.5&&console.error("SMB Delivery Ratio increased from default 0.5 to "+o(Er,2));var ia=Math.min(Kr*Er,ta);ia=Math.floor(ia*na)/na,Jr=o(60*((ve-(Le+Br)/2)/Ue)/v.current_basal),Kr>0&&ia<oa&&(Jr=0);var sa=0;Jr<=0?Jr=0:Jr>=30?(Jr=30*o(Jr/30),Jr=Math.min(60,Math.max(0,Jr))):(sa=o(le*Jr/30,2),Jr=30),ne.reason+=" insulinReq "+Kr,ia>=ta&&(ne.reason+="; maxBolus "+ta),Jr>0&&(ne.reason+="; setting "+Jr+"m low temp of "+sa+"U/h"),ne.reason+=". ";var la=3;v.SMBInterval&&(la=Math.min(10,Math.max(1,v.SMBInterval)));var ua=o(la-ea,0),da=o(60*(la-ea),0)%60;if(console.error("naive_eventualBG",Le+",",Jr+"m "+sa+"U/h temp needed; last bolus",ea+"m ago; maxBolus: "+ta),ea>la?ia>0&&(ne.units=ia,ne.reason+="Microbolusing "+ia+"U. "):ne.reason+="Waiting "+ua+"m "+da+"s to microbolus again. ",Jr>0)return ne.rate=sa,ne.duration=Jr,ne}var ma=M.getMaxSafeBasal(v);return Qr>ma&&(ne.reason+="adj. req. rate: "+o(Qr,2)+" to maxSafeBasal: "+o(ma,2)+", ",Qr=t(ma,v)),r.duration*(r.rate-le)/60>=2*Kr?(ne.reason+=r.duration+"m@"+r.rate.toFixed(2)+" > 2 * insulinReq. Setting temp basal of "+Qr+"U/hr. ",M.setTempBasal(Qr,30,v,ne,r)):void 0===r.duration||0===r.duration?(ne.reason+="no temp, setting "+Qr+"U/hr. ",M.setTempBasal(Qr,30,v,ne,r)):r.duration>5&&t(Qr,v)<=t(r.rate,v)?(ne.reason+="temp "+r.rate+" >~ req "+Qr+"U/hr. ",ne):(ne.reason+="temp "+r.rate+"<"+Qr+"U/hr. ",M.setTempBasal(Qr,30,v,ne,r))}},6880:(e,r,a)=>{var t=a(6654);e.exports=function(e,r){var a=20;void 0!==r&&"string"==typeof r.model&&(t(r.model,"54")||t(r.model,"23"))&&(a=40);return e<1?Math.round(e*a)/a:e<10?Math.round(20*e)/20:Math.round(10*e)/10}},2705:(e,r,a)=>{var t=a(5639).Symbol;e.exports=t},9932:e=>{e.exports=function(e,r){for(var a=-1,t=null==e?0:e.length,o=Array(t);++a<t;)o[a]=r(e[a],a,e);return o}},9750:e=>{e.exports=function(e,r,a){return e==e&&(void 0!==a&&(e=e<=a?e:a),void 0!==r&&(e=e>=r?e:r)),e}},4239:(e,r,a)=>{var t=a(2705),o=a(9607),n=a(2333),i=t?t.toStringTag:void 0;e.exports=function(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":i&&i in Object(e)?o(e):n(e)}},531:(e,r,a)=>{var t=a(2705),o=a(9932),n=a(1469),i=a(3448),s=t?t.prototype:void 0,l=s?s.toString:void 0;e.exports=function e(r){if("string"==typeof r)return r;if(n(r))return o(r,e)+"";if(i(r))return l?l.call(r):"";var a=r+"";return"0"==a&&1/r==-Infinity?"-0":a}},7561:(e,r,a)=>{var t=a(7990),o=/^\s+/;e.exports=function(e){return e?e.slice(0,t(e)+1).replace(o,""):e}},1957:(e,r,a)=>{var t="object"==typeof a.g&&a.g&&a.g.Object===Object&&a.g;e.exports=t},9607:(e,r,a)=>{var t=a(2705),o=Object.prototype,n=o.hasOwnProperty,i=o.toString,s=t?t.toStringTag:void 0;e.exports=function(e){var r=n.call(e,s),a=e[s];try{e[s]=void 0;var t=!0}catch(e){}var o=i.call(e);return t&&(r?e[s]=a:delete e[s]),o}},2333:e=>{var r=Object.prototype.toString;e.exports=function(e){return r.call(e)}},5639:(e,r,a)=>{var t=a(1957),o="object"==typeof self&&self&&self.Object===Object&&self,n=t||o||Function("return this")();e.exports=n},7990:e=>{var r=/\s/;e.exports=function(e){for(var a=e.length;a--&&r.test(e.charAt(a)););return a}},6654:(e,r,a)=>{var t=a(9750),o=a(531),n=a(554),i=a(9833);e.exports=function(e,r,a){e=i(e),r=o(r);var s=e.length,l=a=void 0===a?s:t(n(a),0,s);return(a-=r.length)>=0&&e.slice(a,l)==r}},1469:e=>{var r=Array.isArray;e.exports=r},3218:e=>{e.exports=function(e){var r=typeof e;return null!=e&&("object"==r||"function"==r)}},7005:e=>{e.exports=function(e){return null!=e&&"object"==typeof e}},3448:(e,r,a)=>{var t=a(4239),o=a(7005);e.exports=function(e){return"symbol"==typeof e||o(e)&&"[object Symbol]"==t(e)}},8601:(e,r,a)=>{var t=a(4841),o=1/0;e.exports=function(e){return e?(e=t(e))===o||e===-1/0?17976931348623157e292*(e<0?-1:1):e==e?e:0:0===e?e:0}},554:(e,r,a)=>{var t=a(8601);e.exports=function(e){var r=t(e),a=r%1;return r==r?a?r-a:r:0}},4841:(e,r,a)=>{var t=a(7561),o=a(3218),n=a(3448),i=/^[-+]0x[0-9a-f]+$/i,s=/^0b[01]+$/i,l=/^0o[0-7]+$/i,u=parseInt;e.exports=function(e){if("number"==typeof e)return e;if(n(e))return NaN;if(o(e)){var r="function"==typeof e.valueOf?e.valueOf():e;e=o(r)?r+"":r}if("string"!=typeof e)return 0===e?e:+e;e=t(e);var a=s.test(e);return a||l.test(e)?u(e.slice(2),a?2:8):i.test(e)?NaN:+e}},9833:(e,r,a)=>{var t=a(531);e.exports=function(e){return null==e?"":t(e)}}},r={};function a(t){var o=r[t];if(void 0!==o)return o.exports;var n=r[t]={exports:{}};return e[t](n,n.exports,a),n.exports}a.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}();var t=a(5546);freeaps_determineBasal=t})();