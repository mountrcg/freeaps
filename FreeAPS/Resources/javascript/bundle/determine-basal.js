var freeaps_determineBasal;(()=>{var e={5546:(e,r,a)=>{var t=a(6880);function o(e,r){r||(r=0);var a=Math.pow(10,r);return Math.round(e*a)/a}function n(e,r){return"mmol/L"===r.out_units?o(e/18,1):Math.round(e)}var i="",s="",l="",u="",d="",m="",c="",g="",b="",f="";function p(e,r){var a=[2,7,12,16,20,50,60,80,90,100,110,150,180,200],t=[0,0,.4,.7,.7,-.5,-.5,-.3,-.2,0,0,.5,.7,.7],o=a.length-1,n=a[0],i=t[0],s=a[o],l=t[o],u=1,d=1,m=1,c=n;if(n>e)u=(d=i)+((l=t[1])-d)/((s=a[1])-(m=n))*(e-m);else if(s<e)u=(d=i=t[o-1])+(l-d)/(s-(m=n=a[o-1]))*(e-m);else for(var g=0;g<=o;g++){if(i=t[g],(n=a[g])==e){u=i;break}if(n>e){u=d+(i-d)/(n-(m=c))*(e-m);break}d=i,c=n}return u*=e>100?r.higher_ISFrange_weight:e>40?r.lower_ISFrange_weight:r.delta_ISFrange_weight}function h(e,r,a){if(void 0===e.smb_delivery_ratio_bg_range||0===e.smb_delivery_ratio_bg_range)return console.error("SMB delivery ratio set to fixed value "+e.smb_delivery_ratio),e.smb_delivery_ratio;var t=Math.min(e.smb_delivery_ratio_min,e.smb_delivery_ratio_max);if(r<=a)return console.error("SMB delivery ratio limited by minimum value "+t),t;var n=Math.max(e.smb_delivery_ratio_min,e.smb_delivery_ratio_max);if(r>=a+e.smb_delivery_ratio_bg_range)return console.error("SMB delivery ratio limited by maximum value "+n),n;var i=t+(n-t)*(r-a)/e.smb_delivery_ratio_bg_range;return console.error("SMB delivery ratio set to interpolated value "+o(i,2)),i}e.exports=function(e,r,a,v,_,B,M,S,y,x,w,C,I,F,G,O){var T,D,R,A,U=0,P="",j=0,k=(F=0,0),W=0,q=0,E=0,z=0;G.length>0&&(z=G[0].TDD);let L=O.avgTDD7d;function N(e,r){var a=e.getTime();return new Date(a+36e5*r)}function H(e){var r=v.bolus_increment;.05!=r&&(r=.1);var a=e/r;return a>=1?o(Math.floor(a)*r,5):0}function Z(e){function r(e){return e<10&&(e="0"+e),e}return r(e.getHours())+":"+r(e.getMinutes())+":00"}function $(e,r){var a=new Date("1/1/1999 "+e),t=new Date("1/1/1999 "+r);return(a.getTime()-t.getTime())/36e5}function Q(e,r){var a=0,t=r,o=(e-r)/36e5,n=0,i=o,s=0;do{if(o>0){var l=Z(t);I[0].start;for(let e=0;e<I.length;e++){var u=I[e].start;if(l==u){if(e+1<I.length){o>=(s=$(I[e+1].start,I[e].start))?n=s:o<s&&(n=o)}else if(e+1==I.length){let r=I[0].start;o>=(s=24-$(I[e].start,r))?n=s:o<s&&(n=o)}a+=H(I[e].rate*n),o-=n,t=N(t,n)}else if(l>u)if(e+1<I.length){var d=I[e+1].start;l<d&&(o>=(s=$(d,l))?n=s:o<s&&(n=o),a+=H(I[e].rate*n),o-=n,t=N(t,n))}else if(e==I.length-1){o>=(s=$("23:59:59",l))?n=s:o<s&&(n=o),a+=H(I[e].rate*n),o-=n,t=N(t,n)}}}}while(o>0&&o<i);return a}let J=w.length-1;if(J>=0)var K=new Date(w[J].timestamp);else K=new Date;var V,X,Y=new Date(w[0].timestamp);("TempBasalDuration"==w[0]._type&&(Y=new Date),(U=(Y-K)/36e5)<23.5)?(q=Q(K,(V=24-U,X=K.getTime(),new Date(X-36e5*V))),P="24 hours of data is required for an accurate tdd calculation. Currently only "+U.toPrecision(3)+" hours of pump history data are available. Using your pump scheduled basals to fill in the missing hours. Scheduled basals added: "+q.toPrecision(5)+" U. "):P="";for(let e=0;e<w.length;e++)"Bolus"==w[e]._type&&(W+=w[e].amount);for(let e=1;e<w.length;e++)if("TempBasal"==w[e]._type&&w[e].rate>0){j=e,E=w[e].rate;var ee=w[e-1]["duration (min)"]/60,re=ee,ae=new Date(w[e-1].timestamp),te=ae;do{if(e--,0==e){te=new Date;break}if("TempBasal"==w[e]._type||"PumpSuspend"==w[e]._type){te=new Date(w[e].timestamp);break}}while(e>0);var oe=(te-ae)/36e5;oe<re&&(ee=oe),k+=H(E*ee),e=j}for(let e=0;e<w.length;e++)if(0,0==w[e]["duration (min)"]||"PumpResume"==w[e]._type){let r=new Date(w[e].timestamp),a=r,t=e;do{if(t>0&&(--t,"TempBasal"==w[t]._type)){a=new Date(w[t].timestamp);break}}while(t>0);(a-r)/36e5>0&&(q+=Q(a,r))}for(let e=w.length-1;e>0;e--)if("TempBasalDuration"==w[e]._type){let r=w[e]["duration (min)"]/60,a=new Date(w[e].timestamp);var ne=a;let t=e;do{if(--t,t>=0&&("TempBasal"==w[t]._type||"PumpSuspend"==w[t]._type)){ne=new Date(w[t].timestamp);break}}while(t>0);if(0==e&&"TempBasalDuration"==w[0]._type&&(ne=new Date,r=w[e]["duration (min)"]/60),(ne-a)/36e5-r>0){q+=Q(ne,N(a,r))}}var ie=F=W+k+q;R=". Bolus insulin: "+W.toPrecision(5)+" U",A=". Temporary basal insulin: "+k.toPrecision(5)+" U",D=". Insulin with scheduled basal rate: "+q.toPrecision(5)+" U",T="TDD past 24h is: "+F.toPrecision(5)+" U",logOutPut=P+T+R+A+D,tddReason=", TDD, 24h: "+o(F,1)+", ytd: "+o(z,1)+", 7dØ: "+o(L,1);var se={},le=new Date;if(x&&(le=x),void 0===v||void 0===v.current_basal)return se.error="Error: could not get current basal rate",se;var ue=t(v.current_basal,v),de=ue,me=new Date;x&&(me=x);var ce,ge=new Date(e.date),be=o((me-ge)/60/1e3,1),fe=e.glucose,pe=e.noise;ce=e.delta>-.5?"+"+o(e.delta,0):o(e.delta,0);var he=Math.min(e.delta,e.short_avgdelta),ve=Math.min(e.short_avgdelta,e.long_avgdelta),_e=Math.max(e.delta,e.short_avgdelta,e.long_avgdelta);(fe<=10||38===fe||pe>=3)&&(se.reason="CGM is calibrating, in ??? state, or noise is high");if(fe>60&&0==e.delta&&e.short_avgdelta>-1&&e.short_avgdelta<1&&e.long_avgdelta>-1&&e.long_avgdelta<1&&("fakecgm"==e.device?(console.error("CGM data is unchanged ("+n(fe,v)+"+"+n(e.delta,v)+") for 5m w/ "+n(e.short_avgdelta,v)+" mg/dL ~15m change & "+n(e.long_avgdelta,2)+" mg/dL ~45m change"),console.error("Simulator mode detected ("+e.device+"): continuing anyway")):!0),be>12||be<-5?se.reason="If current system time "+me+" is correct, then BG data is too old. The last BG data was read "+be+"m ago at "+ge:0===e.short_avgdelta&&0===e.long_avgdelta&&(e.last_cal&&e.last_cal<3?se.reason="CGM was just calibrated":se.reason="CGM data is unchanged ("+n(fe,v)+"+"+n(e.delta,v)+") for 5m w/ "+n(e.short_avgdelta,v)+" mg/dL ~15m change & "+n(e.long_avgdelta,v)+" mg/dL ~45m change"),fe<=10||38===fe||pe>=3||be>12||be<-5||0===e.short_avgdelta&&0===e.long_avgdelta)return r.rate>=de?(se.reason+=". Canceling high temp basal of "+r.rate,se.deliverAt=le,se.temp="absolute",se.duration=0,se.rate=0,se):0===r.rate&&r.duration>30?(se.reason+=". Shortening "+r.duration+"m long zero temp to 30m. ",se.deliverAt=le,se.temp="absolute",se.duration=30,se.rate=0,se):(se.reason+=". Temp "+r.rate+" <= current basal "+de+"U/hr; doing nothing. ",se);var Be,Me,Se,ye,xe=v.max_iob;if(void 0!==v.min_bg&&(Me=v.min_bg),void 0!==v.max_bg&&(Se=v.max_bg),void 0!==v.enableSMB_high_bg_target&&(ye=v.enableSMB_high_bg_target),void 0===v.min_bg||void 0===v.max_bg)return se.error="Error: could not determine target_bg. ",se;Be=(v.min_bg+v.max_bg)/2;var we=v.exercise_mode||v.high_temptarget_raises_sensitivity,Ce=100,Ie=160;if(v.half_basal_exercise_target&&(Ie=v.half_basal_exercise_target),we&&v.temptargetSet&&Be>Ce||v.low_temptarget_lowers_sensitivity&&v.temptargetSet&&Be<Ce){var Fe=Ie-Ce;sensitivityRatio=Fe*(Fe+Be-Ce)<=0?v.autosens_max:Fe/(Fe+Be-Ce),sensitivityRatio=Math.min(sensitivityRatio,v.autosens_max),sensitivityRatio=o(sensitivityRatio,2),process.stderr.write("Sensitivity ratio set to "+sensitivityRatio+" based on temp target of "+Be+"; ")}else void 0!==_&&_&&(sensitivityRatio=_.ratio,process.stderr.write("Autosens ratio: "+sensitivityRatio+"; "));if(sensitivityRatio&&(de=v.current_basal*sensitivityRatio,(de=t(de,v))!==ue?process.stderr.write("Adjusting basal from "+ue+" to "+de+"; "):process.stderr.write("Basal unchanged: "+de+"; ")),v.temptargetSet);else if(void 0!==_&&_&&(v.sensitivity_raises_target&&_.ratio<1||v.resistance_lowers_target&&_.ratio>1)){Me=o((Me-60)/_.ratio)+60,Se=o((Se-60)/_.ratio)+60;var Ge=o((Be-60)/_.ratio)+60;Be===(Ge=Math.max(80,Ge))?process.stderr.write("target_bg unchanged: "+Ge+"; "):process.stderr.write("target_bg from "+Be+" to "+Ge+"; "),Be=Ge}var Oe=200,Te=200,De=200;if(e.noise>=2){var Re=Math.max(1.1,v.noisyCGMTargetMultiplier);Math.min(250,v.maxRaw);Oe=o(Math.min(200,Me*Re)),Te=o(Math.min(200,Be*Re)),De=o(Math.min(200,Se*Re)),process.stderr.write("Raising target_bg for noisy / raw CGM data, from "+Be+" to "+Te+"; "),Me=Oe,Be=Te,Se=De}var Ae=Me-.5*(Me-40),Ue=o(v.sens,1),Pe=v.sens;void 0!==_&&_&&((Pe=o(Pe=v.sens/sensitivityRatio,1))!==Ue?process.stderr.write("ISF from "+n(Ue,v)+" to "+n(Pe,v)):process.stderr.write("ISF unchanged: "+n(Pe,v)),i+="Autosens, Ratio: "+sensitivityRatio+", ISF: "+n(Ue,v)+"→"+n(Pe,v)),console.error("CR:"+v.carb_ratio);var je=function(e,r){return console.error("Threshold: "+e.iob_threshold_percent+" IOB to maxIOB Quotient: "+o(r[0].iob/e.max_iob,4)),e.use_autoisf&&e.iob_threshold_percent<r[0].iob/e.max_iob?(s=", autoISF-SMB disabled:, IOB: "+o(r[0].iob,2)+", more than "+100*e.iob_threshold_percent+"%, of maxIOB: "+e.max_iob,console.error(s),"iobTH"):e.temptargetSet&&e.autoisf_temp_smb&&e.use_autoisf?e.min_bg%2==1?(s=", autoISF-SMB disabled:, odd TT",console.error(s),"blocked"):(s=", autoISF-SMB enforced:, even TT",console.error(s),"enforced"):"oref"}(v,a);if(Pe=function(e,r,a,t,v,_,B,M){if(!a.use_autoisf)return console.error("autoISF disabled in Preferences"),i+=", autoISF, disabled",e;var S=t.dura_p,y=t.delta_pl,x=t.delta_pn,w=t.r_squ,C=t.bg_acceleration,I=t.parabola_fit_a0,F=t.parabola_fit_a1,G=t.parabola_fit_a2,O=t.autoISF_duration,T=t.autoISF_average,D=a.autoisf_max,R=!1,A=1,U=1,P=1,j=r+10-T;if(!(v.mealCOB>0)||a.enableautoisf_with_COB){var k=t.pp_debug;if(c+="BG-accel: "+o(C,3)+", PF-minutes: "+S+", PF-corr: "+o(w,4)+", PF-nextDelta: "+n(x,a)+", PF-lastDelta: "+n(y,a)+", regular Delta: "+n(t.delta,a),console.error(k+c+" , Weights Accel/Brake: "+a.bgAccel_ISF_weight+" / "+a.bgBrake_ISF_weight),a.enable_BG_acceleration){var W=C;if(0!=t.parabola_fit_a2){var q=-F/2/G*5,E=o(I-q*q/25*G,1);(q=o(q,1))<0&&W<0?(f="saw max of "+n(E,a)+", about "+-q+" min ago",console.error("Parabolic fit "+f)):q<0&&W>0?(f="saw min of "+n(E,a)+", about "+-q+" min ago",console.error("Parabolic fit "+f)):q>0&&W<0?(f="predicts max of "+n(E,a)+", in about "+q+"min",console.error("Parabolic fit "+f)):q>0&&W>0&&(f="predicts min of "+n(E,a)+", in about "+q+" min",console.error("Parabolic fit "+f))}var z=w;if(z<=.9)f="acce_ISF by-passed, as correlation, "+o(z,3)+", is too low",console.error("Parabolic fit "+f),g+=", Parabolic Fit, "+f;else{g+=", Parabolic Fit, "+f+", lastΔ: "+n(y,a)+", nextΔ: "+n(x,a)+", Corr "+o(w,3)+", BG-Accel: "+o(W,2);var L=10*(z-.9),N=1,H=1;t.glucose<a.target_bg?W>0?(W>1&&(N=.5),H=a.bgBrake_ISF_weight):W<0&&(H=a.bgAccel_ISF_weight):W<0?H=a.bgBrake_ISF_weight:W>0&&(H=a.bgAccel_ISF_weight),P=1+W*N*H*L,console.error("Original result for acce_ISF: "+o(P,2)),1!=P&&(R=!0,g+=", acce-ISF Ratio: "+o(P,2))}}else console.error("autoISF BG accelertion adaption disabled in Preferences");var Z=h(a,t.glucose,r);i+=s+", SMB Delivery Ratio:, "+o(Z,2)+g+", autoISF";var $=1+p(100-j,a);console.error("bg_ISF adaptation is "+o($,2)),$<1&&P>1&&(b="bg-ISF adaptation lifted to "+o($*=P,2)+", as BG accelerates already",l="(lifted by "+o(P,2)+")",console.error(b));var Q=1;if($<1)return(Q=Math.min($,P))<a.autoisf_min&&(b="final ISF factor "+o(Q,2)+" limited by autoisf_min "+a.autoisf_min,console.error(b),Q=a.autoisf_min),l=" (lmtd.)",earlysens=Math.min(720,o(a.sens/Math.min(M,Q),1)),console.error("early Return autoISF:  "+n(earlysens,a)),i+=", bg-ISF Ratio: "+o($,2)+l+", ISF: "+n(earlysens,a),earlysens;$>1&&(R=!0,i+=", bg-ISF Ratio: "+o($,2));var J=t.delta;j>0?console.error("delta_ISF adaptation by-passed as average glucose < "+n(r+10,a)):t.short_avgdelta<0?console.error("delta_ISF adaptation by-passed as no rise or too short lived"):a.enableppisf_always||a.postmeal_ISF_duration>=(_-v.lastCarbTime)/1e3/3600?(A=1+Math.max(0,J*a.postmeal_ISF_weight),console.error("pp_ISF adaptation is "+o(A,2)),d=", pp-ISF Ratio: "+o(A,2),1!=A&&(R=!0)):(U=p(J,a),j>-20&&(U*=.5),U=1+U,console.error("delta_ISF adaptation is "+o(U,2)),m=", Δ-ISF Ratio: "+o(U,2),1!=U&&(R=!0));var K=1,V=a.autoisf_hourlychange;return v.mealCOB>0&&!a.enableautoisf_with_COB?console.error("dura_ISF by-passed; preferences disabled mealCOB of "+o(v.mealCOB,1)):O<10?console.error("dura_ISF by-passed; BG is only "+O+"m at level "+T):T<=r?console.error("dura_ISF by-passed; avg. glucose "+T+" below target "+n(r,a)):(K+=O/60*(V/r)*(T-r),R=!0,u=", Duration: "+O+", Avg: "+n(T,a)+", dura-ISF Ratio: "+o(K,2),console.error("dura_ISF  adaptation is "+o(K,2)+" because ISF "+e+" did not do it for "+o(O,1)+"m")),Q=1,R?(Q=Math.max(K,$,U,P,A),console.error("autoISF adaption ratios:"),console.error("  dura "+o(K,2)),console.error("  bg "+o($,2)),console.error("  delta "+o(U,2)),console.error("  pp "+o(A,2)),console.error("  accel "+o(P,2)),P<1&&(console.error("strongest ISF factor "+o(Q,2)+" weakened to "+o(Q*P,2)+" as bg decelerates already"),Q*=P),Q<a.autoisf_min?(console.error("final ISF factor "+o(Q,2)+" limited by autoisf_min "+a.autoisf_min),Q=a.autoisf_min):Q>D&&(console.error("final ISF factor "+o(Q,2)+" limited by autoisf_max "+D),Q=D),Q>=1&&(e=o(a.sens/Math.max(Q,M),1)),Q<1&&(e=o(a.sens/Math.min(Q,M),1))):Q=M,i+=d+m+u+", final Ratio: "+o(Q,2)+", final ISF: "+n(e,a),console.error("Inside autoISF: Ratio "+o(Q,2)+" resulting in "+n(e,a)),e}return console.error("BG dependant autoISF by-passed; preferences disabled mealCOB of "+o(v.mealCOB,1)),i+=", autoISF, disabled with COB",e}(Pe,Be,v,e,B,x,0,sensitivityRatio),void 0===a)return se.error="Error: iob_data undefined. ",se;var ke,We=a;if(a.length,a.length>1&&(a=We[0]),void 0===a.activity||void 0===a.iob)return se.error="Error: iob_data missing some property. ",se;var qe=((ke=void 0!==a.lastTemp?o((new Date(me).getTime()-a.lastTemp.date)/6e4):0)+r.duration)%30;if(console.error("currenttemp:"+r.rate+" lastTempAge:"+ke+"m, tempModulus:"+qe+"m"),se.temp="absolute",se.deliverAt=le,S&&r&&a.lastTemp&&r.rate!==a.lastTemp.rate&&ke>10&&r.duration)return se.reason="Warning: currenttemp rate "+r.rate+" != lastTemp rate "+a.lastTemp.rate+" from pumphistory; canceling temp",M.setTempBasal(0,0,v,se,r);if(r&&a.lastTemp&&r.duration>0){var Ee=ke-a.lastTemp.duration;if(Ee>5&&ke>10)return se.reason="Warning: currenttemp running but lastTemp from pumphistory ended "+Ee+"m ago; canceling temp",M.setTempBasal(0,0,v,se,r)}var ze=o(-a.activity*Pe*5,2),Le=o(6*(he-ze));Le<0&&(Le=o(6*(ve-ze)))<0&&(Le=o(6*(e.long_avgdelta-ze)));var Ne=fe,He=(Ne=a.iob>0?o(fe-a.iob*Pe):o(fe-a.iob*Math.min(Pe,v.sens)))+Le;if(void 0===He||isNaN(He))return se.error="Error: could not calculate eventualBG. Sensitivity: "+Pe+" Deviation: "+Le,se;var Ze=function(e,r,a){return o(a+(e-r)/24,1)}(Be,He,ze);se={temp:"absolute",bg:fe,tick:ce,eventualBG:He,insulinReq:0,reservoir:y,deliverAt:le,sensitivityRatio};var $e=[],Qe=[],Je=[],Ke=[];$e.push(fe),Qe.push(fe),Ke.push(fe),Je.push(fe);var Ve=!1;S&&"oref"!=je?"enforced"==je&&(Ve=!0):Ve=function(e,r,a,t,o,i){return r?!e.allowSMB_with_high_temptarget&&e.temptargetSet&&o>100?(console.error("SMB disabled due to high temptarget of",o),!1):!0===a.bwFound&&!1===e.A52_risk_enable?(console.error("SMB disabled due to Bolus Wizard activity in the last 6 hours."),!1):!0===e.enableSMB_always?(a.bwFound?console.error("Warning: SMB enabled within 6h of using Bolus Wizard: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled due to enableSMB_always"),!0):!0===e.enableSMB_with_COB&&a.mealCOB?(a.bwCarbs?console.error("Warning: SMB enabled with Bolus Wizard carbs: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled for COB of",a.mealCOB),!0):!0===e.enableSMB_after_carbs&&a.carbs?(a.bwCarbs?console.error("Warning: SMB enabled with Bolus Wizard carbs: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled for 6h after carb entry"),!0):!0===e.enableSMB_with_temptarget&&e.temptargetSet&&o<100?(a.bwFound?console.error("Warning: SMB enabled within 6h of using Bolus Wizard: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled for temptarget of",n(o,e)),!0):!0===e.enableSMB_high_bg&&null!==i&&t>=i?(console.error("Checking BG to see if High for SMB enablement."),console.error("Current BG",t," | High BG ",i),a.bwFound?console.error("Warning: High BG SMB enabled within 6h of using Bolus Wizard: be sure to easy bolus 30s before using Bolus Wizard"):console.error("High BG detected. Enabling SMB."),!0):(console.error("SMB disabled (no enableSMB preferences active or no condition satisfied)"),!1):(console.error("SMB disabled (!microBolusAllowed)"),!1)}(v,S,B,fe,Be,ye);var Xe=v.enableUAM,Ye=0,er=0;Ye=o(he-ze,1);var rr=o(he-ze,1);csf=Pe/v.carb_ratio,console.error("profile.sens:"+n(v.sens,v)+", sens:"+n(Pe,v)+", CSF:"+o(csf,1));var ar=o(30*csf*5/60,1);Ye>ar&&(console.error("Limiting carb impact from "+Ye+" to "+ar+"mg/dL/5m (30g/h)"),Ye=ar);var tr=3;sensitivityRatio&&(tr/=sensitivityRatio);var or=tr;if(B.carbs){tr=Math.max(tr,B.mealCOB/20);var nr=o((new Date(me).getTime()-B.lastCarbTime)/6e4),ir=(B.carbs-B.mealCOB)/B.carbs;or=o(or=tr+1.5*nr/60,1),console.error("Last carbs "+nr+" minutes ago; remainingCATime:"+or+"hours; "+o(100*ir)+"% carbs absorbed")}var sr=Math.max(0,Ye/5*60*or/2)/csf,lr=90,ur=1;v.remainingCarbsCap&&(lr=Math.min(90,v.remainingCarbsCap)),v.remainingCarbsFraction&&(ur=Math.min(1,v.remainingCarbsFraction));var dr=1-ur,mr=Math.max(0,B.mealCOB-sr-B.carbs*dr),cr=(mr=Math.min(lr,mr))*csf*5/60/(or/2),gr=o(B.slopeFromMaxDeviation,2),br=o(B.slopeFromMinDeviation,2),fr=Math.min(gr,-br/3),pr=0;0===Ye?er=0:!0===v.floating_carbs?(er=Math.min(60*or/5/2,Math.max(0,B.carbs*csf/Ye)),pr=Math.min(60*or/5/2,Math.max(0,B.mealCOB*csf/Ye)),B.carbs>0&&(i+=", Floating Carbs:, CID: "+o(er,1)+", MealCarbs: "+o(B.carbs,1)+", Not Floating:, CID: "+o(pr,1)+", MealCOB: "+o(B.mealCOB,1),console.error("Floating Carbs CID: "+o(er,1)+" / MealCarbs: "+o(B.carbs,1)+" vs. Not Floating:"+o(pr,1)+" / MealCOB:"+o(B.mealCOB,1)))):er=Math.min(60*or/5/2,Math.max(0,B.mealCOB*csf/Ye)),console.error("Carb Impact:"+Ye+"mg/dL per 5m; CI Duration:"+o(5*er/60*2,1)+"hours; remaining CI ("+or/2+"h peak):",o(cr,1)+"mg/dL per 5m");var hr,vr,_r,Br,Mr,Sr=999,yr=999,xr=999,wr=fe,Cr=999,Ir=999,Fr=999,Gr=999,Or=He,Tr=fe,Dr=fe,Rr=0,Ar=[],Ur=[];try{We.forEach((function(e){var r=o(-e.activity*Pe*5,2),a=o(-e.iobWithZeroTemp.activity*Pe*5,2),t=Ye*(1-Math.min(1,Qe.length/12));Or=Qe[Qe.length-1]+r+t;var n=Ke[Ke.length-1]+a,i=Math.max(0,Math.max(0,Ye)*(1-$e.length/Math.max(2*er,1))),s=Math.min($e.length,12*or-$e.length),l=Math.max(0,s/(or/2*12)*cr);i+l,Ar.push(o(l,0)),Ur.push(o(i,0)),COBpredBG=$e[$e.length-1]+r+Math.min(0,t)+i+l;var u=Math.max(0,rr+Je.length*fr),d=Math.max(0,rr*(1-Je.length/Math.max(36,1))),m=Math.min(u,d);m>0&&(Rr=o(5*(Je.length+1)/60,1)),UAMpredBG=Je[Je.length-1]+r+Math.min(0,t)+m,Qe.length<48&&Qe.push(Or),$e.length<48&&$e.push(COBpredBG),Je.length<48&&Je.push(UAMpredBG),Ke.length<48&&Ke.push(n),COBpredBG<Cr&&(Cr=o(COBpredBG)),UAMpredBG<Ir&&(Ir=o(UAMpredBG)),Or<Fr&&(Fr=o(Or)),n<Gr&&(Gr=o(n));Qe.length>18&&Or<Sr&&(Sr=o(Or)),Or>Tr&&(Tr=Or),(er||cr>0)&&$e.length>18&&COBpredBG<yr&&(yr=o(COBpredBG)),(er||cr>0)&&COBpredBG>Tr&&(Dr=COBpredBG),Xe&&Je.length>12&&UAMpredBG<xr&&(xr=o(UAMpredBG)),Xe&&UAMpredBG>Tr&&UAMpredBG}))}catch(e){console.error("Problem with iobArray.  Optional feature Advanced Meal Assist disabled")}B.mealCOB&&(console.error("predCIs (mg/dL/5m):"+Ur.join(" ")),console.error("remainingCIs:      "+Ar.join(" "))),se.predBGs={},Qe.forEach((function(e,r,a){a[r]=o(Math.min(401,Math.max(39,e)))}));for(var Pr=Qe.length-1;Pr>12&&Qe[Pr-1]===Qe[Pr];Pr--)Qe.pop();for(se.predBGs.IOB=Qe,_r=o(Qe[Qe.length-1]),Ke.forEach((function(e,r,a){a[r]=o(Math.min(401,Math.max(39,e)))})),Pr=Ke.length-1;Pr>6&&!(Ke[Pr-1]>=Ke[Pr]||Ke[Pr]<=Be);Pr--)Ke.pop();if(se.predBGs.ZT=Ke,o(Ke[Ke.length-1]),B.mealCOB>0&&(Ye>0||cr>0)){for($e.forEach((function(e,r,a){a[r]=o(Math.min(401,Math.max(39,e)))})),Pr=$e.length-1;Pr>12&&$e[Pr-1]===$e[Pr];Pr--)$e.pop();se.predBGs.COB=$e,Br=o($e[$e.length-1]),He=Math.max(He,o($e[$e.length-1]))}if(Ye>0||cr>0){if(Xe){for(Je.forEach((function(e,r,a){a[r]=o(Math.min(401,Math.max(39,e)))})),Pr=Je.length-1;Pr>12&&Je[Pr-1]===Je[Pr];Pr--)Je.pop();se.predBGs.UAM=Je,Mr=o(Je[Je.length-1]),Je[Je.length-1]&&(He=Math.max(He,o(Je[Je.length-1])))}se.eventualBG=He}console.error("UAM Impact:"+rr+"mg/dL per 5m; UAM Duration:"+Rr+"hours"),Sr=Math.max(39,Sr),yr=Math.max(39,yr),xr=Math.max(39,xr),hr=o(Sr);var jr=B.mealCOB/B.carbs;vr=o(xr<999&&yr<999?(1-jr)*UAMpredBG+jr*COBpredBG:yr<999?(Or+COBpredBG)/2:xr<999?(Or+UAMpredBG)/2:Or),Gr>vr&&(vr=Gr),wr=o(wr=er||cr>0?Xe?jr*Cr+(1-jr)*Ir:Cr:Xe?Ir:Fr);var kr=xr;if(Gr<Ae)kr=(xr+Gr)/2;else if(Gr<Be){var Wr=(Gr-Ae)/(Be-Ae);kr=(xr+(xr*Wr+Gr*(1-Wr)))/2}else Gr>xr&&(kr=(xr+Gr)/2);if(kr=o(kr),B.carbs)if(!Xe&&yr<999)hr=o(Math.max(Sr,yr));else if(yr<999){var qr=jr*yr+(1-jr)*kr;hr=o(Math.max(Sr,yr,qr))}else hr=Xe?kr:wr;else Xe&&(hr=o(Math.max(Sr,kr)));hr=Math.min(hr,vr),process.stderr.write("minPredBG: "+hr+" minIOBPredBG: "+Sr+" minZTGuardBG: "+Gr),yr<999&&process.stderr.write(" minCOBPredBG: "+yr),xr<999&&process.stderr.write(" minUAMPredBG: "+xr),console.error(" avgPredBG:"+vr+" COB/Carbs:"+B.mealCOB+"/"+B.carbs),Dr>fe&&(hr=Math.min(hr,Dr)),se.COB=B.mealCOB,se.IOB=a.iob,se.BGI=n(ze,v),se.deviation=n(Le,v),se.ISF=n(Pe,v),se.CR=o(v.carb_ratio,2),se.TDD=o(ie,2),se.target_bg=n(Be,v),se.reason=i+", Standard, COB: "+se.COB+", Dev: "+se.deviation+", BGI: "+se.BGI+", ISF: "+se.ISF+", CR: "+se.CR+", minPredBG "+n(hr,v)+", minGuardBG "+n(wr,v)+", IOBpredBG "+n(_r,v),Br>0&&(se.reason+=", COBpredBG "+n(Br,v)),Mr>0&&(se.reason+=", UAMpredBG "+n(Mr,v)),se.reason+=tddReason,se.reason+="; ";var Er=Ne;Er<40&&(Er=Math.min(wr,Er));var zr,Lr=Ae-Er,Nr=240,Hr=240;if(B.mealCOB>0&&(Ye>0||cr>0)){for(Pr=0;Pr<$e.length;Pr++)if($e[Pr]<Me){Nr=5*Pr;break}for(Pr=0;Pr<$e.length;Pr++)if($e[Pr]<Ae){Hr=5*Pr;break}}else{for(Pr=0;Pr<Qe.length;Pr++)if(Qe[Pr]<Me){Nr=5*Pr;break}for(Pr=0;Pr<Qe.length;Pr++)if(Qe[Pr]<Ae){Hr=5*Pr;break}}Ve&&wr<Ae&&(console.error("minGuardBG "+n(wr,v)+" projected below "+n(Ae,v)+" - disabling SMB"),Ve=!1),void 0===v.maxDelta_bg_threshold&&(zr=.2),void 0!==v.maxDelta_bg_threshold&&(zr=Math.min(v.maxDelta_bg_threshold,.4)),_e>zr*fe&&(console.error("maxDelta "+n(_e,v)+" > "+100*zr+"% of BG "+n(fe,v)+" - disabling SMB"),se.reason+="maxDelta "+n(_e,v)+" > "+100*zr+"% of BG "+n(fe,v)+" - SMB disabled!, ",Ve=!1),console.error("BG projected to remain above "+n(Me,v)+" for "+Nr+"minutes"),(Hr<240||Nr<60)&&console.error("BG projected to remain above "+n(Ae,v)+" for "+Hr+"minutes");var Zr=Hr,$r=v.current_basal*Pe*Zr/60,Qr=Math.max(0,B.mealCOB-.25*B.carbs),Jr=(Lr-$r)/csf-Qr;$r=o($r),Jr=o(Jr),console.error("naive_eventualBG:",Ne,"bgUndershoot:",Lr,"zeroTempDuration:",Zr,"zeroTempEffect:",$r,"carbsReq:",Jr),"Could not parse clock data"==B.reason?console.error("carbsReq unknown: Could not parse clock data"):Jr>=v.carbsReqThreshold&&Hr<=45&&(se.carbsReq=Jr,se.reason+=Jr+" add'l carbs req w/in "+Hr+"m; ");var Kr=0;if(fe<Ae&&a.iob<20*-v.current_basal/60&&he>0&&he>Ze)se.reason+="IOB "+a.iob+" < "+o(20*-v.current_basal/60,2),se.reason+=" and minDelta "+n(he,v)+" > expectedDelta "+n(Ze,v)+"; ";else if(fe<Ae||wr<Ae)return se.reason+="minGuardBG "+n(wr,v)+"<"+n(Ae,v),Kr=o(60*((Lr=Be-wr)/Pe)/v.current_basal),Kr=30*o(Kr/30),Kr=Math.min(120,Math.max(30,Kr)),M.setTempBasal(0,Kr,v,se,r);if(v.skip_neutral_temps&&se.deliverAt.getMinutes()>=55)return se.reason+="; Canceling temp at "+se.deliverAt.getMinutes()+"m past the hour. ",M.setTempBasal(0,0,v,se,r);var Vr=0,Xr=de;if(He<Me){if(se.reason+="Eventual BG "+n(He,v)+" < "+n(Me,v),he>Ze&&he>0&&!Jr)return Ne<40?(se.reason+=", naive_eventualBG < 40. ",M.setTempBasal(0,30,v,se,r)):(e.delta>he?se.reason+=", but Delta "+n(ce,v)+" > expectedDelta "+n(Ze,v):se.reason+=", but Min. Delta "+he.toFixed(2)+" > Exp. Delta "+n(Ze,v),r.duration>15&&t(de,v)===t(r.rate,v)?(se.reason+=", temp "+r.rate+" ~ req "+de+"U/hr. ",se):(se.reason+="; setting current basal of "+de+" as temp. ",M.setTempBasal(de,30,v,se,r)));Vr=o(Vr=2*Math.min(0,(He-Be)/Pe),2);var Yr=Math.min(0,(Ne-Be)/Pe);if(Yr=o(Yr,2),he<0&&he>Ze)Vr=o(Vr*(he/Ze),2);if(Xr=t(Xr=de+2*Vr,v),r.duration*(r.rate-de)/60<Math.min(Vr,Yr)-.3*de)return se.reason+=", "+r.duration+"m@"+r.rate.toFixed(2)+" is a lot less than needed. ",M.setTempBasal(Xr,30,v,se,r);if(void 0!==r.rate&&r.duration>5&&Xr>=.8*r.rate)return se.reason+=", temp "+r.rate+" ~< req "+Xr+"U/hr. ",se;if(Xr<=0){if((Kr=o(60*((Lr=Be-Ne)/Pe)/v.current_basal))<0?Kr=0:(Kr=30*o(Kr/30),Kr=Math.min(120,Math.max(0,Kr))),Kr>0)return se.reason+=", setting "+Kr+"m zero temp. ",M.setTempBasal(Xr,Kr,v,se,r)}else se.reason+=", setting "+Xr+"U/hr. ";return M.setTempBasal(Xr,30,v,se,r)}if(he<Ze&&(!S||!Ve))return e.delta<he?se.reason+="Eventual BG "+n(He,v)+" > "+n(Me,v)+" but Delta "+n(ce,v)+" < Exp. Delta "+n(Ze,v):se.reason+="Eventual BG "+n(He,v)+" > "+n(Me,v)+" but Min. Delta "+he.toFixed(2)+" < Exp. Delta "+n(Ze,v),r.duration>15&&t(de,v)===t(r.rate,v)?(se.reason+=", temp "+r.rate+" ~ req "+de+"U/hr. ",se):(se.reason+="; setting current basal of "+de+" as temp. ",M.setTempBasal(de,30,v,se,r));if(Math.min(He,hr)<Se&&(!S||!Ve))return se.reason+=n(He,v)+"-"+n(hr,v)+" in range: no temp required",r.duration>15&&t(de,v)===t(r.rate,v)?(se.reason+=", temp "+r.rate+" ~ req "+de+"U/hr. ",se):(se.reason+="; setting current basal of "+de+" as temp. ",M.setTempBasal(de,30,v,se,r));if(He>=Se&&(se.reason+="Eventual BG "+n(He,v)+" >= "+n(Se,v)+", "),a.iob>xe)return se.reason+="IOB "+o(a.iob,2)+" > max_iob "+xe,r.duration>15&&t(de,v)===t(r.rate,v)?(se.reason+=", temp "+r.rate+" ~ req "+de+"U/hr. ",se):(se.reason+="; setting current basal of "+de+" as temp. ",M.setTempBasal(de,30,v,se,r));(Vr=o((Math.min(hr,He)-Be)/Pe,2))>xe-a.iob&&(se.reason+="max_iob "+xe+", ",Vr=xe-a.iob),Xr=t(Xr=de+2*Vr,v),Vr=o(Vr,3),se.insulinReq=Vr;var ea=o((new Date(me).getTime()-a.lastBolusTime)/6e4,1);if(S&&Ve&&fe>Ae){var ra=o(B.mealCOB/v.carb_ratio,3);if(v.use_autoisf)aa=v.smb_max_range_extension;else{console.error("autoISF disabled, SMB range extension disabled");var aa=1}aa>1&&console.error("SMB max range extended from default by factor "+aa);var ta=0;void 0===v.maxSMBBasalMinutes?(ta=o(aa*v.current_basal*30/60,1),console.error("profile.maxSMBBasalMinutes undefined: defaulting to 30m")):a.iob>ra&&a.iob>0?(console.error("IOB",a.iob,"> COB",B.mealCOB+"; mealInsulinReq =",ra),v.maxUAMSMBBasalMinutes?(console.error("profile.maxUAMSMBBasalMinutes:",v.maxUAMSMBBasalMinutes,"profile.current_basal:",v.current_basal),ta=o(aa*v.current_basal*v.maxUAMSMBBasalMinutes/60,1)):(console.error("profile.maxUAMSMBBasalMinutes undefined: defaulting to 30m"),ta=o(30*v.current_basal/60,1))):(console.error("profile.maxSMBBasalMinutes:",v.maxSMBBasalMinutes,"profile.current_basal:",v.current_basal),ta=o(aa*v.current_basal*v.maxSMBBasalMinutes/60,1));var oa=v.bolus_increment,na=1/oa;if(v.use_autoisf)var ia=h(v,fe,Be);else console.error("autoISF disabled, don't adjust SMB Delivery Ratio"),ia=.5;ia>.5&&console.error("SMB Delivery Ratio increased from default 0.5 to "+o(ia,2));var sa=Math.min(Vr*ia,ta);sa=Math.floor(sa*na)/na,Kr=o(60*((Be-(Ne+Sr)/2)/Pe)/v.current_basal),Vr>0&&sa<oa&&(Kr=0);var la=0;Kr<=0?Kr=0:Kr>=30?(Kr=30*o(Kr/30),Kr=Math.min(60,Math.max(0,Kr))):(la=o(de*Kr/30,2),Kr=30),se.reason+=" insulinReq "+Vr,sa>=ta&&(se.reason+="; maxBolus "+ta),Kr>0&&(se.reason+="; setting "+Kr+"m low temp of "+la+"U/h"),se.reason+=". ";var ua=3;v.SMBInterval&&(ua=Math.min(10,Math.max(1,v.SMBInterval)));var da=o(ua-ea,0),ma=o(60*(ua-ea),0)%60;if(console.error("naive_eventualBG",Ne+",",Kr+"m "+la+"U/h temp needed; last bolus",ea+"m ago; maxBolus: "+ta),ea>ua?sa>0&&(se.units=sa,se.reason+="Microbolusing "+sa+"U. "):se.reason+="Waiting "+da+"m "+ma+"s to microbolus again. ",Kr>0)return se.rate=la,se.duration=Kr,se}var ca=M.getMaxSafeBasal(v);return Xr>ca&&(se.reason+="adj. req. rate: "+Xr+" to maxSafeBasal: "+ca+", ",Xr=t(ca,v)),r.duration*(r.rate-de)/60>=2*Vr?(se.reason+=r.duration+"m@"+r.rate.toFixed(2)+" > 2 * insulinReq. Setting temp basal of "+Xr+"U/hr. ",M.setTempBasal(Xr,30,v,se,r)):void 0===r.duration||0===r.duration?(se.reason+="no temp, setting "+Xr+"U/hr. ",M.setTempBasal(Xr,30,v,se,r)):r.duration>5&&t(Xr,v)<=t(r.rate,v)?(se.reason+="temp "+r.rate+" >~ req "+Xr+"U/hr. ",se):(se.reason+="temp "+r.rate+"<"+Xr+"U/hr. ",M.setTempBasal(Xr,30,v,se,r))}},6880:(e,r,a)=>{var t=a(6654);e.exports=function(e,r){var a=20;void 0!==r&&"string"==typeof r.model&&(t(r.model,"54")||t(r.model,"23"))&&(a=40);return e<1?Math.round(e*a)/a:e<10?Math.round(20*e)/20:Math.round(10*e)/10}},2705:(e,r,a)=>{var t=a(5639).Symbol;e.exports=t},9932:e=>{e.exports=function(e,r){for(var a=-1,t=null==e?0:e.length,o=Array(t);++a<t;)o[a]=r(e[a],a,e);return o}},9750:e=>{e.exports=function(e,r,a){return e==e&&(void 0!==a&&(e=e<=a?e:a),void 0!==r&&(e=e>=r?e:r)),e}},4239:(e,r,a)=>{var t=a(2705),o=a(9607),n=a(2333),i=t?t.toStringTag:void 0;e.exports=function(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":i&&i in Object(e)?o(e):n(e)}},531:(e,r,a)=>{var t=a(2705),o=a(9932),n=a(1469),i=a(3448),s=t?t.prototype:void 0,l=s?s.toString:void 0;e.exports=function e(r){if("string"==typeof r)return r;if(n(r))return o(r,e)+"";if(i(r))return l?l.call(r):"";var a=r+"";return"0"==a&&1/r==-Infinity?"-0":a}},7561:(e,r,a)=>{var t=a(7990),o=/^\s+/;e.exports=function(e){return e?e.slice(0,t(e)+1).replace(o,""):e}},1957:(e,r,a)=>{var t="object"==typeof a.g&&a.g&&a.g.Object===Object&&a.g;e.exports=t},9607:(e,r,a)=>{var t=a(2705),o=Object.prototype,n=o.hasOwnProperty,i=o.toString,s=t?t.toStringTag:void 0;e.exports=function(e){var r=n.call(e,s),a=e[s];try{e[s]=void 0;var t=!0}catch(e){}var o=i.call(e);return t&&(r?e[s]=a:delete e[s]),o}},2333:e=>{var r=Object.prototype.toString;e.exports=function(e){return r.call(e)}},5639:(e,r,a)=>{var t=a(1957),o="object"==typeof self&&self&&self.Object===Object&&self,n=t||o||Function("return this")();e.exports=n},7990:e=>{var r=/\s/;e.exports=function(e){for(var a=e.length;a--&&r.test(e.charAt(a)););return a}},6654:(e,r,a)=>{var t=a(9750),o=a(531),n=a(554),i=a(9833);e.exports=function(e,r,a){e=i(e),r=o(r);var s=e.length,l=a=void 0===a?s:t(n(a),0,s);return(a-=r.length)>=0&&e.slice(a,l)==r}},1469:e=>{var r=Array.isArray;e.exports=r},3218:e=>{e.exports=function(e){var r=typeof e;return null!=e&&("object"==r||"function"==r)}},7005:e=>{e.exports=function(e){return null!=e&&"object"==typeof e}},3448:(e,r,a)=>{var t=a(4239),o=a(7005);e.exports=function(e){return"symbol"==typeof e||o(e)&&"[object Symbol]"==t(e)}},8601:(e,r,a)=>{var t=a(4841),o=1/0;e.exports=function(e){return e?(e=t(e))===o||e===-1/0?17976931348623157e292*(e<0?-1:1):e==e?e:0:0===e?e:0}},554:(e,r,a)=>{var t=a(8601);e.exports=function(e){var r=t(e),a=r%1;return r==r?a?r-a:r:0}},4841:(e,r,a)=>{var t=a(7561),o=a(3218),n=a(3448),i=/^[-+]0x[0-9a-f]+$/i,s=/^0b[01]+$/i,l=/^0o[0-7]+$/i,u=parseInt;e.exports=function(e){if("number"==typeof e)return e;if(n(e))return NaN;if(o(e)){var r="function"==typeof e.valueOf?e.valueOf():e;e=o(r)?r+"":r}if("string"!=typeof e)return 0===e?e:+e;e=t(e);var a=s.test(e);return a||l.test(e)?u(e.slice(2),a?2:8):i.test(e)?NaN:+e}},9833:(e,r,a)=>{var t=a(531);e.exports=function(e){return null==e?"":t(e)}}},r={};function a(t){var o=r[t];if(void 0!==o)return o.exports;var n=r[t]={exports:{}};return e[t](n,n.exports,a),n.exports}a.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}();var t=a(5546);freeaps_determineBasal=t})();