var freeaps_determineBasal;(()=>{var e={5546:(e,r,a)=>{var t=a(6880);function o(e,r){r||(r=0);var a=Math.pow(10,r);return Math.round(e*a)/a}function n(e,r){return"mmol/L"===r.out_units?o(.0555*e,1):Math.round(e)}var i="",s="",l="",u="",d="",m="",c="",p="",g="",b="",f=1,h=1,v=1,_=1,B=1,M=1;function S(e,r,a){polyX_bg=[50,60,80,90,100,110,150,180,200],polyY_bg=[-.5,-.5,-.3,-.2,0,0,.5,.7,.7],polyX_delta=[2,7,12,16,20],polyY_delta=[0,0,.4,.7,.7],"bg"==a?(polyX=polyX_bg,polyY=polyY_bg):"delta"==a&&(polyX=polyX_delta,polyY=polyY_delta);var t=polyX.length-1,o=polyX[0],n=polyY[0],i=polyX[t],s=polyY[t],l=1,u=1,d=1,m=o;if(o>e)i=polyX[1],l=(u=n)+((s=polyY[1])-u)/(i-(d=o))*(e-d);else if(i<e)o=polyX[t-1],l=(u=n=polyY[t-1])+(s-u)/(i-(d=o))*(e-d);else for(var c=0;c<=t;c++){if(o=polyX[c],n=polyY[c],o==e){l=n;break}if(o>e){l=u+(n-u)/(o-(d=m))*(e-d);break}u=n,m=o}return l*="delta"==a?r.delta_ISFrange_weight:e>100?r.higher_ISFrange_weight:r.lower_ISFrange_weight}function y(e,r,a,t){return console.error("check ratio "+o(e,2)+" against autoISF min: "+r+" and autoISF max: "+a),e<r?(b=" (lmtd.)",p="weakest ISF factor "+o(e,2)+" limited by autoisf_min "+r,console.error(p),e=r):e>a&&(b=" (lmtd.)",p="strongest ISF factor "+o(e,2)+" limited by autoisf_max "+a,console.error(p),e=a),e>=1&&(M=Math.max(e,t)),e<1&&(M=Math.min(e,t)),p="final ISF factor "+o(M,2),console.error(p),M}e.exports=function(e,r,a,x,F,I,w,T,C,G,D,O,R,U,A,P){var k=0,j="",E="",W="",q="",z=0,L=(U=0,0),X=0,Y=0,N=0,H=0;A.length>0&&(H=A[0].TDD);let Z=P.avgTDD7d;function $(e,r){var a=e.getTime();return new Date(a+36e5*r)}function J(e){var r=x.bolus_increment;.05!=r&&(r=.1);var a=e/r;return a>=1?o(Math.floor(a)*r,5):0}function K(e){function r(e){return e<10&&(e="0"+e),e}return r(e.getHours())+":"+r(e.getMinutes())+":00"}function Q(e,r){var a=new Date("1/1/1999 "+e),t=new Date("1/1/1999 "+r);return(a.getTime()-t.getTime())/36e5}function V(e,r){var a=0,t=r,o=(e-r)/36e5,n=0,i=o,s=0;do{if(o>0){var l=K(t);R[0].rate;for(let e=0;e<R.length;e++){var u=R[e].start;if(l==u){if(e+1<R.length){o>=(s=Q(R[e+1].start,R[e].start))?n=s:o<s&&(n=o)}else if(e+1==R.length){let r=R[0].start;o>=(s=24-Q(R[e].start,r))?n=s:o<s&&(n=o)}a+=J(R[e].rate*n),o-=n,t=$(t,n)}else if(l>u)if(e+1<R.length){var d=R[e+1].start;l<d&&(o>=(s=Q(d,l))?n=s:o<s&&(n=o),a+=J(R[e].rate*n),o-=n,t=$(t,n))}else if(e==R.length-1){o>=(s=Q("23:59:59",l))?n=s:o<s&&(n=o),a+=J(R[e].rate*n),o-=n,t=$(t,n)}}}}while(o>0&&o<i);return a}if(D.length){let e=D.length-1;var ee=new Date(D[e].timestamp),re=new Date(D[0].timestamp);if("TempBasalDuration"==D[0]._type&&(re=new Date),(k=(re-ee)/36e5)<23.9&&k>21)Y=V(ee,(ae=24-k,te=ee.getTime(),new Date(te-36e5*ae))),q="24 hours of data is required for an accurate tdd calculation. Currently only "+k.toPrecision(3)+" hours of pump history data are available. Using your pump scheduled basals to fill in the missing hours. Scheduled basals added: "+Y.toPrecision(5)+" U. ";else q=""}else console.log("Pumphistory is empty!");var ae,te;for(let e=0;e<D.length;e++)"Bolus"==D[e]._type&&(X+=D[e].amount);for(let e=1;e<D.length;e++)if("TempBasal"==D[e]._type&&D[e].rate>0){z=e,N=D[e].rate;var oe=D[e-1]["duration (min)"]/60,ne=oe,ie=new Date(D[e-1].timestamp),se=ie;do{if(e--,0==e){se=new Date;break}if("TempBasal"==D[e]._type||"PumpSuspend"==D[e]._type){se=new Date(D[e].timestamp);break}}while(e>0);var le=(se-ie)/36e5;le<ne&&(oe=le),L+=J(N*oe),e=z}for(let e=0;e<D.length;e++)if(0,0==D[e]["duration (min)"]||"PumpResume"==D[e]._type){let r=new Date(D[e].timestamp),a=r,t=e;do{if(t>0&&(--t,"TempBasal"==D[t]._type)){a=new Date(D[t].timestamp);break}}while(t>0);(a-r)/36e5>0&&(Y+=V(a,r))}for(let e=D.length-1;e>0;e--)if("TempBasalDuration"==D[e]._type){let r=D[e]["duration (min)"]/60,a=new Date(D[e].timestamp);var ue=a;let t=e;do{if(--t,t>=0&&("TempBasal"==D[t]._type||"PumpSuspend"==D[t]._type)){ue=new Date(D[t].timestamp);break}}while(t>0);if(0==e&&"TempBasalDuration"==D[0]._type&&(ue=new Date,r=D[e]["duration (min)"]/60),(ue-a)/36e5-r>0){Y+=V(ue,$(a,r))}}var de=U=X+L+Y;k>21?(E=". Bolus insulin: "+X.toPrecision(5)+" U",W=". Temporary basal insulin: "+L.toPrecision(5)+" U",j=". Insulin with scheduled basal rate: "+Y.toPrecision(5)+" U",q+("TDD past 24h is: "+U.toPrecision(5)+" U")+E+W+j,tddReason=", TDD, 24h: "+o(U,1)+", ytd: "+o(H,1)+", 7dØ: "+o(Z,1)):tddReason=", TDD: Not enough pumpData (< 21h)";var me={},ce=new Date;if(G&&(ce=G),void 0===x||void 0===x.current_basal)return me.error="Error: could not get current basal rate",me;var pe=t(x.current_basal,x),ge=pe,be=new Date;G&&(be=G);var fe,he=new Date(e.date),ve=o((be-he)/60/1e3,1),_e=e.glucose,Be=e.noise;fe=n(e.delta,x);var Me=Math.min(e.delta,e.short_avgdelta),Se=Math.min(e.short_avgdelta,e.long_avgdelta),ye=Math.max(e.delta,e.short_avgdelta,e.long_avgdelta);(_e<=10||38===_e||Be>=3)&&(me.reason="CGM is calibrating, in ??? state, or noise is high");if(ve>12||ve<-5?me.reason="If current system time "+be+" is correct, then BG data is too old. The last BG data was read "+ve+"m ago at "+he:0===e.short_avgdelta&&0===e.long_avgdelta&&(e.last_cal&&e.last_cal<3?me.reason="CGM was just calibrated":me.reason="CGM data is unchanged ("+n(_e,x)+"+"+n(e.delta,x)+") for 5m w/ "+n(e.short_avgdelta,x)+" mg/dL ~15m change & "+n(e.long_avgdelta,x)+" mg/dL ~45m change"),_e<=10||38===_e||Be>=3||ve>12||ve<-5||0===e.short_avgdelta&&0===e.long_avgdelta)return r.rate>=ge?(me.reason+=". Canceling high temp basal of "+r.rate,me.deliverAt=ce,me.temp="absolute",me.duration=0,me.rate=0,me):0===r.rate&&r.duration>30?(me.reason+=". Shortening "+r.duration+"m long zero temp to 30m. ",me.deliverAt=ce,me.temp="absolute",me.duration=30,me.rate=0,me):(me.reason+=". Temp "+r.rate+" <= current basal "+ge+"U/hr; doing nothing. ",me);var xe,Fe,Ie,we,Te=x.max_iob;if(void 0!==x.min_bg&&(Fe=x.min_bg),void 0!==x.max_bg&&(Ie=x.max_bg),void 0!==x.enableSMB_high_bg_target&&(we=x.enableSMB_high_bg_target),void 0===x.min_bg||void 0===x.max_bg)return me.error="Error: could not determine target_bg. ",me;xe=(x.min_bg+x.max_bg)/2;var Ce=x.exercise_mode||x.high_temptarget_raises_sensitivity,Ge=100,De=160;if(x.half_basal_exercise_target&&(De=x.half_basal_exercise_target),Ce&&x.temptargetSet&&xe>Ge||x.low_temptarget_lowers_sensitivity&&x.temptargetSet&&xe<Ge){var Oe=De-Ge;sensitivityRatio=Oe*(Oe+xe-Ge)<=0?x.autosens_max:Oe/(Oe+xe-Ge),sensitivityRatio=Math.min(sensitivityRatio,x.autosens_max),sensitivityRatio=o(sensitivityRatio,2),process.stderr.write("Sensitivity ratio set to "+sensitivityRatio+" based on temp target of "+xe+"; ")}else void 0!==F&&F&&(sensitivityRatio=F.ratio,process.stderr.write("Autosens ratio: "+sensitivityRatio+"; "));if(sensitivityRatio&&(ge=x.current_basal*sensitivityRatio,(ge=t(ge,x))!==pe?process.stderr.write("Adjusting basal from "+pe+" to "+ge+"; "):process.stderr.write("Basal unchanged: "+ge+"; ")),x.temptargetSet);else if(void 0!==F&&F&&(x.sensitivity_raises_target&&F.ratio<1||x.resistance_lowers_target&&F.ratio>1)){Fe=o((Fe-60)/F.ratio)+60,Ie=o((Ie-60)/F.ratio)+60;var Re=o((xe-60)/F.ratio)+60;xe===(Re=Math.max(80,Re))?process.stderr.write("target_bg unchanged: "+Re+"; "):process.stderr.write("target_bg from "+xe+" to "+Re+"; "),xe=Re}var Ue=200,Ae=200,Pe=200;if(e.noise>=2){var ke=Math.max(1.1,x.noisyCGMTargetMultiplier);Math.min(250,x.maxRaw);Ue=o(Math.min(200,Fe*ke)),Ae=o(Math.min(200,xe*ke)),Pe=o(Math.min(200,Ie*ke)),process.stderr.write("Raising target_bg for noisy / raw CGM data, from "+xe+" to "+Ae+"; "),Fe=Ue,xe=Ae,Ie=Pe}var je=Fe-.5*(Fe-40),Ee=o(x.sens,1),We=x.sens;void 0!==F&&F&&((We=o(We=x.sens/sensitivityRatio,1))!==Ee?process.stderr.write("ISF from "+n(Ee,x)+" to "+n(We,x)):process.stderr.write("ISF unchanged: "+n(We,x)),i+="Autosens, Ratio: "+sensitivityRatio+", ISF: "+n(Ee,x)+"→"+n(We,x)),console.error("CR:"+x.carb_ratio),console.error("----------------------------------"),console.error(" start autoISF"),console.error("----------------------------------"),console.error("autoISFtimer start");var qe=function(e,r,a){if(e.use_autoisf&&e.iob_threshold>0&&e.iob_threshold<r[0].iob)return s=", autoISF-SMB disabled:, IOB: "+o(r[0].iob,2)+", > threshold: "+e.iob_threshold+", maxIOB: "+e.max_iob,console.error(s),"iobTH";if(e.use_autoisf&&e.temptargetSet&&e.enableSMB_EvenOn_OddOff){var t=n(a,e);return e.temptargetSet?msgType="TempTarget ":msgType="profile target ","mmol/L"==e.out_units?(evenTarget=o(10*t,0)%2==0,msgUnits=" has ",msgTail=" decimal"):(evenTarget=t%2==0,msgUnits=" is ",msgTail=" number"),evenTarget?msgEven="even":msgEven="odd",evenTarget?(console.error("SMB enabled - "+msgType+t+msgUnits+msgEven+msgTail),e.temptargetSet&&a<100?(console.error("Full Loop enabled"),s=", autoISF-SMB enabled:, even TT","fullLoop"):(s=", autoISF-SMB enforced:, even TT","enforced")):(console.error("SMB disabled - "+msgType+t+msgUnits+msgEven+msgTail),s=", autoISF-SMB disabled:, odd TT","blocked")}return"oref"}(x,a,xe),ze=!1;if(T&&"oref"!=qe?("enforced"!=qe&&"fullLoop"!=qe||(ze=!0),console.error("loopSMB function overriden with autoISF temptarget toggle, enableSMB = "+ze)):(ze=function(e,r,a,t,o,i){return r?!e.allowSMB_with_high_temptarget&&e.temptargetSet&&o>100?(console.error("SMB disabled due to high temptarget of "+o),!1):!0===a.bwFound&&!1===e.A52_risk_enable?(console.error("SMB disabled due to Bolus Wizard activity in the last 6 hours."),!1):!0===e.enableSMB_always?(a.bwFound?console.error("Warning: SMB enabled within 6h of using Bolus Wizard: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled due to enableSMB_always"),!0):!0===e.enableSMB_with_COB&&a.mealCOB?(a.bwCarbs?console.error("Warning: SMB enabled with Bolus Wizard carbs: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled for COB of",a.mealCOB),!0):!0===e.enableSMB_after_carbs&&a.carbs?(a.bwCarbs?console.error("Warning: SMB enabled with Bolus Wizard carbs: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled for 6h after carb entry"),!0):!0===e.enableSMB_with_temptarget&&e.temptargetSet&&o<100?(a.bwFound?console.error("Warning: SMB enabled within 6h of using Bolus Wizard: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled for temptarget of",n(o,e)),console.error("SMB enabled for temptargets with "+n(o,e)),!0):!0===e.enableSMB_high_bg&&null!==i&&t>=i?(console.error("Checking BG to see if High for SMB enablement."),console.error("Current BG",t," | High BG ",i),a.bwFound?console.error("Warning: High BG SMB enabled within 6h of using Bolus Wizard: be sure to easy bolus 30s before using Bolus Wizard"):console.error("High BG detected. Enabling SMB."),!0):(console.error("SMB disabled (no enableSMB preferences active or no condition satisfied)"),!1):(console.error("SMB disabled (!microBolusAllowed)"),!1)}(x,T,I,_e,xe,we),console.error("loopSMB function returns enableSMB = "+ze)),We=function(e,r,a,t,M,x,F,I){if(!a.use_autoisf)return console.error("autoISF disabled in Preferences"),i+=", autoISF, disabled",e;if(a.autoISF_off_Sport&&(a.high_temptarget_raises_sensitivity||a.exercise_mode)&&a.temptargetSet&&r>I)return console.error("autoISF disabled due to exercise"),i+=", autoISF, disabled (exercise)",e;const w=t.dura_p,T=t.delta_pl,C=t.delta_pn,G=t.r_squ,D=t.bg_acceleration,O=t.a_0,R=t.a_1,U=t.a_2,A=t.dura_ISF_minutes,P=t.dura_ISF_average;var k=!1,j=e,E=r+10-P;if(M.mealCOB>0&&!a.enableautoisf_with_COB)return console.error("BG dependant autoISF by-passed; preferences disabled mealCOB of "+o(M.mealCOB,1)),i+=", autoISF, disabled with COB",e;var W=t.pp_debug;if(m+="BG-accel: "+o(D,3)+", PF-minutes: "+w+", PF-corr: "+o(G,4)+", PF-nextDelta: "+n(C,a)+", PF-lastDelta: "+n(T,a)+", regular Delta: "+n(t.delta,a),console.error(W+m+" , Weights Accel/Brake: "+a.bgAccel_ISF_weight+" / "+a.bgBrake_ISF_weight),a.enable_BG_acceleration){var q=G,z=D;if(0!=t.parabola_fit_a2&&q>=.9){var L=-R/2/U*5,X=o(O-L*L/25*U,1);(L=o(L,1))>0&&z<0?(g="predicts a Max of "+n(X,a)+", in about "+Math.abs(L)+"min",console.error("Parabolic fit "+g)):L>0&&z>0?(g="predicts a Min of "+n(X,a)+", in about "+Math.abs(L)+"min",console.error("Parabolic fit "+g)):L<0&&z<0?(g="saw Max of "+n(X,a)+", about "+Math.abs(L)+"min ago",console.error("Parabolic fit "+g)):L<0&&z>0&&(g="saw Min of "+n(X,a)+", about "+Math.abs(L)+"min ago",console.error("Parabolic fit "+g))}if(q<.9)g="acce_ISF by-passed, as correlation, "+o(q,2)+", is too low",console.error("Parabolic fit "+g),c+=", Parabolic Fit, "+g;else{var Y=10*(q-.9),N=1,H=1;t.glucose<a.target_bg?z>0?(z>1&&(N=.5),H=a.bgBrake_ISF_weight):z<0&&(H=a.bgAccel_ISF_weight):z<0?H=a.bgBrake_ISF_weight:z>0&&(H=a.bgAccel_ISF_weight),(f=1+z*N*H*Y)<0&&(f=.1),console.error(c+" acce_ISF adaptation is "+o(f,2)),1!=f&&(k=!0,c+=", Parabolic Fit, "+g+", acce-ISF Ratio: "+o(f,2))}}else console.error("autoISF BG accelertion adaption disabled in Preferences");i+=s+c+", autoISF",h=1+S(100-E,a,"bg"),console.error("bg_ISF adaptation is "+o(h,2));var Z=1,$=1;if(h<1)return Z=Math.min(h,f),f>1?(p="bg-ISF adaptation lifted to "+o(Z=h*f,2)+", as BG accelerates already",console.error(p),i+=", bg-ISF Ratio: "+o(Z,2)+"(accel.)"):i+=", bg-ISF Ratio: "+o(Z,2),$=y(Z,a.autoISF_min,a.autoISF_max,F),j=(a.high_temptarget_raises_sensitivity||a.exercise_mode)&&a.temptargetSet&&r>I?Math.min(720,o(e/$,1)):Math.min(720,o(a.sens/$,1)),i+=u+d+l+", final Ratio: "+o($,2)+b+", final ISF: "+n(j,a),j;h>1&&(k=!0,i+=", bg-ISF Ratio: "+o(h,2));var J=t.delta;a.enablepp_ISF_always||a.pp_ISF_hours>=(x-M.lastCarbTime)/1e3/3600?deltaType="pp":deltaType="delta",E>0?console.error(deltaType+"_ISF adaptation by-passed as average glucose < "+r+"+10"):t.short_avgdelta<0?console.error(deltaType+"_ISF adaptation by-passed as no rise or too short lived"):"pp"==deltaType?(_=1+Math.max(0,J*a.pp_ISF_weight),console.error("pp_ISF adaptation is "+o(_,2)),u=", pp-ISF Ratio: "+o(_,2),1!=_&&(k=!0)):(v=S(J,a,"delta"),E>-20&&(v*=.5),v=1+v,console.error("delta_ISF adaptation is "+o(v,2)),d=", Δ-ISF Ratio: "+o(v,2),1!=v&&(k=!0));var K=a.dura_ISF_weight;M.mealCOB>0&&!a.enableautoisf_with_COB?console.error("dura_ISF by-passed; preferences disabled mealCOB of "+o(M.mealCOB,1)):A<10?console.error("dura_ISF by-passed; BG is only "+A+"m at level "+P):P<=r?console.error("dura_ISF by-passed; avg. glucose "+P+" below target "+n(r,a)):(B+=A/60*(K/r)*(P-r),k=!0,l=", Duration: "+A+", Avg: "+n(P,a)+", dura-ISF Ratio: "+o(B,2),console.error("dura_ISF adaptation is "+o(B,2)+" because ISF "+e+" did not do it for "+o(A,1)+"m"));return k?(Z=Math.max(B,h,v,f,_),console.error("autoISF adaption ratios:"),console.error("  dura "+o(B,2)),console.error("  bg "+o(h,2)),console.error("  delta "+o(v,2)),console.error("  pp "+o(_,2)),console.error("  accel "+o(f,2)),f<1&&(p="strongest ISF factor "+o(Z,2)+" weakened to "+o(Z*f,2)+" as bg decelerates already",console.error(p),Z*=f),$=y(Z,a.autoISF_min,a.autoISF_max,F),(a.high_temptarget_raises_sensitivity||a.exercise_mode)&&a.temptargetSet&&r>I?(j=o(e/$,1),console.error("autoISF adjusts sens "+j+", instead of profile.sens "+a.sens)):j=o(a.sens/$,1),i+=u+d+l+", final Ratio: "+o($,2)+b+", final ISF: "+n(j,a),j):(i+=", not modified",console.error("autoISF does not modify"),j)}(We,xe,x,e,I,G,sensitivityRatio,Ge),console.error("autoISFtimer end"),console.error("----------------------------------"),console.error(" end autoISF"),console.error("----------------------------------"),void 0===a)return me.error="Error: iob_data undefined. ",me;var Le,Xe=a;if(a.length,a.length>1&&(a=Xe[0]),void 0===a.activity||void 0===a.iob)return me.error="Error: iob_data missing some property. ",me;var Ye=((Le=void 0!==a.lastTemp?o((new Date(be).getTime()-a.lastTemp.date)/6e4):0)+r.duration)%30;if(console.error("currenttemp:"+r.rate+" lastTempAge:"+Le+"m, tempModulus:"+Ye+"m"),me.temp="absolute",me.deliverAt=ce,T&&r&&a.lastTemp&&r.rate!==a.lastTemp.rate&&Le>10&&r.duration)return me.reason="Warning: currenttemp rate "+r.rate+" != lastTemp rate "+a.lastTemp.rate+" from pumphistory; canceling temp",w.setTempBasal(0,0,x,me,r);if(r&&a.lastTemp&&r.duration>0){var Ne=Le-a.lastTemp.duration;if(Ne>5&&Le>10)return me.reason="Warning: currenttemp running but lastTemp from pumphistory ended "+Ne+"m ago; canceling temp",w.setTempBasal(0,0,x,me,r)}var He=o(-a.activity*We*5,2),Ze=o(6*(Me-He));Ze<0&&(Ze=o(6*(Se-He)))<0&&(Ze=o(6*(e.long_avgdelta-He)));var $e=_e,Je=($e=a.iob>0?o(_e-a.iob*We):o(_e-a.iob*Math.min(We,x.sens)))+Ze;if(void 0===Je||isNaN(Je))return me.error="Error: could not calculate eventualBG. Sensitivity: "+We+" Deviation: "+Ze,me;var Ke=function(e,r,a){return o(a+(e-r)/24,1)}(xe,Je,He);me={temp:"absolute",bg:n(_e,x),tick:fe,eventualBG:n(Je,x),insulinReq:0,reservoir:C,deliverAt:ce,sensitivityRatio};var Qe=[],Ve=[],er=[],rr=[];Qe.push(_e),Ve.push(_e),rr.push(_e),er.push(_e);var ar=x.enableUAM,tr=0,or=0;tr=o(Me-He,1);var nr=o(Me-He,1);csf=We/x.carb_ratio,console.error("profile.sens:"+n(x.sens,x)+", sens:"+n(We,x)+", CSF:"+o(csf,1));var ir=o(30*csf*5/60,1);tr>ir&&(console.error("Limiting carb impact from "+tr+" to "+ir+"mg/dL/5m (30g/h)"),tr=ir);var sr=3;sensitivityRatio&&(sr/=sensitivityRatio);var lr=sr;if(I.carbs){sr=Math.max(sr,I.mealCOB/20);var ur=o((new Date(be).getTime()-I.lastCarbTime)/6e4),dr=(I.carbs-I.mealCOB)/I.carbs;lr=o(lr=sr+1.5*ur/60,1),console.error("Last carbs "+ur+" minutes ago; remainingCATime:"+lr+"hours; "+o(100*dr)+"% carbs absorbed")}var mr=Math.max(0,tr/5*60*lr/2)/csf,cr=90,pr=1;x.remainingCarbsCap&&(cr=Math.min(90,x.remainingCarbsCap)),x.remainingCarbsFraction&&(pr=Math.min(1,x.remainingCarbsFraction));var gr=1-pr,br=Math.max(0,I.mealCOB-mr-I.carbs*gr),fr=(br=Math.min(cr,br))*csf*5/60/(lr/2),hr=o(I.slopeFromMaxDeviation,2),vr=o(I.slopeFromMinDeviation,2),_r=Math.min(hr,-vr/3),Br=0;0===tr?or=0:!0===x.floating_carbs?(or=Math.min(60*lr/5/2,Math.max(0,I.carbs*csf/tr)),Br=Math.min(60*lr/5/2,Math.max(0,I.mealCOB*csf/tr)),I.carbs>0&&(i+=", Floating Carbs:, CID: "+o(or,1)+", MealCarbs: "+o(I.carbs,1)+", Not Floating:, CID: "+o(Br,1)+", MealCOB: "+o(I.mealCOB,1),console.error("Floating Carbs CID: "+o(or,1)+" / MealCarbs: "+o(I.carbs,1)+" vs. Not Floating:"+o(Br,1)+" / MealCOB:"+o(I.mealCOB,1)))):or=Math.min(60*lr/5/2,Math.max(0,I.mealCOB*csf/tr)),console.error("Carb Impact:"+tr+"mg/dL per 5m; CI Duration:"+o(5*or/60*2,1)+"hours; remaining CI ("+lr/2+"h peak):",o(fr,1)+"mg/dL per 5m");var Mr,Sr,yr,xr,Fr,Ir=999,wr=999,Tr=999,Cr=_e,Gr=999,Dr=999,Or=999,Rr=999,Ur=Je,Ar=_e,Pr=_e,kr=0,jr=[],Er=[];try{Xe.forEach((function(e){var r=o(-e.activity*We*5,2),a=o(-e.iobWithZeroTemp.activity*We*5,2),t=tr*(1-Math.min(1,Ve.length/12));Ur=Ve[Ve.length-1]+r+t;var n=rr[rr.length-1]+a,i=Math.max(0,Math.max(0,tr)*(1-Qe.length/Math.max(2*or,1))),s=Math.min(Qe.length,12*lr-Qe.length),l=Math.max(0,s/(lr/2*12)*fr);i+l,jr.push(o(l,0)),Er.push(o(i,0)),COBpredBG=Qe[Qe.length-1]+r+Math.min(0,t)+i+l;var u=Math.max(0,nr+er.length*_r),d=Math.max(0,nr*(1-er.length/Math.max(36,1))),m=Math.min(u,d);m>0&&(kr=o(5*(er.length+1)/60,1)),UAMpredBG=er[er.length-1]+r+Math.min(0,t)+m,Ve.length<48&&Ve.push(Ur),Qe.length<48&&Qe.push(COBpredBG),er.length<48&&er.push(UAMpredBG),rr.length<48&&rr.push(n),COBpredBG<Gr&&(Gr=o(COBpredBG)),UAMpredBG<Dr&&(Dr=o(UAMpredBG)),Ur<Or&&(Or=o(Ur)),n<Rr&&(Rr=o(n));Ve.length>18&&Ur<Ir&&(Ir=o(Ur)),Ur>Ar&&(Ar=Ur),(or||fr>0)&&Qe.length>18&&COBpredBG<wr&&(wr=o(COBpredBG)),(or||fr>0)&&COBpredBG>Ar&&(Pr=COBpredBG),ar&&er.length>12&&UAMpredBG<Tr&&(Tr=o(UAMpredBG)),ar&&UAMpredBG>Ar&&UAMpredBG}))}catch(e){console.error("Problem with iobArray.  Optional feature Advanced Meal Assist disabled")}me.predBGs={},Ve.forEach((function(e,r,a){a[r]=o(Math.min(401,Math.max(39,e)))}));for(var Wr=Ve.length-1;Wr>12&&Ve[Wr-1]===Ve[Wr];Wr--)Ve.pop();for(me.predBGs.IOB=Ve,yr=o(Ve[Ve.length-1]),rr.forEach((function(e,r,a){a[r]=o(Math.min(401,Math.max(39,e)))})),Wr=rr.length-1;Wr>6&&!(rr[Wr-1]>=rr[Wr]||rr[Wr]<=xe);Wr--)rr.pop();if(me.predBGs.ZT=rr,o(rr[rr.length-1]),I.mealCOB>0&&(tr>0||fr>0)){for(Qe.forEach((function(e,r,a){a[r]=o(Math.min(401,Math.max(39,e)))})),Wr=Qe.length-1;Wr>12&&Qe[Wr-1]===Qe[Wr];Wr--)Qe.pop();me.predBGs.COB=Qe,xr=o(Qe[Qe.length-1]),Je=Math.max(Je,o(Qe[Qe.length-1]))}if(tr>0||fr>0){if(ar){for(er.forEach((function(e,r,a){a[r]=o(Math.min(401,Math.max(39,e)))})),Wr=er.length-1;Wr>12&&er[Wr-1]===er[Wr];Wr--)er.pop();me.predBGs.UAM=er,Fr=o(er[er.length-1]),er[er.length-1]&&(Je=Math.max(Je,o(er[er.length-1])))}me.eventualBG=Je}console.error("UAM Impact:"+nr+"mg/dL per 5m; UAM Duration:"+kr+"hours"),Ir=Math.max(39,Ir),wr=Math.max(39,wr),Tr=Math.max(39,Tr),Mr=o(Ir);var qr=I.mealCOB/I.carbs;Sr=o(Tr<999&&wr<999?(1-qr)*UAMpredBG+qr*COBpredBG:wr<999?(Ur+COBpredBG)/2:Tr<999?(Ur+UAMpredBG)/2:Ur),Rr>Sr&&(Sr=Rr),Cr=o(Cr=or||fr>0?ar?qr*Gr+(1-qr)*Dr:Gr:ar?Dr:Or);var zr=Tr;if(Rr<je)zr=(Tr+Rr)/2;else if(Rr<xe){var Lr=(Rr-je)/(xe-je);zr=(Tr+(Tr*Lr+Rr*(1-Lr)))/2}else Rr>Tr&&(zr=(Tr+Rr)/2);if(zr=o(zr),I.carbs)if(!ar&&wr<999)Mr=o(Math.max(Ir,wr));else if(wr<999){var Xr=qr*wr+(1-qr)*zr;Mr=o(Math.max(Ir,wr,Xr))}else Mr=ar?zr:Cr;else ar&&(Mr=o(Math.max(Ir,zr)));Mr=Math.min(Mr,Sr),process.stderr.write("minPredBG: "+n(Mr,x)+" minIOBPredBG: "+n(Ir,x)+" minZTGuardBG: "+n(Rr,x)),wr<999&&process.stderr.write(" minCOBPredBG: "+n(wr,x)),Tr<999&&process.stderr.write(" minUAMPredBG: "+n(Tr,x)),console.error(" avgPredBG:"+n(Sr,x)+" COB/Carbs:"+I.mealCOB+"/"+I.carbs),Pr>_e&&(Mr=Math.min(Mr,Pr)),me.COB=I.mealCOB,me.IOB=a.iob,me.BGI=n(He,x),me.deviation=n(Ze,x),me.dura_ISFratio=o(B,2),me.bg_ISFratio=o(h,2),me.delta_ISFratio=o(v,2),me.pp_ISFratio=o(_,2),me.acce_ISFratio=o(f,2),me.auto_ISFratio=o(1==M?sensitivityRatio:M,2),me.ISF=n(We,x),me.CR=o(x.carb_ratio,2),me.TDD=o(de,1),me.TDDytd=o(H,1),me.TDD7d=o(Z,1),me.target_bg=n(xe,x);var Yr=function(e,r,a,t){if(!e.use_autoisf)return console.error("autoISF disabled, don't adjust SMB Delivery Ratio"),.5;if(0===e.smb_delivery_ratio_bg_range||"fullLoop"===t)return console.error("SMB delivery ratio set to fixed value "+e.smb_delivery_ratio),e.smb_delivery_ratio;var n=Math.min(e.smb_delivery_ratio_min,e.smb_delivery_ratio_max);if(r<=a)return console.error("SMB delivery ratio limited by minimum value "+n),n;var i=Math.max(e.smb_delivery_ratio_min,e.smb_delivery_ratio_max);if(r>=a+e.smb_delivery_ratio_bg_range)return console.error("SMB delivery ratio limited by maximum value "+i),i;var s=n+(i-n)*(r-a)/e.smb_delivery_ratio_bg_range;return console.error("SMB delivery ratio set to interpolated value "+o(s,2)),s}(x,_e,xe,qe);me.SMBratio=o(Yr,2);var Nr="SMB Ratio:, "+o(Yr,2)+", ";me.reason=Nr+i+", Standard, COB: "+me.COB+", Dev: "+me.deviation+", BGI: "+me.BGI+", ISF: "+me.ISF+", CR: "+me.CR+", Target: "+me.target_bg+", minPredBG "+n(Mr,x)+", minGuardBG "+n(Cr,x)+", IOBpredBG "+n(yr,x),xr>0&&(me.reason+=", COBpredBG "+n(xr,x)),Fr>0&&(me.reason+=", UAMpredBG "+n(Fr,x)),me.reason+=tddReason,me.reason+="; ";var Hr=$e;Hr<40&&(Hr=Math.min(Cr,Hr));var Zr=je-Hr,$r=240,Jr=240;if(I.mealCOB>0&&(tr>0||fr>0)){for(Wr=0;Wr<Qe.length;Wr++)if(Qe[Wr]<Fe){$r=5*Wr;break}for(Wr=0;Wr<Qe.length;Wr++)if(Qe[Wr]<je){Jr=5*Wr;break}}else{for(Wr=0;Wr<Ve.length;Wr++)if(Ve[Wr]<Fe){$r=5*Wr;break}for(Wr=0;Wr<Ve.length;Wr++)if(Ve[Wr]<je){Jr=5*Wr;break}}ze&&Cr<je&&(console.error("minGuardBG "+n(Cr,x)+" projected below "+n(je,x)+" - disabling SMB"),ze=!1);var Kr=.2;void 0!==x.maxDelta_bg_threshold&&"fullLoop"==qe&&(Kr=Math.min(x.maxDelta_bg_threshold,.4)),ye>Kr*_e&&(console.error("maxDelta "+n(ye,x)+" > "+100*Kr+"% of BG "+n(_e,x)+" - disabling SMB"),me.reason+="maxDelta "+n(ye,x)+" > "+100*Kr+"% of BG "+n(_e,x)+" - SMB disabled!, ",ze=!1),console.error("BG projected to remain above "+n(Fe,x)+" for "+$r+"minutes"),(Jr<240||$r<60)&&console.error("BG projected to remain above "+n(je,x)+" for "+Jr+"minutes");var Qr=Jr,Vr=x.current_basal*We*Qr/60,ea=Math.max(0,I.mealCOB-.25*I.carbs),ra=(Zr-Vr)/csf-ea;Vr=o(Vr),ra=o(ra),console.error("naive_eventualBG: "+n($e,x)+", bgUndershoot: "+n(Zr,x)+", zeroTempDuration: "+Qr+", zeroTempEffect: "+Vr+", carbsReq: "+ra),"Could not parse clock data"==I.reason?console.error("carbsReq unknown: Could not parse clock data"):ra>=x.carbsReqThreshold&&Jr<=45&&(me.carbsReq=ra,me.reason+=ra+" add'l carbs req w/in "+Jr+"m; ");var aa=0;if(_e<je&&a.iob<20*-x.current_basal/60&&Me>0&&Me>Ke)me.reason+="IOB "+a.iob+" < "+o(20*-x.current_basal/60,2),me.reason+=" and minDelta "+n(Me,x)+" > expectedDelta "+n(Ke,x)+"; ";else if(_e<je||Cr<je)return me.reason+="minGuardBG "+n(Cr,x)+"<"+n(je,x),aa=o(60*((Zr=xe-Cr)/We)/x.current_basal),aa=30*o(aa/30),aa=Math.min(120,Math.max(30,aa)),w.setTempBasal(0,aa,x,me,r);if(x.skip_neutral_temps&&me.deliverAt.getMinutes()>=55)return me.reason+="; Canceling temp at "+me.deliverAt.getMinutes()+"m past the hour. ",w.setTempBasal(0,0,x,me,r);var ta=0,oa=ge;if(Je<Fe){if(me.reason+="Eventual BG "+n(Je,x)+" < "+n(Fe,x),Me>Ke&&Me>0&&!ra)return $e<40?(me.reason+=", naive_eventualBG < 40. ",w.setTempBasal(0,30,x,me,r)):(e.delta>Me?me.reason+=", but Delta "+n(fe,x)+" > expectedDelta "+n(Ke,x):me.reason+=", but Min. Delta "+Me.toFixed(2)+" > Exp. Delta "+n(Ke,x),r.duration>15&&t(ge,x)===t(r.rate,x)?(me.reason+=", temp "+r.rate+" ~ req "+ge+"U/hr. ",me):(me.reason+="; setting current basal of "+ge+" as temp. ",w.setTempBasal(ge,30,x,me,r)));ta=o(ta=2*Math.min(0,(Je-xe)/We),2);var na=Math.min(0,($e-xe)/We);if(na=o(na,2),Me<0&&Me>Ke)ta=o(ta*(Me/Ke),2);if(oa=t(oa=ge+2*ta,x),r.duration*(r.rate-ge)/60<Math.min(ta,na)-.3*ge)return me.reason+=", "+r.duration+"m@"+r.rate.toFixed(2)+" is a lot less than needed. ",w.setTempBasal(oa,30,x,me,r);if(void 0!==r.rate&&r.duration>5&&oa>=.8*r.rate)return me.reason+=", temp "+r.rate+" ~< req "+oa+"U/hr. ",me;if(oa<=0){if((aa=o(60*((Zr=xe-$e)/We)/x.current_basal))<0?aa=0:(aa=30*o(aa/30),aa=Math.min(120,Math.max(0,aa))),aa>0)return me.reason+=", setting "+aa+"m zero temp. ",w.setTempBasal(oa,aa,x,me,r)}else me.reason+=", setting "+oa+"U/hr. ";return w.setTempBasal(oa,30,x,me,r)}if(Me<Ke&&(!T||!ze))return e.delta<Me?me.reason+="Eventual BG "+n(Je,x)+" > "+n(Fe,x)+" but Delta "+n(fe,x)+" < Exp. Delta "+n(Ke,x):me.reason+="Eventual BG "+n(Je,x)+" > "+n(Fe,x)+" but Min. Delta "+Me.toFixed(2)+" < Exp. Delta "+n(Ke,x),r.duration>15&&t(ge,x)===t(r.rate,x)?(me.reason+=", temp "+r.rate+" ~ req "+ge+"U/hr. ",me):(me.reason+="; setting current basal of "+ge+" as temp. ",w.setTempBasal(ge,30,x,me,r));if(Math.min(Je,Mr)<Ie&&(!T||!ze))return me.reason+=n(Je,x)+"-"+n(Mr,x)+" in range: no temp required",r.duration>15&&t(ge,x)===t(r.rate,x)?(me.reason+=", temp "+r.rate+" ~ req "+ge+"U/hr. ",me):(me.reason+="; setting current basal of "+ge+" as temp. ",w.setTempBasal(ge,30,x,me,r));if(Je>=Ie&&(me.reason+="Eventual BG "+n(Je,x)+" >= "+n(Ie,x)+", "),a.iob>Te)return me.reason+="IOB "+o(a.iob,2)+" > max_iob "+Te,r.duration>15&&t(ge,x)===t(r.rate,x)?(me.reason+=", temp "+r.rate+" ~ req "+ge+"U/hr. ",me):(me.reason+="; setting current basal of "+ge+" as temp. ",w.setTempBasal(ge,30,x,me,r));(ta=o((Math.min(Mr,Je)-xe)/We,2))>Te-a.iob&&(me.reason+="max_iob "+Te+", ",ta=Te-a.iob),oa=t(oa=ge+2*ta,x),ta=o(ta,3),me.insulinReq=ta;var ia=o((new Date(be).getTime()-a.lastBolusTime)/6e4,1);if(T&&ze&&_e>je){var sa=o(I.mealCOB/x.carb_ratio,3);if(x.use_autoisf)la=x.smb_max_range_extension;else{console.error("autoISF disabled, SMB range extension disabled");var la=1}la>1&&console.error("SMB max range extended from default by factor "+la);var ua=0;void 0===x.maxSMBBasalMinutes?(ua=o(la*x.current_basal*30/60,1),console.error("profile.maxSMBBasalMinutes undefined: defaulting to 30m")):a.iob>sa&&a.iob>0?(console.error("IOB",a.iob,"> COB",I.mealCOB+"; mealInsulinReq =",sa),x.maxUAMSMBBasalMinutes?(console.error("profile.maxUAMSMBBasalMinutes:",x.maxUAMSMBBasalMinutes,"profile.current_basal:",x.current_basal),ua=o(la*x.current_basal*x.maxUAMSMBBasalMinutes/60,1)):(console.error("profile.maxUAMSMBBasalMinutes undefined: defaulting to 30m"),ua=o(30*x.current_basal/60,1))):(console.error("profile.maxSMBBasalMinutes:",x.maxSMBBasalMinutes,"profile.current_basal:",x.current_basal),ua=o(la*x.current_basal*x.maxSMBBasalMinutes/60,1));var da=x.bolus_increment,ma=1/da;x.use_autoisf||(console.error("autoISF disabled, don't adjust SMB Delivery Ratio"),Yr=.5),Yr>.5&&console.error("SMB Delivery Ratio increased from default 0.5 to "+o(Yr,2));var ca=Math.min(ta*Yr,ua);ca=Math.floor(ca*ma)/ma,aa=o(60*((xe-($e+Ir)/2)/We)/x.current_basal),ta>0&&ca<da&&(aa=0);var pa=0;aa<=0?aa=0:aa>=30?(aa=30*o(aa/30),aa=Math.min(60,Math.max(0,aa))):(pa=o(ge*aa/30,2),aa=30),me.reason+=" insulinReq "+ta,ca>=ua&&(me.reason+="; maxBolus "+ua),aa>0&&(me.reason+="; setting "+aa+"m low temp of "+pa+"U/h"),me.reason+=". ";var ga=3;x.SMBInterval&&(ga=Math.min(10,Math.max(1,x.SMBInterval)));var ba=o(ga-ia,0),fa=o(60*(ga-ia),0)%60;if(console.error("naive_eventualBG "+n($e,x)+", "+aa+"m "+pa+"U/h temp needed; last bolus "+ia+"m ago; maxBolus: "+ua),ia>ga?ca>0&&(me.units=ca,me.reason+="Microbolusing "+ca+"U. "):me.reason+="Waiting "+ba+"m "+fa+"s to microbolus again. ",aa>0)return me.rate=pa,me.duration=aa,me}var ha=w.getMaxSafeBasal(x);return oa>ha&&(me.reason+="adj. req. rate: "+o(oa,2)+" to maxSafeBasal: "+o(ha,2)+", ",oa=t(ha,x)),r.duration*(r.rate-ge)/60>=2*ta?(me.reason+=r.duration+"m@"+r.rate.toFixed(2)+" > 2 * insulinReq. Setting temp basal of "+oa+"U/hr. ",w.setTempBasal(oa,30,x,me,r)):void 0===r.duration||0===r.duration?(me.reason+="no temp, setting "+oa+"U/hr. ",w.setTempBasal(oa,30,x,me,r)):r.duration>5&&t(oa,x)<=t(r.rate,x)?(me.reason+="temp "+r.rate+" >~ req "+oa+"U/hr. ",me):(me.reason+="temp "+r.rate+"<"+oa+"U/hr. ",w.setTempBasal(oa,30,x,me,r))}},6880:(e,r,a)=>{var t=a(6654);e.exports=function(e,r){var a=20;void 0!==r&&"string"==typeof r.model&&(t(r.model,"54")||t(r.model,"23"))&&(a=40);return e<1?Math.round(e*a)/a:e<10?Math.round(20*e)/20:Math.round(10*e)/10}},2705:(e,r,a)=>{var t=a(5639).Symbol;e.exports=t},9932:e=>{e.exports=function(e,r){for(var a=-1,t=null==e?0:e.length,o=Array(t);++a<t;)o[a]=r(e[a],a,e);return o}},9750:e=>{e.exports=function(e,r,a){return e==e&&(void 0!==a&&(e=e<=a?e:a),void 0!==r&&(e=e>=r?e:r)),e}},4239:(e,r,a)=>{var t=a(2705),o=a(9607),n=a(2333),i=t?t.toStringTag:void 0;e.exports=function(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":i&&i in Object(e)?o(e):n(e)}},531:(e,r,a)=>{var t=a(2705),o=a(9932),n=a(1469),i=a(3448),s=t?t.prototype:void 0,l=s?s.toString:void 0;e.exports=function e(r){if("string"==typeof r)return r;if(n(r))return o(r,e)+"";if(i(r))return l?l.call(r):"";var a=r+"";return"0"==a&&1/r==-Infinity?"-0":a}},7561:(e,r,a)=>{var t=a(7990),o=/^\s+/;e.exports=function(e){return e?e.slice(0,t(e)+1).replace(o,""):e}},1957:(e,r,a)=>{var t="object"==typeof a.g&&a.g&&a.g.Object===Object&&a.g;e.exports=t},9607:(e,r,a)=>{var t=a(2705),o=Object.prototype,n=o.hasOwnProperty,i=o.toString,s=t?t.toStringTag:void 0;e.exports=function(e){var r=n.call(e,s),a=e[s];try{e[s]=void 0;var t=!0}catch(e){}var o=i.call(e);return t&&(r?e[s]=a:delete e[s]),o}},2333:e=>{var r=Object.prototype.toString;e.exports=function(e){return r.call(e)}},5639:(e,r,a)=>{var t=a(1957),o="object"==typeof self&&self&&self.Object===Object&&self,n=t||o||Function("return this")();e.exports=n},7990:e=>{var r=/\s/;e.exports=function(e){for(var a=e.length;a--&&r.test(e.charAt(a)););return a}},6654:(e,r,a)=>{var t=a(9750),o=a(531),n=a(554),i=a(9833);e.exports=function(e,r,a){e=i(e),r=o(r);var s=e.length,l=a=void 0===a?s:t(n(a),0,s);return(a-=r.length)>=0&&e.slice(a,l)==r}},1469:e=>{var r=Array.isArray;e.exports=r},3218:e=>{e.exports=function(e){var r=typeof e;return null!=e&&("object"==r||"function"==r)}},7005:e=>{e.exports=function(e){return null!=e&&"object"==typeof e}},3448:(e,r,a)=>{var t=a(4239),o=a(7005);e.exports=function(e){return"symbol"==typeof e||o(e)&&"[object Symbol]"==t(e)}},8601:(e,r,a)=>{var t=a(4841),o=1/0;e.exports=function(e){return e?(e=t(e))===o||e===-1/0?17976931348623157e292*(e<0?-1:1):e==e?e:0:0===e?e:0}},554:(e,r,a)=>{var t=a(8601);e.exports=function(e){var r=t(e),a=r%1;return r==r?a?r-a:r:0}},4841:(e,r,a)=>{var t=a(7561),o=a(3218),n=a(3448),i=/^[-+]0x[0-9a-f]+$/i,s=/^0b[01]+$/i,l=/^0o[0-7]+$/i,u=parseInt;e.exports=function(e){if("number"==typeof e)return e;if(n(e))return NaN;if(o(e)){var r="function"==typeof e.valueOf?e.valueOf():e;e=o(r)?r+"":r}if("string"!=typeof e)return 0===e?e:+e;e=t(e);var a=s.test(e);return a||l.test(e)?u(e.slice(2),a?2:8):i.test(e)?NaN:+e}},9833:(e,r,a)=>{var t=a(531);e.exports=function(e){return null==e?"":t(e)}}},r={};function a(t){var o=r[t];if(void 0!==o)return o.exports;var n=r[t]={exports:{}};return e[t](n,n.exports,a),n.exports}a.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}();var t=a(5546);freeaps_determineBasal=t})();