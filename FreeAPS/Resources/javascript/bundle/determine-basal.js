var freeaps_determineBasal;(()=>{var e={5546:(e,r,a)=>{var t=a(6880);function o(e,r){r||(r=0);var a=Math.pow(10,r);return Math.round(e*a)/a}function n(e,r){return"mmol/L"===r.out_units?o(.0555*e,1):Math.round(e)}var i="",s="",l="",u="",d="",m="",c="",p="",b="",g="",f="",h=1,v=1,B=1,_=1,M=1;function S(e,r,a){"bg"==a?(polyX=[50,60,80,90,100,110,150,180,200],polyY=[-.5,-.5,-.3,-.2,0,0,.5,.7,.7]):"delta"==a&&(polyX=[2,7,12,16,20],polyY=[0,0,.4,.7,.7]);var t=polyX.length-1,o=polyX[0],n=polyY[0],i=polyX[t],s=polyY[t],l=1,u=1,d=1,m=o;if(o>e)i=polyX[1],l=(u=n)+((s=polyY[1])-u)/(i-(d=o))*(e-d);else if(i<e)o=polyX[t-1],l=(u=n=polyY[t-1])+(s-u)/(i-(d=o))*(e-d);else for(var c=0;c<=t;c++){if(o=polyX[c],n=polyY[c],o==e){l=n;break}if(o>e){l=u+(n-u)/(o-(d=m))*(e-d);break}u=n,m=o}return l*="delta"==a?r.delta_ISFrange_weight:e>100?r.higher_ISFrange_weight:r.lower_ISFrange_weight}function y(e,r,a,t,n,i,s,l,u){console.error("check ratio "+o(e,2)+" against autoISF min: "+r+" and autoISF max: "+a),e<r?(b=" (lmtd.min)",c="weakest autoISF factor "+o(e,2)+" limited by autoISF_min "+r,console.error(c),e=r):e>a&&(b=" (lmtd.max)",c="strongest autoISF factor "+o(e,2)+" limited by autoISF_max "+a,console.error(c),e=a);var d=1;return s&&i.temptargetSet&&l>u?(d=e*t,n=" (exerciseMode)",console.error("autoISF adjusts sens "+t+", instead of profile.sens "+i.sens),g=n):e>=1?(d=Math.max(e,t),e>=t&&(n="")):(d=Math.min(e,t),e<=t&&(n="")),c="final ISF factor "+o(d,2)+n,console.error(c),d}e.exports=function(e,r,a,x,F,I,w,T,C,D,G,O,R,U){var A=0,P="",E="",j="",k="",q="",W=0,z=0,N=0,L=0,X=0,Y=0;const H=U.tddYtd,Z=U.tdd7d;function $(e,r){var a=e.getTime();return new Date(a+36e5*r)}function J(e){var r=x.bolus_increment;.025!=r&&(r=.05);var a=e/r;return a>=1?o(Math.floor(a)*r,5):0}function K(e){function r(e){return e<10&&(e="0"+e),e}return r(e.getHours())+":"+r(e.getMinutes())+":00"}function Q(e,r){var a=new Date("1/1/1999 "+e),t=new Date("1/1/1999 "+r);return(a.getTime()-t.getTime())/36e5}function V(e,r){var a=0,t=r,o=(e-r)/36e5,n=0,i=o,s=0;do{if(o>0){var l=K(t);R[0].rate;for(let e=0;e<R.length;e++){var u=R[e].start;if(l==u){if(e+1<R.length){o>=(s=Q(R[e+1].start,R[e].start))?n=s:o<s&&(n=o)}else if(e+1==R.length){let r=R[0].start;o>=(s=24-Q(R[e].start,r))?n=s:o<s&&(n=o)}a+=J(R[e].rate*n),o-=n,t=$(t,n)}else if(l>u)if(e+1<R.length){var d=R[e+1].start;l<d&&(o>=(s=Q(d,l))?n=s:o<s&&(n=o),a+=J(R[e].rate*n),o-=n,t=$(t,n))}else if(e==R.length-1){o>=(s=Q("23:59:59",l))?n=s:o<s&&(n=o),a+=J(R[e].rate*n),o-=n,t=$(t,n)}}}}while(o>0&&o<i);return a}if(G.length){let e=G.length-1;var ee=new Date(G[e].timestamp),re=new Date(G[0].timestamp);if("TempBasalDuration"==G[0]._type&&(re=new Date),(A=(re-ee)/36e5)<23.9&&A>21)X=V(ee,(ae=24-A,te=ee.getTime(),new Date(te-36e5*ae))),k="24 hours of data is required for an accurate tdd calculation. Currently only "+A.toPrecision(3)+" hours of pump history data are available. Using your pump scheduled basals to fill in the missing hours. Scheduled basals added: "+X.toPrecision(5)+" U. ";else A<21?(dynISFenabled=!1,enableDynamicCR=!1):k=""}else console.log("Pumphistory is empty!"),dynISFenabled=!1,enableDynamicCR=!1;var ae,te;for(let e=0;e<G.length;e++)"Bolus"==G[e]._type&&(L+=G[e].amount);for(let e=1;e<G.length;e++)if("TempBasal"==G[e]._type&&G[e].rate>0){W=e,Y=G[e].rate;var oe=G[e-1]["duration (min)"]/60,ne=oe,ie=new Date(G[e-1].timestamp),se=ie;do{if(e--,0==e){se=new Date;break}if("TempBasal"==G[e]._type||"PumpSuspend"==G[e]._type){se=new Date(G[e].timestamp);break}}while(e>0);var le=(se-ie)/36e5;le<ne&&(oe=le),N+=J(Y*oe),e=W}for(let e=0;e<G.length;e++)if(0,0==G[e]["duration (min)"]||"PumpResume"==G[e]._type){let r=new Date(G[e].timestamp),a=r,t=e;do{if(t>0&&(--t,"TempBasal"==G[t]._type)){a=new Date(G[t].timestamp);break}}while(t>0);(a-r)/36e5>0&&(X+=V(a,r))}for(let e=G.length-1;e>0;e--)if("TempBasalDuration"==G[e]._type){let r=G[e]["duration (min)"]/60,a=new Date(G[e].timestamp);var ue=a;let t=e;do{if(--t,t>=0&&("TempBasal"==G[t]._type||"PumpSuspend"==G[t]._type)){ue=new Date(G[t].timestamp);break}}while(t>0);if(0==e&&"TempBasalDuration"==G[0]._type&&(ue=new Date,r=G[e]["duration (min)"]/60),(ue-a)/36e5-r>0){X+=V(ue,$(a,r))}}var de={TDD:o(z=L+N+X,5),bolus:o(L,5),temp_basal:o(N,5),scheduled_basal:o(X,5)},me=z;A>21?(E=". Bolus insulin: "+L.toPrecision(5)+" U",j=". Temporary basal insulin: "+N.toPrecision(5)+" U",P=". Insulin with scheduled basal rate: "+X.toPrecision(5)+" U",q=k+(" TDD past 24h is: "+z.toPrecision(5)+" U")+E+j+P,tddReason=", TDD, 24h: "+o(z,1)+", ytd: "+o(H,1)+", 7d√ò: "+o(Z,1),console.error(q)):tddReason=", TDD: Not enough pumpData (< 21h)";var ce={},pe=new Date;if(D&&(pe=D),void 0===x||void 0===x.current_basal)return ce.error="Error: could not get current basal rate",ce;var be=t(x.current_basal,x),ge=be,fe=new Date;D&&(fe=D);var he,ve=new Date(e.date),Be=o((fe-ve)/60/1e3,1),_e=e.glucose,Me=e.noise;he=n(e.delta,x);var Se=Math.min(e.delta,e.short_avgdelta),ye=Math.min(e.short_avgdelta,e.long_avgdelta),xe=Math.max(e.delta,e.short_avgdelta,e.long_avgdelta);(_e<=10||38===_e||Me>=3)&&(ce.reason="CGM is calibrating, in ??? state, or noise is high");if(Be>12||Be<-5?ce.reason="If current system time "+fe+" is correct, then BG data is too old. The last BG data was read "+Be+"m ago at "+ve:_e>60&&e.cgmFlatMinutes>89&&(e.last_cal&&e.last_cal<3?ce.reason="CGM was just calibrated":ce.reason="Error: CGM data was suspiciously flat for the past ~"+o(e.cgmFlatMinutes,1)+"m"),_e<=10||38===_e||Me>=3||Be>12||Be<-5||_e>60&&e.cgmFlatMinutes>89)return r.rate>ge?(ce.reason+=". Replacing high temp basal of "+r.rate+" with neutral temp of "+ge,ce.deliverAt=pe,ce.temp="absolute",ce.duration=30,ce.rate=ge,ce):0===r.rate&&r.duration>30?(ce.reason+=". Shortening "+r.duration+"m long zero temp to 30m. ",ce.deliverAt=pe,ce.temp="absolute",ce.duration=30,ce.rate=0,ce):(ce.reason+=". Temp "+r.rate+" <= current basal "+o(ge,2)+"U/hr; doing nothing. ",ce);var Fe,Ie,we,Te,Ce=x.max_iob;if(void 0!==x.min_bg&&(Ie=x.min_bg),void 0!==x.max_bg&&(we=x.max_bg),void 0!==x.enableSMB_high_bg_target&&(Te=x.enableSMB_high_bg_target),void 0===x.min_bg||void 0===x.max_bg)return ce.error="Error: could not determine target_bg. ",ce;Fe=(x.min_bg+x.max_bg)/2;var De="",Ge=x.exercise_mode||x.high_temptarget_raises_sensitivity,Oe=100,Re=160;if(x.half_basal_exercise_target&&(Re=x.half_basal_exercise_target),U.isEnabled&&U.hbt!=Re&&(Re=U.hbt),Ge&&x.temptargetSet&&Fe>Oe||x.low_temptarget_lowers_sensitivity&&x.temptargetSet&&Fe<Oe){var Ue=Re-Oe;sensitivityRatio=Ue*(Ue+Fe-Oe)<=0?x.autosens_max:Ue/(Ue+Fe-Oe),sensitivityRatio=Math.min(sensitivityRatio,x.autosens_max),sensitivityRatio=o(sensitivityRatio,2),De="from TT modifier",f+=", Ratio TT: "+sensitivityRatio,process.stderr.write("Sensitivity ratio set to "+sensitivityRatio+" based on temp target of "+Fe+"; ")}else void 0!==F&&F&&(sensitivityRatio=F.ratio,De="from Autosens",process.stderr.write("Autosens ratio: "+sensitivityRatio+"; "));if(sensitivityRatio&&(ge=x.current_basal*sensitivityRatio,(ge=t(ge,x))!==be?process.stderr.write("Adjusting basal from "+be+" to "+ge+"; "):process.stderr.write("Basal unchanged: "+ge+"; ")),x.temptargetSet);else if(void 0!==F&&F&&(x.sensitivity_raises_target&&F.ratio<1||x.resistance_lowers_target&&F.ratio>1)){Ie=o((Ie-60)/F.ratio)+60,we=o((we-60)/F.ratio)+60;var Ae=o((Fe-60)/F.ratio)+60;Fe===(Ae=Math.max(80,Ae))?process.stderr.write("target_bg unchanged: "+Ae+"; "):process.stderr.write("target_bg from "+Fe+" to "+Ae+"; "),Fe=Ae}var Pe=200,Ee=200,je=200;if(e.noise>=2){var ke=Math.max(1.1,x.noisyCGMTargetMultiplier);Math.min(250,x.maxRaw);Pe=o(Math.min(200,Ie*ke)),Ee=o(Math.min(200,Fe*ke)),je=o(Math.min(200,we*ke)),process.stderr.write("Raising target_bg for noisy / raw CGM data, from "+Fe+" to "+Ee+"; "),Ie=Pe,Fe=Ee,we=je}var qe=Ie-.5*(Ie-40),We=o(x.sens,1),ze=x.sens;void 0!==F&&F&&((ze=o(ze=x.sens/sensitivityRatio,1))!==We?process.stderr.write("ISF from "+n(We,x)+" to "+n(ze,x)):process.stderr.write("ISF unchanged: "+n(ze,x))),console.error("CR:"+x.carb_ratio),console.error("----------------------------------"),console.error(" start autoISF"),console.error("----------------------------------");var Ne=function(e,r){if(e.use_autoisf&&e.iob_threshold>0&&e.iob_threshold<r[0].iob)return s=", autoISF-SMB disabled:, IOB: "+o(r[0].iob,2)+", > threshold: "+e.iob_threshold+", maxIOB: "+e.max_iob,console.error(s),"iobTH";var a=n(e.min_bg,e);return e.use_autoisf&&e.temptargetSet&&e.enableSMB_EvenOn_OddOff||e.use_autoisf&&e.min_bg==e.max_bg&&e.enableSMB_EvenOn_OddOff_always?(e.temptargetSet?msgType="TempTarget ":msgType="profile target ","mmol/L"==e.out_units?(evenTarget=o(10*a,0)%2==0,msgUnits=" has ",msgTail=" decimal"):(evenTarget=a%2==0,msgUnits=" is ",msgTail=" number"),evenTarget?msgEven="even":msgEven="odd",evenTarget?(console.error("SMB enabled - "+msgType+a+msgUnits+msgEven+msgTail),e.temptargetSet&&a<100?(console.error("Full Loop enabled, SMB enforced"),s=", autoISF-SMB enabled:, even TT","enforced"):(s=", autoISF-SMB enabled:, even Target","enabled")):(console.error("SMB disabled - "+msgType+a+msgUnits+msgEven+msgTail),s=", autoISF-SMB disabled:, odd Target","blocked")):"oref"}(x,a),Le=!0;if(T&&"oref"!=Ne?("blocked"==Ne&&(Le=!1),console.error("loopSMB function overriden with autoISF target toggle, enableSMB = "+Le)):(Le=function(e,r,a,t,o,i){return r?!e.allowSMB_with_high_temptarget&&e.temptargetSet&&o>100?(console.error("SMB disabled due to high temptarget of "+o),!1):!0===a.bwFound&&!1===e.A52_risk_enable?(console.error("SMB disabled due to Bolus Wizard activity in the last 6 hours."),!1):!0===e.enableSMB_always?(a.bwFound?console.error("Warning: SMB enabled within 6h of using Bolus Wizard: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled due to enableSMB_always"),!0):!0===e.enableSMB_with_COB&&a.mealCOB?(a.bwCarbs?console.error("Warning: SMB enabled with Bolus Wizard carbs: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled for COB of",a.mealCOB),!0):!0===e.enableSMB_after_carbs&&a.carbs?(a.bwCarbs?console.error("Warning: SMB enabled with Bolus Wizard carbs: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled for 6h after carb entry"),!0):!0===e.enableSMB_with_temptarget&&e.temptargetSet&&o<100?(a.bwFound?console.error("Warning: SMB enabled within 6h of using Bolus Wizard: be sure to easy bolus 30s before using Bolus Wizard"):console.error("SMB enabled for temptarget of",n(o,e)),console.error("SMB enabled for temptargets with "+n(o,e)),!0):!0===e.enableSMB_high_bg&&null!==i&&t>=i?(console.error("Checking BG to see if High for SMB enablement."),console.error("Current BG",t," | High BG ",i),a.bwFound?console.error("Warning: High BG SMB enabled within 6h of using Bolus Wizard: be sure to easy bolus 30s before using Bolus Wizard"):console.error("High BG detected. Enabling SMB."),!0):(console.error("SMB disabled (no enableSMB preferences active or no condition satisfied)"),!1):(console.error("SMB disabled (!microBolusAllowed)"),!1)}(x,T,I,_e,Fe,Te),console.error("loopSMB function returns enableSMB = "+Le)),ze=function(e,r,a,t,f,x,F,I,w,T,C,D){if(!t.use_autoisf)return console.error("autoISF disabled in Preferences"),i+=", autoISF, disabled",e;if(t.autoISF_off_Sport&&(t.high_temptarget_raises_sensitivity||t.exercise_mode)&&t.temptargetSet&&a>D)return console.error("autoISF disabled due to exercise"),i+=", autoISF, disabled (exercise)",e;const G=f.dura_p,O=f.delta_pl,R=f.delta_pn,U=f.r_squ,A=f.bg_acceleration,P=f.a_0,E=f.a_1,j=f.a_2,k=f.dura_ISF_minutes,q=f.dura_ISF_average;var W=t.autoISF_min,z=t.autoISF_max,N=!1,L=e,X=a+10-q,Y=f.pp_debug;if("bg_acceleration: "+o(A,3)+", PF-minutes: "+G+", PF-corr: "+o(U,4)+", PF-nextDelta: "+n(R,t)+", PF-lastDelta: "+n(O,t)+", regular Delta: "+n(f.delta,t),console.error(Y),t.enable_BG_acceleration){var H=U;if(0!=j&&H>=.9){var Z=-E/2/j*5,$=o(P-Z*Z/25*j,1);(Z=o(Z,1))>0&&A<0?(p="predicts a Max of "+n($,t)+", in about "+Math.abs(Z)+"min",console.error("Parabolic fit "+p)):Z>0&&A>0?(p="predicts a Min of "+n($,t)+", in about "+Math.abs(Z)+"min",console.error("Parabolic fit "+p)):Z<0&&A<0?(p="saw Max of "+n($,t)+", about "+Math.abs(Z)+"min ago",console.error("Parabolic fit "+p)):Z<0&&A>0&&(p="saw Min of "+n($,t)+", about "+Math.abs(Z)+"min ago",console.error("Parabolic fit "+p))}if(H<.9)p="acce_ISF by-passed, as correlation, "+o(H,2)+", is too low",console.error("Parabolic fit "+p),m+=", Parabolic Fit, "+p;else{var J=10*(H-.9),K=1,Q=1;f.glucose<t.target_bg?A>0?(A>1&&(K=.5),Q=t.bgBrake_ISF_weight):A<0&&(Q=t.bgAccel_ISF_weight):A<0?Q=t.bgBrake_ISF_weight:A>0&&(Q=t.bgAccel_ISF_weight),(h=1+A*K*Q*J)<0&&(h=.1),console.error(m+"acce_ISF adaptation is "+o(h,2)),1!=h&&(N=!0,m+=", Parabolic Fit, "+p+", acce-ISF Ratio: "+o(h,2))}}else console.error("autoISF BG accelertion adaption disabled in Preferences");i+=s+m+", autoISF",v=1+S(100-X,t,"bg"),console.error("bg_ISF adaptation is "+o(v,2));var V=1,ee=1;if(v<1)return V=Math.min(v,h),h>1?(c="bg-ISF adaptation lifted to "+o(V=v*h,2)+", as BG accelerates already",console.error(c),i+=", bg-ISF Ratio: "+o(V,2)+"(accel.)"):i+=", bg-ISF Ratio: "+o(V,2)+"(minimal)",ee=y(V,W,z,w,r,t,C,a,D),L=Math.min(720,o(t.sens/ee,1)),i+=", bg-ISF Ratio: "+o(ee,2),L;v>1&&(N=!0,i+=", bg-ISF Ratio: "+o(v,2));var re=f.delta;t.enable_pp_ISF_always||t.pp_ISF_hours>=(F-x.lastCarbTime)/1e3/3600?deltaType="pp":deltaType="delta",X>0?console.error(deltaType+"_ISF adaptation by-passed as average glucose < "+a+"+10"):f.short_avgdelta<0?console.error(deltaType+"_ISF adaptation by-passed as no rise or too short lived"):"pp"==deltaType?(_=1+Math.max(0,re*t.pp_ISF_weight),console.error("pp_ISF adaptation is "+o(_,2)),u=", pp-ISF Ratio: "+o(_,2),1!=_&&(N=!0)):(B=S(re,t,"delta"),X>-20&&(B*=.5),B=1+B,console.error("delta_ISF adaptation is "+o(B,2)),d=", Œî-ISF Ratio: "+o(B,2),1!=B&&(N=!0));var ae=t.dura_ISF_weight;x.mealCOB>0&&!t.enableautoisf_with_COB?console.error("dura_ISF by-passed; preferences disabled mealCOB of "+o(x.mealCOB,1)):k<10?console.error("dura_ISF by-passed; BG is only "+k+"m at level "+q):q<=a?console.error("dura_ISF by-passed; avg. glucose "+q+" below target "+n(a,t)):(M+=k/60*(ae/a)*(q-a),N=!0,l=", Duration: "+k+", Avg: "+n(q,t)+", dura-ISF Ratio: "+o(M,2),console.error("dura_ISF adaptation is "+o(M,2)+" because ISF "+e+" did not do it for "+o(k,1)+"m"));return N?(V=Math.max(M,v,B,h,_),console.error("autoISF adaption ratios:"),console.error("  dura "+o(M,2)),console.error("  bg "+o(v,2)),console.error("  delta "+o(B,2)),console.error("  pp "+o(_,2)),console.error("  accel "+o(h,2)),h<1&&(c="strongest ISF factor "+o(V,2)+" weakened to "+o(V*h,2)+" as bg decelerates already",console.error(c),V*=h),ee=y(V,W,z,w,r,t,C,a,D),L=o(t.sens/ee,1),i+=u+d+l+", final Ratio: "+o(ee,2)+g+b+", final ISF: "+n(t.sens,t)+"‚Üí"+n(L,t),L):(i+=", not modified",console.error("autoISF does not modify"),L)}(ze,De,Fe,x,e,I,D,0,sensitivityRatio,0,Ge,Oe),console.error("----------------------------------"),console.error(" end autoISF"),console.error("----------------------------------"),void 0===a)return ce.error="Error: iob_data undefined. ",ce;var Xe,Ye=a;if(a.length,a.length>1&&(a=Ye[0]),void 0===a.activity||void 0===a.iob)return ce.error="Error: iob_data missing some property. ",ce;var He=((Xe=void 0!==a.lastTemp?o((new Date(fe).getTime()-a.lastTemp.date)/6e4):0)+r.duration)%30;if(console.error("currenttemp:"+r.rate+" lastTempAge:"+Xe+"m, tempModulus:"+He+"m"),ce.temp="absolute",ce.deliverAt=pe,T&&r&&a.lastTemp&&r.rate!==a.lastTemp.rate&&Xe>10&&r.duration)return ce.reason="Warning: currenttemp rate "+r.rate+" != lastTemp rate "+a.lastTemp.rate+" from pumphistory; canceling temp",w.setTempBasal(0,0,x,ce,r);if(r&&a.lastTemp&&r.duration>0){var Ze=Xe-a.lastTemp.duration;if(Ze>5&&Xe>10)return ce.reason="Warning: currenttemp running but lastTemp from pumphistory ended "+Ze+"m ago; canceling temp",w.setTempBasal(0,0,x,ce,r)}var $e=o(-a.activity*ze*5,2),Je=o(6*(Se-$e));Je<0&&(Je=o(6*(ye-$e)))<0&&(Je=o(6*(e.long_avgdelta-$e)));var Ke=_e,Qe=(Ke=a.iob>0?o(_e-a.iob*ze):o(_e-a.iob*Math.min(ze,x.sens)))+Je;if(void 0===Qe||isNaN(Qe))return ce.error="Error: could not calculate eventualBG. Sensitivity: "+ze+" Deviation: "+Je,ce;var Ve=function(e,r,a){return o(a+(e-r)/24,1)}(Fe,Qe,$e);ce={temp:"absolute",bg:n(_e,x),tick:he,eventualBG:Qe,insulinReq:0,reservoir:C,deliverAt:pe,sensitivityRatio,TDD:me,insulin:de};var er=[],rr=[],ar=[],tr=[];er.push(_e),rr.push(_e),tr.push(_e),ar.push(_e);var or=x.enableUAM,nr=0,ir=0;nr=o(Se-$e,1);var sr=o(Se-$e,1);csf=ze/x.carb_ratio,console.error("profile.sens:"+n(x.sens,x)+", sens:"+n(ze,x)+", CSF:"+o(csf,1));var lr=o(30*csf*5/60,1);nr>lr&&(console.error("Limiting carb impact from "+nr+" to "+lr+"mg/dL/5m (30g/h)"),nr=lr);var ur=3;sensitivityRatio&&(ur/=sensitivityRatio);var dr=ur;if(I.carbs){ur=Math.max(ur,I.mealCOB/20);var mr=o((new Date(fe).getTime()-I.lastCarbTime)/6e4),cr=(I.carbs-I.mealCOB)/I.carbs;dr=o(dr=ur+1.5*mr/60,1),console.error("Last carbs "+mr+" minutes ago; remainingCATime:"+dr+"hours; "+o(100*cr)+"% carbs absorbed")}var pr=Math.max(0,nr/5*60*dr/2)/csf,br=90,gr=1;x.remainingCarbsCap&&(br=Math.min(90,x.remainingCarbsCap)),x.remainingCarbsFraction&&(gr=Math.min(1,x.remainingCarbsFraction));var fr=1-gr,hr=Math.max(0,I.mealCOB-pr-I.carbs*fr),vr=(hr=Math.min(br,hr))*csf*5/60/(dr/2),Br=o(I.slopeFromMaxDeviation,2),_r=o(I.slopeFromMinDeviation,2),Mr=Math.min(Br,-_r/3),Sr=0;0===nr?ir=0:!0===x.floating_carbs?(ir=Math.min(60*dr/5/2,Math.max(0,I.carbs*csf/nr)),Sr=Math.min(60*dr/5/2,Math.max(0,I.mealCOB*csf/nr)),I.carbs>0&&(i+=", Floating Carbs:, CID: "+o(ir,1)+", MealCarbs: "+o(I.carbs,1)+", Not Floating:, CID: "+o(Sr,1)+", MealCOB: "+o(I.mealCOB,1),console.error("Floating Carbs CID: "+o(ir,1)+" / MealCarbs: "+o(I.carbs,1)+" vs. Not Floating:"+o(Sr,1)+" / MealCOB:"+o(I.mealCOB,1)))):ir=Math.min(60*dr/5/2,Math.max(0,I.mealCOB*csf/nr)),console.error("Carb Impact:"+nr+"mg/dL per 5m; CI Duration:"+o(5*ir/60*2,1)+"hours; remaining CI ("+o(dr/2,2)+"h peak):",o(vr,1)+"mg/dL per 5m");var yr,xr,Fr,Ir,wr,Tr=999,Cr=999,Dr=999,Gr=_e,Or=999,Rr=999,Ur=999,Ar=999,Pr=Qe,Er=_e,jr=_e,kr=0,qr=[],Wr=[];try{Ye.forEach((function(e){var r=o(-e.activity*ze*5,2),a=o(-e.iobWithZeroTemp.activity*ze*5,2),t=nr*(1-Math.min(1,rr.length/12));Pr=rr[rr.length-1]+r+t;var n=tr[tr.length-1]+a,i=Math.max(0,Math.max(0,nr)*(1-er.length/Math.max(2*ir,1))),s=Math.min(er.length,12*dr-er.length),l=Math.max(0,s/(dr/2*12)*vr);i+l,qr.push(o(l,0)),Wr.push(o(i,0)),COBpredBG=er[er.length-1]+r+Math.min(0,t)+i+l;var u=Math.max(0,sr+ar.length*Mr),d=Math.max(0,sr*(1-ar.length/Math.max(36,1))),m=Math.min(u,d);m>0&&(kr=o(5*(ar.length+1)/60,1)),UAMpredBG=ar[ar.length-1]+r+Math.min(0,t)+m,rr.length<48&&rr.push(Pr),er.length<48&&er.push(COBpredBG),ar.length<48&&ar.push(UAMpredBG),tr.length<48&&tr.push(n),COBpredBG<Or&&(Or=o(COBpredBG)),UAMpredBG<Rr&&(Rr=o(UAMpredBG)),Pr<Ur&&(Ur=o(Pr)),n<Ar&&(Ar=o(n));rr.length>18&&Pr<Tr&&(Tr=o(Pr)),Pr>Er&&(Er=Pr),(ir||vr>0)&&er.length>18&&COBpredBG<Cr&&(Cr=o(COBpredBG)),(ir||vr>0)&&COBpredBG>Er&&(jr=COBpredBG),or&&ar.length>12&&UAMpredBG<Dr&&(Dr=o(UAMpredBG)),or&&UAMpredBG>Er&&UAMpredBG}))}catch(e){console.error("Problem with iobArray.  Optional feature Advanced Meal Assist disabled")}ce.predBGs={},rr.forEach((function(e,r,a){a[r]=o(Math.min(401,Math.max(39,e)))}));for(var zr=rr.length-1;zr>12&&rr[zr-1]===rr[zr];zr--)rr.pop();for(ce.predBGs.IOB=rr,Fr=o(rr[rr.length-1]),tr.forEach((function(e,r,a){a[r]=o(Math.min(401,Math.max(39,e)))})),zr=tr.length-1;zr>6&&!(tr[zr-1]>=tr[zr]||tr[zr]<=Fe);zr--)tr.pop();if(ce.predBGs.ZT=tr,o(tr[tr.length-1]),I.mealCOB>0&&(nr>0||vr>0)){for(er.forEach((function(e,r,a){a[r]=o(Math.min(401,Math.max(39,e)))})),zr=er.length-1;zr>12&&er[zr-1]===er[zr];zr--)er.pop();ce.predBGs.COB=er,Ir=o(er[er.length-1]),Qe=Math.max(Qe,o(er[er.length-1]))}if(nr>0||vr>0){if(or){for(ar.forEach((function(e,r,a){a[r]=o(Math.min(401,Math.max(39,e)))})),zr=ar.length-1;zr>12&&ar[zr-1]===ar[zr];zr--)ar.pop();ce.predBGs.UAM=ar,wr=o(ar[ar.length-1]),ar[ar.length-1]&&(Qe=Math.max(Qe,o(ar[ar.length-1])))}ce.eventualBG=Qe}console.error("UAM Impact:"+sr+"mg/dL per 5m; UAM Duration:"+kr+"hours"),Tr=Math.max(39,Tr),Cr=Math.max(39,Cr),Dr=Math.max(39,Dr),yr=o(Tr);var Nr=I.mealCOB/I.carbs;xr=o(Dr<999&&Cr<999?(1-Nr)*UAMpredBG+Nr*COBpredBG:Cr<999?(Pr+COBpredBG)/2:Dr<999?(Pr+UAMpredBG)/2:Pr),Ar>xr&&(xr=Ar),Gr=o(Gr=ir||vr>0?or?Nr*Or+(1-Nr)*Rr:Or:or?Rr:Ur);var Lr=Dr;if(Ar<qe)Lr=(Dr+Ar)/2;else if(Ar<Fe){var Xr=(Ar-qe)/(Fe-qe);Lr=(Dr+(Dr*Xr+Ar*(1-Xr)))/2}else Ar>Dr&&(Lr=(Dr+Ar)/2);if(Lr=o(Lr),I.carbs)if(!or&&Cr<999)yr=o(Math.max(Tr,Cr));else if(Cr<999){var Yr=Nr*Cr+(1-Nr)*Lr;yr=o(Math.max(Tr,Cr,Yr))}else yr=or?Lr:Gr;else or&&(yr=o(Math.max(Tr,Lr)));yr=Math.min(yr,xr),process.stderr.write("minPredBG: "+n(yr,x)+" minIOBPredBG: "+n(Tr,x)+" minZTGuardBG: "+n(Ar,x)),Cr<999&&process.stderr.write(" minCOBPredBG: "+n(Cr,x)),Dr<999&&process.stderr.write(" minUAMPredBG: "+n(Dr,x)),console.error(" avgPredBG:"+n(xr,x)+" COB/Carbs:"+I.mealCOB+"/"+I.carbs),jr>_e&&(yr=Math.min(yr,jr)),ce.COB=I.mealCOB,ce.IOB=a.iob,ce.BGI=n($e,x),ce.deviation=n(Je,x),ce.dura_ISFratio=o(M,2),ce.bg_ISFratio=o(v,2),ce.delta_ISFratio=o(B,2),ce.pp_ISFratio=o(_,2),ce.acce_ISFratio=o(h,2),ce.auto_ISFratio=o(x.sens/ze,2),ce.ISF=n(ze,x),ce.CR=o(x.carb_ratio,2),ce.TDD=o(me,1),ce.TDDytd=o(H,1),ce.TDD7d=o(Z,1),ce.target_bg=n(Fe,x);var Hr=function(e,r,a,t){if(!e.use_autoisf)return console.error("autoISF disabled, don't adjust SMB Delivery Ratio"),.5;var n=e.smb_delivery_ratio_bg_range;n<10&&(n/=.0555);var i=e.smb_delivery_ratio,s=Math.min(e.smb_delivery_ratio_min,e.smb_delivery_ratio_max),l=Math.max(e.smb_delivery_ratio_min,e.smb_delivery_ratio_max),u=a+e.smb_delivery_ratio_bg_range,d=i;return n>0&&(d=s+(l-s)*(r-a)/n,d=Math.max(s,Math.min(l,d))),"enforced"==t?(console.error("SMB delivery ratio set to "+o(Math.max(i,d),2)+" as max of fixed and interpolated values"),Math.max(i,d)):0==n?(console.error("SMB delivery ratio set to fixed value "+o(i,2)),i):r<=a?(console.error("SMB delivery ratio limited by minimum value "+o(s,2)),s):r>=u?(console.error("SMB delivery ratio limited by maximum value "+o(l,2)),l):(console.error("SMB delivery ratio set to interpolated value "+o(d,2)),d)}(x,_e,Fe,Ne);ce.SMBratio=o(Hr,2);var Zr="SMB Del.Ratio:, "+o(Hr,2);ce.reason=Zr+f+i+", Standard, COB: "+ce.COB+", Dev: "+ce.deviation+", BGI: "+ce.BGI+", ISF: "+ce.ISF+", CR: "+ce.CR+", Target: "+ce.target_bg+", minPredBG "+n(yr,x)+", minGuardBG "+n(Gr,x)+", IOBpredBG "+n(Fr,x),Ir>0&&(ce.reason+=", COBpredBG "+n(Ir,x)),wr>0&&(ce.reason+=", UAMpredBG "+n(wr,x)),ce.reason+=tddReason,ce.reason+="; ";var $r=Ke;$r<40&&($r=Math.min(Gr,$r));var Jr=qe-$r,Kr=240,Qr=240;if(I.mealCOB>0&&(nr>0||vr>0)){for(zr=0;zr<er.length;zr++)if(er[zr]<Ie){Kr=5*zr;break}for(zr=0;zr<er.length;zr++)if(er[zr]<qe){Qr=5*zr;break}}else{for(zr=0;zr<rr.length;zr++)if(rr[zr]<Ie){Kr=5*zr;break}for(zr=0;zr<rr.length;zr++)if(rr[zr]<qe){Qr=5*zr;break}}Le&&Gr<qe&&(console.error("minGuardBG "+n(Gr,x)+" projected below "+n(qe,x)+" - disabling SMB"),Le=!1);var Vr=.2;void 0!==x.maxDelta_bg_threshold&&(Vr=Math.min(x.maxDelta_bg_threshold,.4),console.error("maxDelta threshold for BG-Jump to allow SMB's set to: "+100*Vr+"%")),xe>Vr*_e&&(console.error("maxDelta "+n(xe,x)+" > "+100*Vr+"% of BG "+n(_e,x)+" - disabling SMB"),ce.reason+="maxDelta "+n(xe,x)+" > "+100*Vr+"% of BG "+n(_e,x)+" - SMB disabled!, ",Le=!1),console.error("BG projected to remain above "+n(Ie,x)+" for "+Kr+"minutes"),(Qr<240||Kr<60)&&console.error("BG projected to remain above "+n(qe,x)+" for "+Qr+"minutes");var ea=Qr,ra=x.current_basal*ze*ea/60,aa=Math.max(0,I.mealCOB-.25*I.carbs),ta=(Jr-ra)/csf-aa;ra=o(ra),ta=o(ta),console.error("naive_eventualBG: "+n(Ke,x)+", bgUndershoot: "+n(Jr,x)+", zeroTempDuration: "+ea+", zeroTempEffect: "+ra+", carbsReq: "+ta),"Could not parse clock data"==I.reason?console.error("carbsReq unknown: Could not parse clock data"):ta>=x.carbsReqThreshold&&Qr<=45&&(ce.carbsReq=ta,ce.reason+=ta+" add'l carbs req w/in "+Qr+"m; ");var oa=0;if(_e<qe&&a.iob<20*-x.current_basal/60&&Se>0&&Se>Ve)ce.reason+="IOB "+a.iob+" < "+o(20*-x.current_basal/60,2),ce.reason+=" and minDelta "+n(Se,x)+" > expectedDelta "+n(Ve,x)+"; ";else if(_e<qe||Gr<qe)return ce.reason+="minGuardBG "+n(Gr,x)+"<"+n(qe,x),oa=o(60*((Jr=Fe-Gr)/ze)/x.current_basal),oa=30*o(oa/30),oa=Math.min(120,Math.max(30,oa)),w.setTempBasal(0,oa,x,ce,r);if(x.skip_neutral_temps&&ce.deliverAt.getMinutes()>=55)return ce.reason+="; Canceling temp at "+ce.deliverAt.getMinutes()+"m past the hour. ",w.setTempBasal(0,0,x,ce,r);var na=0,ia=ge;if(Qe<Ie){if(ce.reason+="Eventual BG "+n(Qe,x)+" < "+n(Ie,x),Se>Ve&&Se>0&&!ta)return Ke<40?(ce.reason+=", naive_eventualBG < 40. ",w.setTempBasal(0,30,x,ce,r)):(e.delta>Se?ce.reason+=", but Delta "+n(he,x)+" > expectedDelta "+n(Ve,x):ce.reason+=", but Min. Delta "+Se.toFixed(2)+" > Exp. Delta "+n(Ve,x),r.duration>15&&t(ge,x)===t(r.rate,x)?(ce.reason+=", temp "+r.rate+" ~ req "+ge+"U/hr. ",ce):(ce.reason+="; setting current basal of "+ge+" as temp. ",w.setTempBasal(ge,30,x,ce,r)));na=o(na=2*Math.min(0,(Qe-Fe)/ze),2);var sa=Math.min(0,(Ke-Fe)/ze);if(sa=o(sa,2),Se<0&&Se>Ve)na=o(na*(Se/Ve),2);if(ia=t(ia=ge+2*na,x),r.duration*(r.rate-ge)/60<Math.min(na,sa)-.3*ge)return ce.reason+=", "+r.duration+"m@"+r.rate.toFixed(2)+" is a lot less than needed. ",w.setTempBasal(ia,30,x,ce,r);if(void 0!==r.rate&&r.duration>5&&ia>=.8*r.rate)return ce.reason+=", temp "+r.rate+" ~< req "+ia+"U/hr. ",ce;if(ia<=0){if((oa=o(60*((Jr=Fe-Ke)/ze)/x.current_basal))<0?oa=0:(oa=30*o(oa/30),oa=Math.min(120,Math.max(0,oa))),oa>0)return ce.reason+=", setting "+oa+"m zero temp. ",w.setTempBasal(ia,oa,x,ce,r)}else ce.reason+=", setting "+ia+"U/hr. ";return w.setTempBasal(ia,30,x,ce,r)}if(Se<Ve&&(!T||!Le))return e.delta<Se?ce.reason+="Eventual BG "+n(Qe,x)+" > "+n(Ie,x)+" but Delta "+n(he,x)+" < Exp. Delta "+n(Ve,x):ce.reason+="Eventual BG "+n(Qe,x)+" > "+n(Ie,x)+" but Min. Delta "+Se.toFixed(2)+" < Exp. Delta "+n(Ve,x),r.duration>15&&t(ge,x)===t(r.rate,x)?(ce.reason+=", temp "+r.rate+" ~ req "+ge+"U/hr. ",ce):(ce.reason+="; setting current basal of "+ge+" as temp. ",w.setTempBasal(ge,30,x,ce,r));if(Math.min(Qe,yr)<we&&(!T||!Le))return ce.reason+=n(Qe,x)+"-"+n(yr,x)+" in range: no temp required",r.duration>15&&t(ge,x)===t(r.rate,x)?(ce.reason+=", temp "+r.rate+" ~ req "+ge+"U/hr. ",ce):(ce.reason+="; setting current basal of "+ge+" as temp. ",w.setTempBasal(ge,30,x,ce,r));if(Qe>=we&&(ce.reason+="Eventual BG "+n(Qe,x)+" >= "+n(we,x)+", "),a.iob>Ce)return ce.reason+="IOB "+o(a.iob,2)+" > max_iob "+Ce,r.duration>15&&t(ge,x)===t(r.rate,x)?(ce.reason+=", temp "+r.rate+" ~ req "+ge+"U/hr. ",ce):(ce.reason+="; setting current basal of "+ge+" as temp. ",w.setTempBasal(ge,30,x,ce,r));(na=o((Math.min(yr,Qe)-Fe)/ze,2))>Ce-a.iob&&(ce.reason+="max_iob "+Ce+", ",console.error("InsReq",o(na,2),"capped at "+o(Ce-a.iob,2)+" to not exceed max_iob"),na=Ce-a.iob),ia=t(ia=ge+2*na,x),na=o(na,3),ce.insulinReq=na;var la=o((new Date(fe).getTime()-a.lastBolusTime)/6e4,1);if(T&&Le&&_e>qe){var ua=o(I.mealCOB/x.carb_ratio,3);if(x.use_autoisf)da=x.smb_max_range_extension;else{console.error("autoISF disabled, SMB range extension disabled");var da=1}da>1&&console.error("SMB max range extended from default by factor "+da);var ma=0;void 0===x.maxSMBBasalMinutes?(ma=o(da*x.current_basal*30/60,1),console.error("profile.maxSMBBasalMinutes undefined: defaulting to 30m")):a.iob>ua&&a.iob>0?(console.error("IOB",a.iob,"> COB",I.mealCOB+"; mealInsulinReq =",ua),x.maxUAMSMBBasalMinutes?(console.error("profile.maxUAMSMBBasalMinutes:",x.maxUAMSMBBasalMinutes,"profile.current_basal:",x.current_basal),ma=o(da*x.current_basal*x.maxUAMSMBBasalMinutes/60,1)):(console.error("profile.maxUAMSMBBasalMinutes undefined: defaulting to 30m"),ma=o(30*x.current_basal/60,1))):(console.error("profile.maxSMBBasalMinutes:",x.maxSMBBasalMinutes,"profile.current_basal:",x.current_basal),ma=o(da*x.current_basal*x.maxSMBBasalMinutes/60,1));var ca=x.bolus_increment,pa=1/ca;x.use_autoisf||(console.error("autoISF disabled, don't adjust SMB Delivery Ratio"),Hr=.5),Hr>.5&&console.error("SMB Delivery Ratio increased from default 0.5 to "+o(Hr,2));var ba=Math.min(na*Hr,ma);ba=Math.floor(ba*pa)/pa,oa=o(60*((Fe-(Ke+Tr)/2)/ze)/x.current_basal),na>0&&ba<ca&&(oa=0);var ga=0;oa<=0?oa=0:oa>=30?(oa=30*o(oa/30),oa=Math.min(60,Math.max(0,oa))):(ga=o(ge*oa/30,2),oa=30),ce.reason+=" insulinReq "+na,ba>=ma&&(ce.reason+="; maxBolus "+ma),oa>0&&(ce.reason+="; setting "+oa+"m low temp of "+ga+"U/h"),ce.reason+=". ";var fa=3;x.SMBInterval&&(fa=Math.min(10,Math.max(1,x.SMBInterval)));var ha=o(fa-la,0),va=o(60*(fa-la),0)%60;if(console.error("naive_eventualBG "+n(Ke,x)+", "+oa+"m "+ga+"U/h temp needed; last bolus "+la+"m ago; maxBolus: "+ma),la>fa?ba>0&&(ce.units=ba,ce.reason+="Microbolusing "+ba+"U. "):ce.reason+="Waiting "+ha+"m "+va+"s to microbolus again. ",oa>0)return ce.rate=ga,ce.duration=oa,ce}var Ba=w.getMaxSafeBasal(x);return ia>Ba&&(ce.reason+="adj. req. rate: "+o(ia,2)+" to maxSafeBasal: "+o(Ba,2)+", ",ia=t(Ba,x)),r.duration*(r.rate-ge)/60>=2*na?(ce.reason+=r.duration+"m@"+r.rate.toFixed(2)+" > 2 * insulinReq. Setting temp basal of "+ia+"U/hr. ",w.setTempBasal(ia,30,x,ce,r)):void 0===r.duration||0===r.duration?(ce.reason+="no temp, setting "+ia+"U/hr. ",w.setTempBasal(ia,30,x,ce,r)):r.duration>5&&t(ia,x)<=t(r.rate,x)?(ce.reason+="temp "+r.rate+" >~ req "+ia+"U/hr. ",ce):(ce.reason+="temp "+r.rate+"<"+ia+"U/hr. ",w.setTempBasal(ia,30,x,ce,r))}},6880:(e,r,a)=>{var t=a(6654);e.exports=function(e,r){var a=20;void 0!==r&&"string"==typeof r.model&&(t(r.model,"54")||t(r.model,"23"))&&(a=40);return e<1?Math.round(e*a)/a:e<10?Math.round(20*e)/20:Math.round(10*e)/10}},2705:(e,r,a)=>{var t=a(5639).Symbol;e.exports=t},9932:e=>{e.exports=function(e,r){for(var a=-1,t=null==e?0:e.length,o=Array(t);++a<t;)o[a]=r(e[a],a,e);return o}},9750:e=>{e.exports=function(e,r,a){return e==e&&(void 0!==a&&(e=e<=a?e:a),void 0!==r&&(e=e>=r?e:r)),e}},4239:(e,r,a)=>{var t=a(2705),o=a(9607),n=a(2333),i=t?t.toStringTag:void 0;e.exports=function(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":i&&i in Object(e)?o(e):n(e)}},531:(e,r,a)=>{var t=a(2705),o=a(9932),n=a(1469),i=a(3448),s=t?t.prototype:void 0,l=s?s.toString:void 0;e.exports=function e(r){if("string"==typeof r)return r;if(n(r))return o(r,e)+"";if(i(r))return l?l.call(r):"";var a=r+"";return"0"==a&&1/r==-Infinity?"-0":a}},7561:(e,r,a)=>{var t=a(7990),o=/^\s+/;e.exports=function(e){return e?e.slice(0,t(e)+1).replace(o,""):e}},1957:(e,r,a)=>{var t="object"==typeof a.g&&a.g&&a.g.Object===Object&&a.g;e.exports=t},9607:(e,r,a)=>{var t=a(2705),o=Object.prototype,n=o.hasOwnProperty,i=o.toString,s=t?t.toStringTag:void 0;e.exports=function(e){var r=n.call(e,s),a=e[s];try{e[s]=void 0;var t=!0}catch(e){}var o=i.call(e);return t&&(r?e[s]=a:delete e[s]),o}},2333:e=>{var r=Object.prototype.toString;e.exports=function(e){return r.call(e)}},5639:(e,r,a)=>{var t=a(1957),o="object"==typeof self&&self&&self.Object===Object&&self,n=t||o||Function("return this")();e.exports=n},7990:e=>{var r=/\s/;e.exports=function(e){for(var a=e.length;a--&&r.test(e.charAt(a)););return a}},6654:(e,r,a)=>{var t=a(9750),o=a(531),n=a(554),i=a(9833);e.exports=function(e,r,a){e=i(e),r=o(r);var s=e.length,l=a=void 0===a?s:t(n(a),0,s);return(a-=r.length)>=0&&e.slice(a,l)==r}},1469:e=>{var r=Array.isArray;e.exports=r},3218:e=>{e.exports=function(e){var r=typeof e;return null!=e&&("object"==r||"function"==r)}},7005:e=>{e.exports=function(e){return null!=e&&"object"==typeof e}},3448:(e,r,a)=>{var t=a(4239),o=a(7005);e.exports=function(e){return"symbol"==typeof e||o(e)&&"[object Symbol]"==t(e)}},8601:(e,r,a)=>{var t=a(4841),o=1/0;e.exports=function(e){return e?(e=t(e))===o||e===-1/0?17976931348623157e292*(e<0?-1:1):e==e?e:0:0===e?e:0}},554:(e,r,a)=>{var t=a(8601);e.exports=function(e){var r=t(e),a=r%1;return r==r?a?r-a:r:0}},4841:(e,r,a)=>{var t=a(7561),o=a(3218),n=a(3448),i=/^[-+]0x[0-9a-f]+$/i,s=/^0b[01]+$/i,l=/^0o[0-7]+$/i,u=parseInt;e.exports=function(e){if("number"==typeof e)return e;if(n(e))return NaN;if(o(e)){var r="function"==typeof e.valueOf?e.valueOf():e;e=o(r)?r+"":r}if("string"!=typeof e)return 0===e?e:+e;e=t(e);var a=s.test(e);return a||l.test(e)?u(e.slice(2),a?2:8):i.test(e)?NaN:+e}},9833:(e,r,a)=>{var t=a(531);e.exports=function(e){return null==e?"":t(e)}}},r={};function a(t){var o=r[t];if(void 0!==o)return o.exports;var n=r[t]={exports:{}};return e[t](n,n.exports,a),n.exports}a.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}();var t=a(5546);freeaps_determineBasal=t})();